<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsFlow - Plataforma de Estudos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#4338ca' } } }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; }
        .nav-link.active { color: #4338ca; position: relative; }
        .nav-link.active::after { content: ''; position: absolute; width: 100%; height: 2px; bottom: -4px; left: 0; background-color: #4338ca; }
        html.dark .nav-link.active { color: #818cf8; }
        html.dark .nav-link.active::after { background-color: #818cf8; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .option-item.selected { border-color: #4f46e5; background-color: #eef2ff; }
        .option-item.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .option-item.wrong { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .option-item.strikethrough { opacity: 0.6; background-color: #f3f4f6; }
        .option-item.strikethrough .option-text { text-decoration: line-through; color: #9ca3af; }
        html.dark .option-item.strikethrough { background-color: #1f2937; }
        html.dark .option-item.selected { border-color: #818cf8; background-color: rgba(79, 70, 229, 0.2); }
        html.dark .option-item.correct { background-color: rgba(34, 197, 94, 0.2) !important; border-color: #22c55e !important; }
        html.dark .option-item.wrong { background-color: rgba(239, 68, 68, 0.2) !important; border-color: #ef4444 !important; }

        #search-results { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- HEADER -->
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50 border-b dark:border-gray-700">
        <nav class="container mx-auto px-4 h-16 flex items-center justify-between">
            <a href="#" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400" onclick="window.app.navigateTo('inicio')">InsFlow</a>
            
            <div class="hidden md:flex items-center space-x-8">
                <a href="#" class="nav-link hover:text-indigo-600 dark:hover:text-indigo-400 transition" data-target="inicio">Início</a>
                <a href="#" class="nav-link hover:text-indigo-600 dark:hover:text-indigo-400 transition" data-target="materias">Matérias</a>
                <a href="#" class="nav-link hover:text-indigo-600 dark:hover:text-indigo-400 transition" data-target="questoes">Questões</a>
                <a href="#" class="nav-link hover:text-indigo-600 dark:hover:text-indigo-400 transition" data-target="redacao">Redação</a>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-600 dark:text-gray-300" onclick="window.app.toggleTheme()" title="Alternar Tema">
                    <i data-lucide="moon" class="block dark:hidden w-5 h-5"></i>
                    <i data-lucide="sun" class="hidden dark:block w-5 h-5"></i>
                </button>
            </div>

            <div class="flex items-center md:hidden gap-4">
                <button id="theme-toggle-mobile" class="text-gray-600 dark:text-gray-300" onclick="window.app.toggleTheme()">
                    <i data-lucide="moon" class="block dark:hidden w-5 h-5"></i>
                    <i data-lucide="sun" class="hidden dark:block w-5 h-5"></i>
                </button>
                <button id="mobile-menu-btn" class="text-gray-600 dark:text-gray-300"><i data-lucide="menu"></i></button>
            </div>
        </nav>
        
        <div id="mobile-menu" class="hidden md:hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-4 space-y-2 shadow-lg">
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-800 dark:text-gray-200" onclick="window.app.navigateTo('inicio')">Início</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="window.app.navigateTo('materias')">Matérias</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-800 dark:text-gray-200" onclick="window.app.navigateTo('questoes')">Questões</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="window.app.navigateTo('redacao')">Redação</a>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto px-4 py-8 md:py-12">
        <section id="inicio" class="content-section active">
            <div class="text-center py-16 md:py-24 bg-gradient-to-b from-indigo-50 to-white dark:from-gray-800 dark:to-gray-900 rounded-2xl shadow-sm border border-indigo-100 dark:border-gray-700 transition-colors duration-300">
                <h1 class="text-4xl md:text-6xl font-bold text-indigo-600 dark:text-indigo-400 mb-6">Bem-vindo ao InsFlow</h1>
                <p class="text-lg md:text-xl text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">Sua plataforma inteligente de estudos.</p>
                <div class="flex justify-center gap-4">
                    <button class="bg-indigo-600 text-white py-3 px-8 rounded-lg shadow hover:bg-indigo-700 font-semibold transition" onclick="window.app.navigateTo('materias')">Explorar Matérias</button>
                    <button class="bg-white dark:bg-gray-700 text-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 py-3 px-8 rounded-lg shadow hover:bg-gray-50 dark:hover:bg-gray-600 font-semibold transition" onclick="window.app.navigateTo('questoes')">Praticar Questões</button>
                </div>
            </div>
        </section>

        <!-- 2. MATÉRIAS (COM BARRA DE PESQUISA) -->
        <section id="materias" class="content-section">
            <div id="materias-home">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Matérias</h2>
                    
                    <!-- Barra de Pesquisa na Aba Matérias -->
                    <div class="relative w-full md:w-72">
                        <input type="text" id="search-materias" oninput="window.app.filterSubjects(this.value)" class="w-full p-3 pl-10 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none transition bg-white dark:bg-gray-800 dark:text-white dark:placeholder-gray-400 text-sm" placeholder="Filtrar matéria...">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 w-4 h-4"></i>
                    </div>
                </div>

                <div id="materias-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
            </div>
            <div id="materia-detalhe" class="hidden"></div>
        </section>

        <!-- 3. QUESTÕES -->
        <section id="questoes" class="content-section">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-4 text-center text-gray-800 dark:text-white">Gerador de Questões</h2>
                
                <div class="mb-4 flex justify-end">
                    <span id="cloud-status" class="text-xs font-mono bg-gray-200 px-2 py-1 rounded text-gray-600" title="Status da conexão com Firebase Storage">Inicializando...</span>
                </div>

                <!-- BARRA DE PESQUISA INTELIGENTE -->
                <div class="mb-6 relative z-20">
                    <div class="relative">
                        <input type="text" id="search-topic" autocomplete="off" class="w-full p-4 pl-12 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none transition bg-white dark:bg-gray-800 dark:text-white dark:placeholder-gray-400" placeholder="Pesquise um tópico do banco de dados (ex: Logaritmos)...">
                        <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 w-5 h-5"></i>
                        <button id="clear-search" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hidden">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="search-results" class="absolute w-full bg-white dark:bg-gray-800 mt-2 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 hidden overflow-hidden"></div>
                </div>

                <!-- FILTROS -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 mb-8 relative z-10 transition-colors duration-300">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Disciplina</label>
                            <select id="filtro-disciplina" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-gray-700 dark:text-white"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Conteúdo</label>
                            <select id="filtro-conteudo" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-gray-700 dark:text-white disabled:opacity-50" disabled>
                                <option value="">Selecione a Disciplina</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sub-conteúdo</label>
                            <select id="filtro-subconteudo" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-gray-700 dark:text-white disabled:opacity-50" disabled>
                                <option value="">Selecione o Conteúdo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Dificuldade</label>
                            <select id="filtro-dificuldade" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-gray-700 dark:text-white font-medium">
                                <option value="medio" selected>Médio (Padrão ENEM)</option>
                                <option value="facil">Fácil (Conceitual)</option>
                                <option value="dificil">Difícil (Desafiador)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="btn-gerar-questoes" class="flex-1 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed shadow-md flex items-center justify-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> Gerar 5 Novas Questões
                        </button>
                        <button onclick="window.app.clearQuestions()" class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold py-3 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition border border-gray-200 dark:border-gray-600" title="Limpar lista">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div id="questoes-list" class="space-y-6 pb-12">
                    <div id="questoes-placeholder" class="text-center text-gray-500 dark:text-gray-400 py-12 bg-white dark:bg-gray-800 rounded-xl border border-dashed border-gray-300 dark:border-gray-600 transition-colors duration-300">
                        <i data-lucide="book-open" class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500 mb-3"></i>
                        <p>Selecione uma disciplina para começar.</p>
                    </div>
                </div>
                
                <div id="loading-indicator" class="hidden text-center py-8">
                    <div class="inline-block animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-4"></div>
                    <p class="text-gray-500 dark:text-gray-400 animate-pulse" id="loading-text">Criando questões inéditas...</p>
                </div>
            </div>
        </section>

        <!-- 4. REDAÇÃO -->
        <section id="redacao" class="content-section">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Assistente de Redação</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 transition-colors duration-300">
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 font-bold mb-2">Tema da Redação</label>
                        <div class="flex gap-2">
                            <input type="text" id="redacao-theme" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-gray-700 dark:text-white" placeholder="Ex: Desafios da educação digital no Brasil">
                            <button onclick="window.app.handleRedacao('tema')" class="bg-gray-100 dark:bg-gray-600 p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500 border border-gray-300 dark:border-gray-500 transition"><i data-lucide="shuffle" class="text-gray-600 dark:text-gray-200"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <button onclick="window.app.handleRedacao('repertorio')" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-medium transition flex items-center justify-center gap-2"><i data-lucide="library"></i> Gerar Repertório</button>
                        <button onclick="window.app.handleRedacao('esboco')" class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 font-medium transition flex items-center justify-center gap-2"><i data-lucide="list"></i> Criar Esboço</button>
                    </div>
                    <div class="border-t dark:border-gray-700 pt-4">
                        <label class="block text-gray-700 dark:text-gray-300 font-bold mb-2">Analisar Parágrafo</label>
                        <textarea id="redacao-paragraph" rows="4" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 mb-2 bg-white dark:bg-gray-700 dark:text-white" placeholder="Cole o seu parágrafo aqui..."></textarea>
                        <button onclick="window.app.handleRedacao('analise')" class="w-full bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 font-medium transition">Analisar e Melhorar</button>
                    </div>
                    <div id="redacao-output" class="mt-6 p-6 bg-gray-50 dark:bg-gray-700 rounded-lg min-h-[100px] text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-gray-600 hidden"></div>
                </div>
            </div>
        </section>
    </main>
    
    <script type="module">
        let API_KEY = localStorage.getItem('insflow_openai_key') || ""; 
        
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCdXO82z5x01QtD5G4gxoL1qosa8e0QIp4",
            authDomain: "genius---plataforma-de-estudos.firebaseapp.com",
            projectId: "genius---plataforma-de-estudos",
            storageBucket: "genius---plataforma-de-estudos.firebasestorage.app",
            messagingSenderId: "410977832662",
            appId: "1:410977832662:web:3c98e18c232f33bf4a8377"
        };

        const app = {
            CACHE_PREFIX: 'insflow-full-',
            storage: null,
            activeCloudText: "",
            activeProofName: "",
            cloudFilesList: [],
            firebaseUtils: null,
            
            // --- BASE DE DADOS COMPLETA E DETALHADA ---
            db: {
                materias: [
                    // 1. MATEMÁTICA (Expandida)
                    {
                        id: 'matematica', nome: 'Matemática', icone: 'calculator', cor: 'bg-red-50 text-red-700 border-red-200 dark:bg-red-900/20 dark:text-red-300 dark:border-red-800',
                        frentes: [
                            { nome: 'Matemática Básica', modulos: [{ nome: 'Módulo 1: Fundamentos', assuntos: [{id: 'operacoes-numericas', nome: 'Operações Numéricas', subconteudos: [{id: 'basicas', nome: '4 Operações Básicas'}, {id: 'pot-rad', nome: 'Potenciação e Radiciação'}, {id: 'fracoes', nome: 'Frações e Decimais'}]}, {id: 'razoes-proporcoes', nome: 'Razões e Proporções', subconteudos: [{id: 'razao-prop', nome: 'Razão e Proporção'}, {id: 'escalas', nome: 'Escalas e Grandezas'}]}, {id: 'regra-de-tres', nome: 'Regra de Três', subconteudos: [{id: 'regra-tres-simples', nome: 'Simples'}, {id: 'regra-tres-composta', nome: 'Composta'}]}, {id: 'porcentagem', nome: 'Porcentagem', subconteudos: [{id: 'calc-porcentagem', nome: 'Cálculos Básicos de Porcentagem'}, {id: 'acresc-descontos', nome: 'Acréscimos e Descontos'}]}]}] },
                            { nome: 'Álgebra', modulos: [
                                { nome: 'Módulo 2: Funções', assuntos: [
                                    {id: 'funcao-afim', nome: 'Função Afim'}, 
                                    {id: 'funcao-quadratica', nome: 'Função Quadrática', subconteudos: [{id: 'graf-parabola', nome: 'Gráfico (Parábola)'}, {id: 'vertice-max-min', nome: 'Vértice (Máximos e Mínimos)'}]}, 
                                    {id: 'funcao-exponencial', nome: 'Função Exponencial', subconteudos: [{id: 'eq-exp', nome: 'Equações Exponenciais'}]}, 
                                    {id: 'funcao-logaritmica', nome: 'Função Logarítmica'}
                                ]},
                                { nome: 'Módulo 3: Equações e Matrizes', assuntos: [
                                    {id: 'polinomios', nome: 'Polinômios'}, 
                                    {id: 'sistemas', nome: 'Sistemas Lineares'}, 
                                    {id: 'complexos', nome: 'Números Complexos'}, 
                                    {id: 'matrizes', nome: 'Matrizes e Operações'}, 
                                    {id: 'determinantes', nome: 'Determinantes'}
                                ]}
                            ]},
                            { nome: 'Geometria', modulos: [
                                { nome: 'Módulo 4: Plana', assuntos: [
                                    {id: 'triangulos', nome: 'Triângulos', subconteudos: [{id: 'semelhanca', nome: 'Semelhança'}, {id: 'relacoes', nome: 'Relações Métricas'}]}, 
                                    {id: 'poligonos', nome: 'Polígonos'}, 
                                    {id: 'circulos', nome: 'Círculos e Circunferência'}, 
                                    {id: 'areas', nome: 'Áreas de Figuras Planas'}
                                ]}, 
                                { nome: 'Módulo 5: Espacial', assuntos: [
                                    {id: 'poliedros', nome: 'Poliedros', subconteudos: [{id: 'relacao-euler', nome: 'Relação de Euler'}, {id: 'poliedros-platao', nome: 'Poliedros de Platão'}]}, 
                                    {id: 'prismas', nome: 'Prismas e Pirâmides'}, 
                                    {id: 'cilindros', nome: 'Cilindros e Cones'}, 
                                    {id: 'esferas', nome: 'Esferas'}, 
                                    {id: 'solidos-complexos', nome: 'Sólidos Complexos'}
                                ]}, 
                                { nome: 'Módulo 6: Analítica', assuntos: [
                                    {id: 'ponto-reta', nome: 'Ponto e Reta'}, 
                                    {id: 'conicas', nome: 'Cônicas', subconteudos: [{id: 'elipse', nome: 'Elipse'}, {id: 'hiperbole', nome: 'Hipérbole'}, {id: 'parabola', nome: 'Parábola'}]}
                                ]}
                            ]},
                            { nome: 'Estatística', modulos: [
                                { nome: 'Módulo 7: Dados e Finanças', assuntos: [
                                    {id: 'combinatoria', nome: 'Análise Combinatória'}, 
                                    {id: 'probabilidade', nome: 'Probabilidade e Aplicações'}, 
                                    {id: 'estatistica', nome: 'Estatística Descritiva', subconteudos: [{id: 'central', nome: 'Medidas de Tendência Central (Média, Moda)'}, {id: 'dispersao', nome: 'Medidas de Dispersão (Variância/Desvio)'}]}, 
                                    {id: 'juros', nome: 'Matemática Financeira', subconteudos: [{id: 'juros-simples', nome: 'Juros Simples'}, {id: 'juros-compostos', nome: 'Juros Compostos'}]}
                                ]}
                            ]}
                        ]
                    },
                    // 2. FÍSICA (Expandida)
                    {
                        id: 'fisica', nome: 'Física', icone: 'atom', cor: 'bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/20 dark:text-blue-300 dark:border-blue-800',
                        frentes: [
                            { nome: 'Mecânica', modulos: [
                                { nome: 'Módulo 1: Cinemática', assuntos: [
                                    {id: 'mru', nome: 'MRU e MRUV', subconteudos: [{id: 'mru-conceito', nome: 'Conceito de MRU'}, {id: 'mruv-conceito', nome: 'Conceito de MRUV'}]}, 
                                    {id: 'vetores', nome: 'Vetores'}, 
                                    {id: 'mcu', nome: 'Movimento Circular'}
                                ]}, 
                                { nome: 'Módulo 2: Dinâmica', assuntos: [
                                    {id: 'leis-newton', nome: 'Leis de Newton', subconteudos: [{id: '1a-lei', nome: 'Inércia'}, {id: '2a-lei', nome: 'Princípio Fundamental'}, {id: '3a-lei', nome: 'Ação e Reação'}]}, 
                                    {id: 'trabalho', nome: 'Trabalho e Energia'}, 
                                    {id: 'impulso', nome: 'Impulso e Quantidade de Movimento'}
                                ]}, 
                                { nome: 'Módulo 3: Estática', assuntos: [
                                    {id: 'estatica', nome: 'Estática (Equilíbrio)'}, 
                                    {id: 'hidrostatica', nome: 'Hidrostática', subconteudos: [{id: 'pascal', nome: 'Princípio de Pascal'}, {id: 'arquimedes', nome: 'Princípio de Arquimedes'}]}
                                ]}
                            ]}, 
                            { nome: 'Termologia e Óptica', modulos: [
                                { nome: 'Módulo 1: Calor', assuntos: [
                                    {id: 'termometria', nome: 'Termometria'}, 
                                    {id: 'calorimetria', nome: 'Calorimetria'}, 
                                    {id: 'termodinamica', nome: 'Termodinâmica'}
                                ] }, 
                                { nome: 'Módulo 2: Ondas', assuntos: [
                                    {id: 'ondas', nome: 'Ondas e Fenômenos', subconteudos: [{id: 'ref-dif', nome: 'Refração, Difração, Interferência'}, {id: 'doppler', nome: 'Efeito Doppler e Ressonância'}]}, 
                                    {id: 'acustica', nome: 'Acústica: Som e Propriedades'}
                                ]}, 
                                { nome: 'Módulo 3: Óptica', assuntos: [
                                    {id: 'reflexao', nome: 'Reflexão e Espelhos'}, 
                                    {id: 'refracao', nome: 'Refração e Lentes'}, 
                                    {id: 'optica-fisica', nome: 'Óptica Física'}
                                ]}
                            ]}, 
                            { nome: 'Eletricidade e Moderna', modulos: [
                                { nome: 'Módulo 4: Eletricidade', assuntos: [
                                    {id: 'carga', nome: 'Carga e Campo Elétrico'}, 
                                    {id: 'circuitos', nome: 'Circuitos e Leis de Ohm'}, 
                                    {id: 'geradores', nome: 'Geradores e Receptores'}, 
                                    {id: 'eletromagnetismo', nome: 'Eletromagnetismo e Indução'}
                                ]}, 
                                { nome: 'Módulo 5: Moderna', assuntos: [
                                    {id: 'relatividade', nome: 'Relatividade'}, 
                                    {id: 'quantica', nome: 'Mecânica Quântica (Introdução)'}
                                ]}
                            ]}
                        ]
                    },
                    // 3. QUÍMICA (Expandida e Nomenclatura Focada)
                    {
                        id: 'quimica', nome: 'Química', icone: 'flask-conical', cor: 'bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-900/20 dark:text-purple-300 dark:border-purple-800',
                        frentes: [
                             {
                                nome: 'Geral e Físico-Química',
                                modulos: [
                                    { nome: 'Módulo 1: Introdução', assuntos: [
                                        {id: 'atomistica', nome: 'Atomística', subconteudos: [{id:'modelos', nome:'Modelos Atômicos'}, {id:'distribuicao', nome:'Distribuição Eletrônica'}]}, 
                                        {id: 'tabela', nome: 'Tabela Periódica'}, 
                                        {id: 'ligacoes', nome: 'Ligações Químicas'}, 
                                        {id: 'inorganica', nome: 'Funções Inorgânicas', subconteudos: [{id:'acidos', nome:'Ácidos'}, {id:'bases', nome:'Bases'}, {id:'sais', nome:'Sais'}, {id:'oxidos', nome:'Óxidos'}]},
                                        {id: 'separacao-misturas', nome: 'Separação de Misturas'}
                                    ] },
                                    { nome: 'Módulo 2: Soluções', assuntos: [
                                        {id: 'dispersoes', nome: 'Dispersões', subconteudos: [{id: 'coloides', nome: 'Coloides'}, {id: 'suspensoes', nome: 'Suspensões'}]},
                                        {id: 'solucoes', nome: 'Soluções e Solubilidade', subconteudos: [{id: 'coeficiente', nome: 'Coeficiente de Solubilidade'}, {id: 'classificacao', nome: 'Saturada, Insaturada e Supersaturada'}]},
                                        {id: 'concentracao', nome: 'Concentração', subconteudos: [{id: 'comum', nome: 'Concentração Comum'}, {id: 'molaridade', nome: 'Molaridade'}, {id: 'titulo', nome: 'Título e ppm'}]},
                                        {id: 'diluicao', nome: 'Diluição e Mistura de Soluções', subconteudos: [{id: 'diluicao-calc', nome: 'Cálculo de Diluição'}, {id: 'mistura-sem-reacao', nome: 'Mistura sem Reação'}, {id: 'mistura-com-reacao', nome: 'Mistura com Reação (Titulação)'}]}
                                    ] },
                                    { nome: 'Módulo 3: Termoquímica e Cinética', assuntos: [
                                        {id: 'termo', nome: 'Termoquímica', subconteudos: [{id: 'entalpia', nome: 'Entalpia'}, {id: 'lei-hess', nome: 'Lei de Hess'}, {id: 'energia-ligacao', nome: 'Energia de Ligação'}]}, 
                                        {id: 'cinetica', nome: 'Cinética Química', subconteudos: [{id: 'velocidade', nome: 'Velocidade Média'}, {id: 'fatores', nome: 'Fatores da Velocidade'}]}
                                    ] },
                                    { nome: 'Módulo 4: Equilíbrio e Eletro', assuntos: [
                                        {id: 'equilibrio', nome: 'Equilíbrio Químico', subconteudos: [{id: 'kc-kp', nome: 'Kc e Kp'}, {id: 'le-chatelier', nome: 'Princípio de Le Chatelier'}]}, 
                                        {id: 'ionico', nome: 'Equilíbrio Iônico', subconteudos: [{id: 'ph-poh', nome: 'pH e pOH'}, {id: 'hidrolise', nome: 'Hidrólise Salina'}, {id: 'tampao', nome: 'Soluções Tampão'}]}, 
                                        {id: 'eletro', nome: 'Eletroquímica', subconteudos: [{id: 'pilhas', nome: 'Pilhas'}, {id: 'eletrolise', nome: 'Eletrólise'}, {id: 'faraday', nome: 'Leis de Faraday'}]}, 
                                        {id: 'radioatividade', nome: 'Radioatividade'}
                                    ] },
                                    { nome: 'Módulo 5: Ambiental e Análise', assuntos: [
                                        {id: 'ambiental', nome: 'Química Ambiental', subconteudos: [{id:'poluicao-agua', nome:'Poluição Hídrica'}, {id:'poluicao-ar', nome:'Poluição Atmosférica'}]}, 
                                        {id: 'analise', nome: 'Análise Química Qualitativa/Quantitativa'}
                                    ]}
                                ]
                            },
                            {
                                nome: 'Química Orgânica',
                                modulos: [
                                    { nome: 'Módulo 1: Introdução', assuntos: [
                                        {id: 'intro-org', nome: 'Cadeias Carbônicas e Hibridização'}, 
                                        {id: 'hidrocarbonetos', nome: 'Hidrocarbonetos e Nomenclatura IUPAC'}, 
                                        {id: 'aromaticidade', nome: 'Compostos Aromáticos'}
                                    ] },
                                    { nome: 'Módulo 2: Funções Oxigenadas (Nomenclatura)', assuntos: [
                                        {id: 'nomenclatura-alcool', nome: 'Álcoois, Fenóis e Éteres', subconteudos: [{id:'alcool', name:'Álcoois'}, {id:'fenois', name:'Fenóis'}, {id:'eteres', name:'Éteres'}]}, 
                                        {id: 'nomenclatura-acido', nome: 'Ácidos Carboxílicos e Ésteres', subconteudos: [{id:'acidos-c', name:'Ácidos Carboxílicos'}, {id:'esteres-n', name:'Ésteres'}]}, 
                                        {id: 'nomenclatura-aldeido', nome: 'Aldeídos e Cetonas', subconteudos: [{id:'aldeidos-n', name:'Aldeídos'}, {id:'cetonas-n', name:'Cetonas'}]}, 
                                        {id: 'outras-funcoes', nome: 'Anidridos e Sais Orgânicos', subconteudos: [{id:'anidridos-n', name:'Anidridos'}, {id:'sais-n', name:'Sais Orgânicos'}]}
                                    ] },
                                    { nome: 'Módulo 3: Nitrogenadas e Outras (Nomenclatura)', assuntos: [
                                        {id: 'nomenclatura-nitro', nome: 'Aminas, Amidas e Nitrilas', subconteudos: [{id:'aminas-n', name:'Aminas'}, {id:'amidas-n', name:'Amidas'}, {id:'nitrilas-n', name:'Nitrilas'}]}, 
                                        {id: 'haletos', nome: 'Haletos Orgânicos e Grignard', subconteudos: [{id:'haletos-n', name:'Haletos Orgânicos'}, {id:'grignard-n', name:'Compostos de Grignard'}]}
                                    ] },
                                    { nome: 'Módulo 4: Isomeria e Reações', assuntos: [
                                        {id: 'isomeria-plana', nome: 'Isomeria Plana', subconteudos: [{id:'cadeia', name:'Isomeria de Cadeia'}, {id:'funcao', name:'Isomeria de Função'}, {id:'posicao', name:'Isomeria de Posição'}]}, 
                                        {id: 'isomeria-espacial', nome: 'Isomeria Espacial', subconteudos: [{id:'geometrica', name:'Isomeria Geométrica'}, {id:'optica', name:'Isomeria Óptica'}]}, 
                                        {id: 'reacoes-adicao', nome: 'Reações de Adição'}, 
                                        {id: 'reacoes-subst', nome: 'Reações de Substituição'}, 
                                        {id: 'sabonificacao', nome: 'Sabonificação e Esterificação'}, 
                                        {id: 'polimeros', nome: 'Polímeros'}
                                    ] }
                                ]
                            }
                        ]
                    },
                    // 4. BIOLOGIA (Expandida)
                    { 
                        id: 'biologia', nome: 'Biologia', icone: 'leaf', cor: 'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/20 dark:text-green-300 dark:border-green-800', 
                        frentes: [
                            {
                                nome: 'Base da Vida',
                                modulos: [
                                    { nome: 'Módulo 1: Origem e Bioquímica', assuntos: [
                                        {id: 'origem', nome: 'Origem da Vida'}, 
                                        {id: 'bioquimica', nome: 'Bioquímica Celular', subconteudos: [{id: 'agua-sais', nome: 'Água e Sais Minerais'}, {id: 'carb-lipid', nome: 'Carboidratos e Lipídios'}, {id: 'prot-enz', nome: 'Proteínas e Enzimas'}]}
                                    ]},
                                    { nome: 'Módulo 2: Citologia e Molecular', assuntos: [
                                        {id: 'citologia', nome: 'Citologia', subconteudos: [{id: 'membrana', nome: 'Membrana e Transporte'}, {id: 'organelas', nome: 'Organelas'}]}, 
                                        {id: 'metabolismo', nome: 'Metabolismo Energético', subconteudos: [{id: 'respiracao', nome: 'Respiração Celular'}, {id: 'fotossintese', nome: 'Fotossíntese'}]}, 
                                        {id: 'divisao', nome: 'Divisão Celular'},
                                        {id: 'molecular', nome: 'Biologia Molecular', subconteudos: [{id: 'dna-rna', nome: 'DNA e RNA'}, {id: 'sintese', nome: 'Síntese Proteica'}]}
                                    ]}
                                ]
                            },
                            {
                                nome: 'Saúde e Diversidade',
                                modulos: [
                                    { nome: 'Módulo 3: Fisiologia e Imunologia', assuntos: [
                                        {id: 'fisiologia', nome: 'Fisiologia Humana (Sistemas)'}, 
                                        {id: 'imunologia', nome: 'Imunologia', subconteudos: [{id: 'vsoro', name:'Vacinas e Soros'}, {id: 'alergias', name:'Alergias e Rejeição'}]}
                                    ]},
                                    { nome: 'Módulo 4: Seres Vivos', assuntos: [
                                        {id: 'sistematica', nome: 'Sistemática e Classificação'}, 
                                        {id: 'micro', nome: 'Microbiologia e Parasitologia'}, 
                                        {id: 'botanica', nome: 'Botânica'}, 
                                        {id: 'zoologia', nome: 'Zoologia'}
                                    ]}
                                ]
                            },
                            {
                                nome: 'Ecologia',
                                modulos: [
                                    { nome: 'Módulo 5: Ecologia', assuntos: [
                                        {id: 'fundamentos', nome: 'Cadeias e Relações Ecológicas'}, 
                                        {id: 'ciclos', nome: 'Ciclos Biogeoquímicos'}, 
                                        {id: 'impactos', nome: 'Impactos Ambientais'}
                                    ]}
                                ]
                            }
                        ]
                    },
                    // 5. HISTÓRIA (Expandida)
                    {
                        id: 'historia', nome: 'História', icone: 'landmark', cor: 'bg-yellow-50 text-yellow-700 border-yellow-200 dark:bg-yellow-900/20 dark:text-yellow-300 dark:border-yellow-800', 
                        frentes: [
                            {
                                nome: 'História Geral',
                                modulos: [
                                    { nome: 'Módulo 1: Antiguidade e Média', assuntos: [
                                        {id: 'antiguidade', nome: 'Antiguidade Clássica', subconteudos: [{id: 'grecia', nome: 'Grécia'}, {id: 'roma', nome: 'Roma'}]}, 
                                        {id: 'media', nome: 'Idade Média'}
                                    ]},
                                    { nome: 'Módulo 2: Moderna', assuntos: [
                                        {id: 'moderna', nome: 'Idade Moderna', subconteudos: [{id: 'absolutismo', nome: 'Absolutismo'}, {id: 'iluminismo', nome: 'Iluminismo'}]}
                                    ]},
                                    { nome: 'Módulo 3: Contemporânea', assuntos: [
                                        {id: 'revolucoes', nome: 'Revoluções Burguesas'}, 
                                        {id: 'guerras', nome: 'Grandes Guerras e Totalitarismo'}, 
                                        {id: 'guerra-fria', nome: 'Guerra Fria'}, 
                                        {id: 'mundo-atual', nome: 'Mundo Contemporâneo e Globalização'}
                                    ]}
                                ]
                            },
                            {
                                nome: 'História do Brasil',
                                modulos: [
                                    { nome: 'Módulo 1: Colônia', assuntos: [
                                        {id: 'colonia', nome: 'Brasil Colônia', subconteudos: [{id: 'economia-col', nome: 'Economia Colonial'}, {id: 'revoltas', nome: 'Revoltas'}]}, 
                                        {id: 'patrimonio', nome: 'Patrimônio Histórico Cultural'}
                                    ]},
                                    { nome: 'Módulo 2: Império', assuntos: [
                                        {id: 'imperio', nome: 'Brasil Império', subconteudos: [{id: 'independencia', nome: 'Independência'}, {id: 'regencia', nome: 'Período Regencial'}]}
                                    ]},
                                    { nome: 'Módulo 3: República', assuntos: [
                                        {id: 'republica', nome: 'Brasil República', subconteudos: [{id: 'vargas', nome: 'Era Vargas'}, {id: 'ditadura', nome: 'Ditadura Militar'}]}
                                    ]}
                                ]
                            }
                        ]
                    },
                    // 6. GEOGRAFIA (Expandida)
                    {
                        id: 'geografia', nome: 'Geografia', icone: 'globe', cor: 'bg-indigo-50 text-indigo-700 border-indigo-200 dark:bg-indigo-900/20 dark:text-indigo-300 dark:border-indigo-800', 
                        frentes: [
                             {
                                nome: 'Geografia Geral e Econômica',
                                modulos: [
                                    { nome: 'Módulo 1: Espaço Rural e Agrário', assuntos: [
                                        {id: 'producao-rural', nome: 'Produção dos Espaços Rurais'},
                                        {id: 'agrario-desenvolvidos', nome: 'Espaço Agrário em Países Desenvolvidos'},
                                        {id: 'agrario-desenvolvimento', nome: 'Espaço Agrário em Países em Desenvolvimento'},
                                        {id: 'reforma-agraria', nome: 'Questão da Reforma Agrária'}
                                    ]},
                                    { nome: 'Módulo 2: Dinâmicas Socioeconômicas', assuntos: [
                                        {id: 'desigualdades', nome: 'Desigualdades Socioeconômicas'},
                                        {id: 'contradicoes', nome: 'Contradições da Globalização'},
                                        {id: 'regionalizacao', nome: 'Regionalização do Brasil'}
                                    ]},
                                    { nome: 'Módulo 3: Redes e Fluxos', assuntos: [
                                        {id: 'transportes', nome: 'Rede de Transportes'},
                                        {id: 'turismo', nome: 'Expansão do Turismo'},
                                        {id: 'comercio', nome: 'Comércio Global'},
                                        {id: 'financeiro', nome: 'Sistema Financeiro Mundial'}
                                    ]}
                                ]
                            },
                            {
                                nome: 'Demografia e Cultura',
                                modulos: [
                                    { nome: 'Módulo 1: População e Migrações', assuntos: [
                                        {id: 'estrutura-pop', nome: 'Estrutura Populacional'},
                                        {id: 'cultura-migracoes', nome: 'Cultura e Migrações'},
                                        {id: 'tensoes-migratorias', nome: 'Tensões Migratórias e Xenofobia'}
                                    ]}
                                ]
                            },
                            {
                                nome: 'Geopolítica Contemporânea',
                                modulos: [
                                    { nome: 'Módulo 1: Poder e Organizações', assuntos: [
                                        {id: 'onu', nome: 'Estrutura da ONU'},
                                        {id: 'blocos', nome: 'Blocos Econômicos'},
                                        {id: 'brasil-comercio', nome: 'Brasil no Comércio'},
                                        {id: 'terceiro-setor', nome: 'Terceiro Setor'},
                                        {id: 'impasses', nome: 'Impasses Globais'}
                                    ]},
                                    { nome: 'Módulo 2: Conflitos e Tensões', assuntos: [
                                        {id: 'nacionalismos', nome: 'Nacionalismos'},
                                        {id: 'oriente-medio', nome: 'Oriente Médio'},
                                        {id: 'guerra-fria-xxi', nome: 'Herança da Guerra Fria'},
                                        {id: 'terrorismo', nome: 'Terrorismo Internacional'},
                                        {id: 'conflitos-regionais', nome: 'Conflitos Regionais'}
                                    ]}
                                ]
                            },
                             {
                                nome: 'Conteúdos Extras',
                                modulos: [
                                    { nome: 'Módulo Extra: Agrário e Rural', assuntos: [{ id: 'espaco-agrario-geral', nome: 'Espaço Agrário', subconteudos: [{ id: 'producao-rural', nome: 'A produção dos espaços rurais' }, { id: 'agrario-desenvolvidos', nome: 'Espaço agrário em países desenvolvidos' }, { id: 'agrario-desenvolvimento', nome: 'Espaço agrário em países em desenvolvimento' }, { id: 'reforma-agraria', nome: 'A questão da reforma agrária' }] }] },
                                    { nome: 'Módulo Extra: Dinâmica Socioeconômica', assuntos: [{ id: 'dinamica-socioeconomica', nome: 'Dinâmica Socioeconômica', subconteudos: [{ id: 'desigualdades-socioeconomicas', nome: 'Desigualdades socioeconômicas: vários mundos' }, { id: 'contradicoes-globalizacao', nome: 'Contradições do mundo globalizado' }, { id: 'regionalizacao-br', nome: 'Regionalização do território brasileiro' }, { id: 'estrutura-populacional', nome: 'Estrutura e distribuição populacional' }, { id: 'cultura-migracoes', nome: 'Cultura e migrações' }, { id: 'tensa-migratoria', nome: 'Tensões migratórias e xenofobia' }] }] },
                                    { nome: 'Módulo Extra: Redes e Fluxos', assuntos: [{ id: 'redes-fluxos', nome: 'Redes e Fluxos Globais', subconteudos: [{ id: 'rede-transportes', nome: 'Rede de transportes mundial' }, { id: 'turismo', nome: 'Expansão do turismo no Brasil e mundo' }, { id: 'comercio-global', nome: 'Comércio global: fluxo de mercadorias' }, { id: 'sistema-financeiro', nome: 'Sistema financeiro mundial' }] }] },
                                    { nome: 'Módulo Extra: Geopolítica Contemporânea', assuntos: [{ id: 'geopolitica-contemporanea', nome: 'Geopolítica Contemporânea', subconteudos: [{ id: 'onu', nome: 'A estrutura da ONU' }, { id: 'poder-global-blocos', nome: 'Poder global e blocos econômicos' }, { id: 'brasil-comercio', nome: 'Brasil e o comércio multilateral' }, { id: 'terceiro-setor', nome: 'Terceiro setor e mobilizações sociais' }, { id: 'impasses-gestao', nome: 'Impasses na gestão global' }, { id: 'nacionalismos', nome: 'Nacionalismos e tensões políticas' }, { id: 'oriente-medio', nome: 'Oriente Médio' }, { id: 'heranca-guerra-fria', nome: 'Herança da Guerra Fria no séc XXI' }, { id: 'terrorismo', nome: 'Terrorismo internacional' }, { id: 'conflitos-regionais', nome: 'Conflitos regionais e conexões globais' }] }] }
                                ]
                            }
                        ]
                    },
                    {
                        id: 'filosofia', nome: 'Filosofia', icone: 'brain-circuit', cor: 'bg-teal-50 text-teal-700 border-teal-200 dark:bg-teal-900/20 dark:text-teal-300 dark:border-teal-800', 
                        frentes: [
                            {
                                nome: 'Fundamentos e Antiga',
                                modulos: [
                                    { nome: 'Introdução', assuntos: [{id: 'oque-filosofia', nome: 'O que é Filosofia'}] },
                                    { nome: 'Pensamento Antigo', assuntos: [{id: 'felicidade-antiga', nome: 'Felicidade e Filosofia no pensamento antigo'}, {id: 'eros', nome: 'Eros e filosofia'}, {id: 'pre-socraticos', nome: 'Pré-Socráticos'}, {id: 'classicos', nome: 'Socráticos (Sócrates, Platão, Aristóteles)'}] }
                                ]
                            },
                            {
                                nome: 'Ética e Política Contemporânea',
                                modulos: [
                                    { nome: 'Bioética e Tecnologia', assuntos: [{id: 'bioetica', nome: 'Filosofia e bioética'}, {id: 'tec-sociedade', nome: 'Tecnologia e sociedade'}] },
                                    { nome: 'Política e Religião', assuntos: [{id: 'religiao-estado', nome: 'Religião e Estado'}, {id: 'etica', nome: 'Ética'}, {id: 'politica', nome: 'Filosofia Política'}] }
                                ]
                            },
                            {
                                nome: 'Metafísica e Conhecimento',
                                modulos: [
                                    { nome: 'Metafísica', assuntos: [{id: 'metafisica', nome: 'Metafísica'}, {id: 'critica-metafisica', nome: 'Crítica à metafísica'}, {id: 'pos-critica', nome: 'Metafísica após a crítica'}] },
                                    { nome: 'Teoria do Conhecimento', assuntos: [{id: 'epistemologia', nome: 'Teoria do Conhecimento (Racionalismo/Empirismo)'}] }
                                ]
                            }
                        ]
                    },
                    {
                        id: 'sociologia', nome: 'Sociologia', icone: 'users', cor: 'bg-cyan-50 text-cyan-700 border-cyan-200 dark:bg-cyan-900/20 dark:text-cyan-300 dark:border-cyan-800', 
                        frentes: [
                             {
                                nome: 'Módulos',
                                modulos: [
                                    { nome: 'Módulo 1: Conceitos Fundamentais', assuntos: [{id: 'conceitos-sociologicos', nome: 'Cultura, Identidade e Estratificação Social', subconteudos: [{id: 'cultura-ideologia', nome: 'Cultura e Ideologia'}, {id: 'identidade-socializacao', nome: 'Identidade e Socialização'}, {id: 'estratificacao-desigualdade', nome: 'Estratificação e Desigualdade'}]}]},
                                    { nome: 'Módulo 2: Estruturas Sociais', assuntos: [{id: 'estruturas-sociais', nome: 'Trabalho, Política e Movimentos Sociais', subconteudos: [{id: 'sociologia-trabalho', nome: 'Sociologia do Trabalho'}, {id: 'estado-poder-politica', nome: 'Estado, Poder e Política'}, {id: 'movimentos-sociais', nome: 'Movimentos Sociais'}]}]},
                                    { nome: 'Módulo 3: Pensadores da Sociologia', assuntos: [{id: 'pensadores-sociologia', nome: 'Sociologia Clássica e Contemporânea', subconteudos: [{id: 'comte', nome: 'Augusto Comte'}, {id: 'durkheim', nome: 'Émile Durkheim'}, {id: 'weber', nome: 'Max Weber'}, {id: 'marx', nome: 'Karl Marx'}]}]}
                                ]
                            }
                        ]
                    },
                    {
                        id: 'portugues', nome: 'Português', icone: 'book-a', cor: 'bg-orange-50 text-orange-700 border-orange-200 dark:bg-orange-900/20 dark:text-orange-300 dark:border-orange-800', 
                        frentes: [
                            {
                                nome: 'Gramática',
                                modulos: [
                                     { nome: 'Módulo 1: Morfologia', assuntos: [{id: 'morfologia', nome: 'Morfologia', subconteudos: [{id: 'classes-palavras-variaveis', nome: 'Classes de Palavras Variáveis'}, {id: 'classes-palavras-invariaveis', nome: 'Classes de Palavras Invariaveis'}, {id: 'formacao-palavras', nome: 'Processos de Formação de Palavras'}]}]},
                                     { nome: 'Módulo 2: Sintaxe', assuntos: [{id: 'sintaxe', nome: 'Sintaxe', subconteudos: [{id: 'periodo-simples', nome: 'Período Simples: Termos da Oração'}, {id: 'oracoes-coordenadas', nome: 'Período Composto: Orações Coordenadas'}, {id: 'oracoes-subordinadas-substantivas', nome: 'Orações Subordinadas Substantivas'}, {id: 'oracoes-subordinadas-adjetivas', nome: 'Orações Subordinadas Adjetivas'}, {id: 'oracoes-subordinadas-adverbiais', nome: 'Orações Subordinadas Adverbiais'}]}]},
                                     { nome: 'Módulo 3: Normas e Pontuação', assuntos: [{id: 'concordancia-regencia-crase', nome: 'Concordância, Regência e Crase', subconteudos: [{id: 'concordancia-verbal', nome: 'Concordância Verbal'}, {id: 'concordancia-nominal', nome: 'Concordância Nominal'}, {id: 'regencia-verbal-nominal', nome: 'Regência Verbal e Nominal'}, {id: 'crase', nome: 'Crase'}]}, {id: 'pontuacao', nome: 'Pontuação'}]}
                                ]
                            },
                            {
                                nome: 'Texto e Interpretação',
                                modulos: [
                                    { nome: 'Módulo 1: Fundamentos do Texto', assuntos: [{id: 'coesao-coerencia', nome: 'Coesão e Coerência'}]},
                                    { nome: 'Módulo 2: Análise Textual', assuntos: [{id: 'interpretacao-textos', nome: 'Interpretação e Tipos Textuais', subconteudos: [{id: 'tipologia-textual', nome: 'Tipologia Textual'}, {id: 'generos-textuais', nome: 'Gêneros Textuais'}, {id: 'intertextualidade', nome: 'Intertextualidade'}]}]},
                                    { nome: 'Módulo 3: Recursos Expressivos', assuntos: [{id: 'figuras-variacao-linguistica', nome: 'Figuras e Variação Linguística', subconteudos: [{id: 'figuras-linguagem', nome: 'Figuras de Linguagem'}, {id: 'variacao-linguistica', nome: 'Variação Linguística'}, {id: 'funcoes-linguagem', nome: 'Funções da Linguagem'}]}]}
                                ]
                            }
                        ]
                    },
                    {
                        id: 'literatura', nome: 'Literatura', icone: 'book-open', cor: 'bg-lime-50 text-lime-700 border-lime-200 dark:bg-lime-900/20 dark:text-lime-300 dark:border-lime-800', 
                        frentes: [
                            {
                                nome: 'Módulos',
                                modulos: [
                                    { nome: 'Módulo 1: Período Colonial', assuntos: [{id: 'literatura-colonial', nome: 'Período Colonial', subconteudos: [{id: 'trovadorismo-classicismo', nome: 'Trovadorismo e Classicismo'}, {id: 'barroco-arcadismo', nome: 'Barroco e Arcadismo'}]}]},
                                    { nome: 'Módulo 2: Século XIX', assuntos: [{id: 'literatura-seculo-xix', nome: 'Século XIX', subconteudos: [{id: 'romantismo', nome: 'Romantismo (Prosa e Poesia)'}, {id: 'realismo-naturalismo', nome: 'Realismo e Naturalismo'}, {id: 'parnasianismo-simbolismo', nome: 'Parnasianismo e Simbolismo'}]}]},
                                    { nome: 'Módulo 3: Século XX e XXI', assuntos: [{id: 'literatura-moderna', nome: 'Século XX e XXI', subconteudos: [{id: 'pre-modernismo', nome: 'Pré-Modernismo'}, {id: 'modernismo-br', nome: 'Modernismo no Brasil'}, {id: 'tendencias-contemp', nome: 'Tendências Contemporâneas'}]}]}
                                ]
                            }
                        ]
                    },
                    {
                        id: 'ingles', nome: 'Inglês', icone: 'languages', cor: 'bg-pink-50 text-pink-700 border-pink-200 dark:bg-pink-900/20 dark:text-pink-300 dark:border-pink-800', 
                        frentes: [
                            {
                                nome: 'Gramática (Grammar)',
                                modulos: [
                                    {
                                        nome: 'Módulo 1: Tempos Verbais',
                                        assuntos: [
                                            {
                                                id: 'verb-tenses', nome: 'Tempos Verbais',
                                                subconteudos: [
                                                    { id: 'simple-tenses', nome: 'Simple Tenses' },
                                                    { id: 'continuous-tenses', nome: 'Continuous Tenses' },
                                                    { id: 'perfect-tenses', nome: 'Perfect Tenses' },
                                                    { id: 'tenses-comparison', nome: 'Comparativo entre Tempos Verbais' }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        nome: 'Módulo 2: Estrutura da Frase',
                                        assuntos: [
                                            { 
                                                id: 'prepositions-conjunctions', nome: 'Prepositions and Conjunctions',
                                                subconteudos: [
                                                    { id: 'prepositions-time', nome: 'Prepositions of Time' },
                                                    { id: 'prepositions-place', nome: 'Prepositions of Place' },
                                                    { id: 'coordinating-conjunctions', nome: 'Coordinating Conjunctions' },
                                                    { id: 'subordinating-conjunctions', nome: 'Subordinating Conjunctions' }
                                                ]
                                            },
                                            { 
                                                id: 'pronouns-articles', nome: 'Pronouns and Articles',
                                                subconteudos: [
                                                    { id: 'subject-object-pronouns', nome: 'Subject & Object Pronouns' },
                                                    { id: 'possessive-pronouns-adjectives', nome: 'Possessive Pronouns & Adjectives' },
                                                    { id: 'definite-indefinite-articles', nome: 'Definite & Indefinite Articles' }
                                                ]
                                            },
                                            {
                                                id: 'reported-speech', nome: 'Reported Speech',
                                                subconteudos: [
                                                    { id: 'reported-statements', nome: 'Reported Statements' },
                                                    { id: 'reported-questions', nome: 'Reported Questions' },
                                                    { id: 'reporting-verbs', nome: 'Reporting Verbs' },
                                                    { id: 'tense-pronoun-changes', nome: 'Changes in Tense, Pronouns, and Time' }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        nome: 'Módulo 3: Verbos Modais e Condicionais',
                                        assuntos: [
                                            { 
                                                id: 'modal-verbs', nome: 'Modal Verbs',
                                                subconteudos: [
                                                    { id: 'modals-ability', nome: 'Modals of Ability' },
                                                    { id: 'modals-obligation', nome: 'Modals of Obligation' },
                                                    { id: 'modals-possibility', nome: 'Modals of Possibility' }
                                                ]
                                            },
                                            {
                                                id: 'conditionals', nome: 'Conditionals',
                                                subconteudos: [
                                                    { id: 'zero-first-conditional', nome: 'Zero & First Conditional' },
                                                    { id: 'second-conditional', nome: 'Second Conditional' },
                                                    { id: 'third-conditional', nome: 'Third Conditional' }
                                                ]
                                            },
                                            { 
                                                id: 'passive-voice', nome: 'Passive Voice',
                                                subconteudos: [
                                                    { id: 'passive-voice-tenses', nome: 'Passive Voice in Different Tenses' },
                                                    { id: 'passive-with-by', nome: 'Using "by" in the Passive Voice' }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                nome: 'Vocabulário e Interpretação',
                                modulos: [
                                    {
                                        nome: 'Módulo 1: Habilidades de Leitura',
                                        assuntos: [
                                            { 
                                                id: 'skimming-scanning', nome: 'Skimming and Scanning',
                                                subconteudos: [
                                                    { id: 'skimming-techniques', nome: 'Techniques for Skimming' },
                                                    { id: 'scanning-techniques', nome: 'Techniques for Scanning' }
                                                ]
                                            },
                                            { 
                                                id: 'main-idea-inference', nome: 'Main Idea and Inference',
                                                subconteudos: [
                                                    { id: 'identifying-main-idea', nome: 'Identifying the Main Idea' },
                                                    { id: 'making-inferences', nome: 'Making Inferences from Text' }
                                                ]
                                            },
                                            { 
                                                id: 'text-comprehension', nome: 'Interpretação de Textos',
                                                subconteudos: [
                                                    { id: 'understanding-context', nome: 'Understanding Context and Tone' },
                                                    { id: 'identifying-purpose', nome: 'Identifying Author\'s Purpose' }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        nome: 'Módulo 2: Construção de Vocabulário',
                                        assuntos: [
                                            { 
                                                id: 'phrasal-verbs', nome: 'Phrasal Verbs',
                                                subconteudos: [
                                                    { id: 'common-phrasal-verbs', nome: 'Common Phrasal Verbs' },
                                                    { id: 'separable-inseparable', nome: 'Separable vs. Inseparable' }
                                                ]
                                            },
                                            { 
                                                id: 'idioms', nome: 'Idiomatic Expressions',
                                                subconteudos: [
                                                    { id: 'common-idioms', nome: 'Common English Idioms' }
                                                ]
                                            },
                                            { 
                                                id: 'false-cognates', nome: 'False Cognates',
                                                subconteudos: [
                                                    { id: 'common-false-friends', nome: 'Common False Friends' }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        id: 'redacao',
                        nome: 'Redação',
                        icone: 'file-pen-line', 
                        cor: 'bg-rose-50 text-rose-700 border-rose-200 dark:bg-rose-900/20 dark:text-rose-300 dark:border-rose-800', 
                        frentes: [
                            {
                                nome: 'Módulos',
                                modulos: [
                                     { nome: 'Módulo 1: Estrutura e Competências', assuntos: [{id: 'estrutura-dissertativa', nome: 'Estrutura Dissertativo-Argumentativa'}, {id: 'competencias-enem', nome: 'Competências do ENEM'}]}
                                ]
                            }
                        ]
                    }
                ],
                questoes: []
            },
            
            searchIndex: [],
            currentAssuntos: [], 

            init: async function() {
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                }

                const savedQ = localStorage.getItem(this.CACHE_PREFIX + 'questoes');
                if (savedQ) {
                    try {
                        this.db.questoes = JSON.parse(savedQ);
                        this.renderQuestoes();
                    } catch(e) { console.error("Cache inválido", e); }
                }

                await this.initFirebase();

                this.setupNavigation();
                this.setupMobileMenu();
                this.buildSearchIndex();
                this.renderMateriasGrid();
                this.populateFilters();
                this.setupSearch();
            },

            // --- FIREBASE & CLOUD STORAGE ---
            initFirebase: async function() {
                const statusEl = document.getElementById('cloud-status');
                
                try {
                    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js");
                    const { getAuth, signInAnonymously, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js");
                    const { getStorage, ref, listAll, getBytes } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js");

                    const firebaseConfig = {
                        apiKey: "AIzaSyCdXO82z5x01QtD5G4gxoL1qosa8e0QIp4",
                        authDomain: "genius---plataforma-de-estudos.firebaseapp.com",
                        projectId: "genius---plataforma-de-estudos",
                        storageBucket: "genius---plataforma-de-estudos.firebasestorage.app",
                        messagingSenderId: "410977832662",
                        appId: "1:410977832662:web:3c98e18c232f33bf4a8377"
                    };

                    const appName = "InsFlow-" + new Date().getTime();
                    const firebaseApp = initializeApp(firebaseConfig, appName);
                    const auth = getAuth(firebaseApp);
                    this.storage = getStorage(firebaseApp);
                    
                    try {
                        await signInAnonymously(auth);
                    } catch (authError) {
                        console.warn("Autenticação anônima falhou. Modo offline ativado.", authError);
                        if(statusEl) { statusEl.textContent = "Modo Offline"; statusEl.classList.add('bg-yellow-200'); }
                        return; 
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            console.log("Firebase conectado:", user.uid);
                            if(statusEl) { statusEl.textContent = "Conectado"; statusEl.classList.remove('bg-gray-200'); statusEl.classList.add('bg-green-200', 'text-green-800'); }
                            this.fetchCloudFilesList(ref, listAll);
                        }
                    });
                    
                    this.firebaseUtils = { ref, getBytes };

                } catch (e) {
                    console.error("Erro crítico ao inicializar Firebase:", e);
                    if(statusEl) { statusEl.textContent = "Erro Conexão"; statusEl.classList.add('bg-red-200'); }
                }
            },

            fetchCloudFilesList: async function(ref, listAll) {
                if (!this.storage) return;
                try {
                    const folderRef = ref(this.storage, 'provas/');
                    const res = await listAll(folderRef);
                    this.cloudFilesList = res.items.filter(item => item.name.includes('_CAD_'));
                    console.log(`${this.cloudFilesList.length} provas encontradas no Storage.`);
                } catch (error) {
                    console.error("Erro ao listar arquivos do Storage:", error);
                }
            },

            autoLoadProofContext: async function() {
                if (this.activeCloudText) return true;

                if (!this.cloudFilesList || this.cloudFilesList.length === 0 || !this.firebaseUtils) {
                    return false; 
                }

                const randomFileRef = this.cloudFilesList[Math.floor(Math.random() * this.cloudFilesList.length)];
                this.activeProofName = randomFileRef.name;
                
                const btn = document.getElementById('btn-gerar-questoes');
                const originalText = btn.textContent;
                btn.textContent = "Baixando base...";
                btn.disabled = true;

                try {
                    const { ref, getBytes } = this.firebaseUtils;
                    const proofBlob = await getBytes(randomFileRef);
                    
                    let gabaritoText = "";
                    const gabPath = randomFileRef.fullPath.replace("_CAD_", "_GAB_");
                    try {
                        const gabRef = ref(this.storage, gabPath);
                        const gabBlob = await getBytes(gabRef);
                        
                        if (typeof pdfjsLib !== 'undefined') {
                            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                            const gabPdf = await pdfjsLib.getDocument({ data: gabBlob }).promise;
                            for (let i = 1; i <= gabPdf.numPages; i++) {
                                const p = await gabPdf.getPage(i);
                                const tc = await p.getTextContent();
                                gabaritoText += tc.items.map(item => item.str).join(' ') + "\n";
                            }
                        }
                    } catch (e) { console.warn("Sem gabarito para esta prova."); }

                    let proofText = "";
                    if (typeof pdfjsLib !== 'undefined') {
                        const pdf = await pdfjsLib.getDocument({ data: proofBlob }).promise;
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const p = await pdf.getPage(i);
                            const tc = await p.getTextContent();
                            proofText += tc.items.map(item => item.str).join(' ') + "\n";
                        }
                    }

                    this.activeCloudText = `PROVA (${randomFileRef.name}):\n${proofText}\n\nGABARITO:\n${gabaritoText}`;
                    console.log("Contexto de prova carregado com sucesso.");
                    
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return true;
                } catch (e) {
                    console.error("Erro autoload:", e);
                    btn.textContent = "Erro base";
                    setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
                    return false;
                }
            },

            toggleTheme: function() {
                const html = document.documentElement;
                if (html.classList.contains('dark')) { html.classList.remove('dark'); localStorage.setItem('theme', 'light'); } 
                else { html.classList.add('dark'); localStorage.setItem('theme', 'dark'); }
            },

            callAPI: async function(prompt, isJson, agentType = 'default') {
                if (!API_KEY) {
                    API_KEY = localStorage.getItem('insflow_openai_key') || "";
                    if (!API_KEY) {
                        const key = window.prompt("Insira sua API Key:");
                        if(key) {
                            API_KEY = key;
                            localStorage.setItem('insflow_openai_key', API_KEY);
                        } else {
                            throw new Error("Chave necessária.");
                        }
                    }
                }

                const requestBody = {
                    model: "gpt-4o-mini", 
                    messages: [{ role: "user", content: prompt }],
                    response_format: isJson ? { type: "json_object" } : undefined,
                    temperature: 0.7
                };

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    if (response.ok) {
                        const json = await response.json();
                        if (json.choices && json.choices.length > 0) {
                             return json.choices[0].message.content;
                        }
                        if (json.response) return json.response; 
                    }
                } catch (e) {
                    console.warn("Backend Vercel falhou. Usando modo direto.");
                }

                try {
                    const response = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) {
                        if (response.status === 401) localStorage.removeItem('insflow_openai_key');
                        throw new Error(`Erro API: ${response.status}`);
                    }
                    const json = await response.json();
                    return json.choices[0].message.content;
                } catch (e) { throw e; }
            },

            getLoadingSpinner: function(text) {
                return `<div class="flex flex-col items-center justify-center p-6 space-y-3"><div class="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div><p class="text-sm text-indigo-600 dark:text-indigo-400 font-medium animate-pulse">${text}</p></div>`;
            },

            generateContent: async function(materia, topico, tipo, targetId) {
                const target = document.getElementById(targetId);
                if(!target) return;
                target.innerHTML = this.getLoadingSpinner("Gerando conteúdo...");

                let formatoInstrucao = "";
                let loadingMsg = "";
                
                if (tipo === 'resumo') {
                    loadingMsg = "Sintetizando pontos-chave e flashcards...";
                    formatoInstrucao = `
                    **FORMATO: RESUMO DIDÁTICO (Foco em Memorização)**
                    - ESTRUTURA: Definição Concisa > Listas de Propriedades/Fórmulas ESSENCIAIS > Exemplo Prático.
                    - PEDAGOGIA: Use **negrito** para termos-chave. Mantenha os parágrafos muito curtos.
                    - SAÍDA: Deve ser um material de revisão rápida.
                    `;
                } else if (tipo === 'explicacao') {
                    loadingMsg = "Preparando aula didática com analogias...";
                    formatoInstrucao = `
                    **FORMATO: AULA DETALHADA (Didática e Acessível)**
                    - ESTRUTURA: Comece com uma **Analogia Simples** (ex: do dia a dia) para introduzir o conceito. Siga com o Desenvolvimento Lógico e finalização com Aplicação no ENEM.
                    - PEDAGOGIA: Use linguagem profissional, mas com tom engajador. Explique O QUE, COMO e PORQUÊ.
                    - SAÍDA: Use tags HTML (p, ul, b) para quebrar o texto e facilitar a leitura.
                    `;
                } else if (tipo === 'completo') {
                    loadingMsg = "Elaborando dossiê aprofundado...";
                    formatoInstrucao = `
                    **FORMATO: DOSSIÊ COMPLETO (Rigor e Aprofundamento)**
                    - ESTRUTURA: Detalhes, contexto histórico, deduções e relações interdisciplinares.
                    - PEDAGOGIA: Rigor acadêmico. Inclua exceções à regra e análise crítica (se aplicável).
                    - SAÍDA: Material ideal para domínio total do assunto.
                    `;
                }

                let extra = ['Sociologia','Filosofia','História'].includes(materia) ? "Foque em conceitos, autores e contexto social. Não use fórmulas ou cálculos." : "";
                
                const prompt = `Professor ENEM. Tópico: "${topico}" (${materia}). Formato: ${formatoInstrucao}. ${extra}. Use HTML (p, h3, ul, b) e LaTeX $$ para fórmulas. Responda apenas com o conteúdo gerado.`;

                try {
                    let content = await this.callAPI(prompt, false);
                    content = content.replace(/```html/g, '').replace(/```/g, '');
                    
                    target.innerHTML = content;
                    if(window.renderMathInElement) renderMathInElement(target);
                } catch (e) {
                    target.innerHTML = `<div class="text-red-500 p-2 text-xs">Erro: ${e.message}</div>`;
                }
            },

            populateFilters: function() {
                const discSel = document.getElementById('filtro-disciplina');
                if(!discSel) return;
                discSel.innerHTML = '<option value="">Selecione</option>' + this.db.materias.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
                
                const reset = (id, txt) => { const el = document.getElementById(id); el.innerHTML = `<option value="">${txt}</option>`; el.disabled = true; };

                discSel.onchange = () => {
                    reset('filtro-conteudo', 'Selecione o Conteúdo');
                    reset('filtro-subconteudo', 'Aguardando Conteúdo');
                    const m = this.db.materias.find(x => x.id === discSel.value);
                    if(m) {
                        const assuntos = [];
                        m.frentes.forEach(f => f.modulos.forEach(md => md.assuntos.forEach(a => assuntos.push(a))));
                        assuntos.sort((a, b) => a.nome.localeCompare(b.nome));
                        document.getElementById('filtro-conteudo').innerHTML = '<option value="">Selecione</option>' + assuntos.map(a => `<option value="${a.id}">${a.nome}</option>`).join('');
                        document.getElementById('filtro-conteudo').disabled = false;
                        this.currentAssuntos = assuntos;
                    }
                };

                document.getElementById('filtro-conteudo').onchange = () => {
                    const aId = document.getElementById('filtro-conteudo').value;
                    const sub = document.getElementById('filtro-subconteudo');
                    reset('filtro-subconteudo', 'Selecione (Opcional)');
                    if(aId) {
                        const ass = this.currentAssuntos.find(a => a.id === aId);
                        if(ass && ass.subconteudos) {
                            sub.innerHTML = '<option value="">Geral</option>' + ass.subconteudos.map(s => `<option value="${s.nome}">${s.nome}</option>`).join('');
                            sub.disabled = false;
                        }
                    }
                };
                
                document.getElementById('btn-gerar-questoes').onclick = () => this.handleGenerateQuestions();
            },

            handleGenerateQuestions: async function() {
                const discSel = document.getElementById('filtro-disciplina');
                const contSel = document.getElementById('filtro-conteudo');
                const subSel = document.getElementById('filtro-subconteudo');
                const difSel = document.getElementById('filtro-dificuldade');
                const searchInput = document.getElementById('search-topic');
                const btn = document.getElementById('btn-gerar-questoes');
                
                const searchVal = searchInput.value.trim();
                let topico = searchVal, disc = "Geral";
                
                if(!searchVal) {
                    if(!discSel.value || !contSel.value) return alert("Selecione os filtros.");
                    disc = discSel.options[discSel.selectedIndex].text;
                    topico = contSel.options[contSel.selectedIndex].text;
                    if(subSel.value) topico += ": " + subSel.value;
                }

                btn.disabled = true;
                btn.innerHTML = "Gerando 5 Questões...";
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('questoes-placeholder').classList.add('hidden');

                await this.autoLoadProofContext();

                const isExatas = ['matematica','fisica','quimica'].includes(discSel.value);
                let protocolo = isExatas ? "EXATAS: Resolva matematicamente antes. Alternativa correta = resultado exato." : "HUMANAS: Foco conceitual. Sem cálculos.";
                let dif = difSel.value === 'facil' ? 'Fácil' : (difSel.value === 'dificil' ? 'Difícil' : 'Médio');

                let contextPrompt = "";
                if (this.activeCloudText) {
                    contextPrompt = `\nUSE O SEGUINTE CONTEXTO/TEXTO BASE (Extraído de PDF Oficial):\n"${this.activeCloudText.substring(0, 10000)}"\nBaseie o estilo das questões nisso, mas crie novas.`;
                }

                const prompt = `
                Elaborador ENEM. Tópico: "${topico}" (${disc}). Nível: ${dif}.
                ${protocolo}
                ${contextoPrompt}
                REGRA: 5 questões inéditas. Alternativas únicas. Resolução didática.
                JSON OBRIGATÓRIO (Use \\n para quebras): 
                { "questoes": [ { "enunciado": "...", "alternativas": [{"letra": "A", "texto": "...", "correta": false, "justificativa_erro": "..."}...], "resolucao": "..." } ] }
                `;

                try {
                    let res = await this.callAPI(prompt, true);
                    res = res.trim().replace(/^```json/i, '').replace(/^```/i, '').replace(/```$/i, '');
                    let data;
                    try {
                        data = JSON.parse(res);
                    } catch (e) {
                        const lastClose = res.lastIndexOf('}');
                        if (lastClose > -1) {
                             let fixed = res.substring(0, lastClose + 1) + "]}";
                             fixed = fixed.replace(/,\]\}/, "]}");
                             try { data = JSON.parse(fixed); } 
                             catch (e2) { 
                                 const matches = res.match(/\{"enunciado":.+?"alternativas":\[.+?\]\}/gs);
                                 if (matches) data = { questoes: matches.map(m => JSON.parse(m)) };
                                 else throw e; 
                             }
                        } else throw e;
                    }

                    if(!data || !data.questoes) throw new Error("Falha na estrutura.");

                    const startIdx = this.db.questoes.length;
                    this.db.questoes = [...this.db.questoes, ...data.questoes];
                    localStorage.setItem(this.CACHE_PREFIX + 'questoes', JSON.stringify(this.db.questoes));
                    this.appendQuestoesToDOM(data.questoes, startIdx);
                } catch(e) {
                    alert("Erro na geração: " + e.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = "Gerar 5 Novas Questões";
                    document.getElementById('loading-indicator').classList.add('hidden');
                }
            },

            appendQuestoesToDOM: function(questoes, startIndex) {
                const list = document.getElementById('questoes-list');
                const html = questoes.map((q, i) => {
                    const idx = startIndex + i;
                    return `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 mb-6 animate-fade-in">
                        <div class="flex gap-3 mb-4"><span class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300 font-bold px-3 py-1 rounded-lg text-sm h-fit whitespace-nowrap">Q${idx+1}</span><div class="text-gray-800 dark:text-gray-200 font-medium text-lg">${q.enunciado}</div></div>
                        <div class="space-y-2 pl-0 md:pl-10" id="q-options-${idx}">
                            ${q.alternativas.map((alt, optIdx) => `
                                <div class="option-item group p-3 border dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 relative" onclick="window.app.selectAlternativa(${idx}, ${optIdx})" data-idx="${optIdx}" data-correct="${alt.correta}">
                                    <div class="flex justify-between items-center">
                                        <div class="flex gap-3 items-center flex-1">
                                            <div class="option-radio w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center"><div class="w-2.5 h-2.5 rounded-full bg-indigo-600 hidden"></div></div>
                                            <div class="font-bold text-gray-400">${alt.letra})</div>
                                            <div class="text-gray-700 dark:text-gray-300 option-text">${alt.texto}</div>
                                        </div>
                                        <button class="p-2 text-gray-300 hover:text-red-500" onclick="event.stopPropagation(); window.app.toggleStrike(this)"><i data-lucide="eye-off" class="w-4 h-4"></i></button>
                                    </div>
                                    <div class="feedback hidden mt-2 text-sm p-2 rounded bg-opacity-50">${!alt.correta ? (alt.justificativa_erro || 'Incorreto.') : 'Correto!'}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-6 pl-0 md:pl-10">
                            <button id="btn-responder-${idx}" onclick="window.app.verificarResposta(${idx})" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition">Responder</button>
                            <div id="resolucao-${idx}" class="hidden mt-4 p-3 bg-blue-50 dark:bg-gray-700 rounded border border-blue-100 dark:border-gray-600 text-sm text-gray-700 dark:text-gray-300">
                                <span class="font-bold block mb-1">Resolução:</span>${q.resolucao}
                            </div>
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('loading-indicator').insertAdjacentHTML('beforebegin', html);
                if(window.renderMathInElement) renderMathInElement(list);
                lucide.createIcons();
            },

            renderQuestoes: function() {
                if(!this.db.questoes.length) return;
                document.getElementById('questoes-placeholder').classList.add('hidden');
                this.appendQuestoesToDOM(this.db.questoes, 0);
            },

            clearQuestions: function() {
                if(confirm('Deseja apagar todas as questões geradas?')) {
                    this.db.questoes = [];
                    localStorage.removeItem(this.CACHE_PREFIX + 'questoes');
                    document.getElementById('questoes-list').innerHTML = `<div id="questoes-placeholder" class="text-center text-gray-500 py-12"><i data-lucide="book-open" class="mx-auto h-12 w-12 mb-3"></i><p>Inicie a geração.</p></div><div id="loading-indicator" class="hidden text-center py-8"><div class="inline-block animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full"></div></div>`;
                    lucide.createIcons();
                }
            },

            toggleStrike: function(btn) {
                const item = btn.closest('.option-item');
                item.classList.toggle('strikethrough');
                if (item.classList.contains('selected')) {
                    item.classList.remove('selected', 'border-indigo-600', 'bg-indigo-50');
                    item.querySelector('.option-radio').classList.remove('border-indigo-600');
                    item.querySelector('.option-radio div').classList.add('hidden');
                }
            },

            selectAlternativa: function(qIndex, altIndex) {
                const btn = document.getElementById(`btn-responder-${qIndex}`);
                if (btn && btn.disabled) return;
                const container = document.getElementById(`q-options-${qIndex}`);
                container.querySelectorAll('.option-item').forEach(el => {
                    el.classList.remove('selected', 'border-indigo-600', 'dark:border-indigo-400', 'bg-indigo-50', 'dark:bg-indigo-900/30');
                    el.querySelector('.option-radio').classList.remove('border-indigo-600', 'dark:border-indigo-400');
                    el.querySelector('.option-radio div').classList.add('hidden');
                });
                const selected = container.querySelector(`.option-item[data-idx="${altIndex}"]`);
                if(selected && !selected.classList.contains('strikethrough')) {
                    selected.classList.add('selected', 'border-indigo-600', 'dark:border-indigo-400', 'bg-indigo-50', 'dark:bg-indigo-900/30');
                    selected.querySelector('.option-radio').classList.add('border-indigo-600', 'dark:border-indigo-400');
                    selected.querySelector('.option-radio div').classList.remove('hidden');
                }
            },

            verificarResposta: function(qIndex) {
                const container = document.getElementById(`q-options-${qIndex}`);
                const selected = container.querySelector('.option-item.selected');
                if (!selected) return alert("Selecione uma alternativa.");
                
                const isCorrect = selected.getAttribute('data-correct') === 'true';
                const btn = document.getElementById(`btn-responder-${qIndex}`);
                
                btn.disabled = true;
                btn.textContent = isCorrect ? "Correto" : "Incorreto";
                btn.className = `w-full sm:w-auto font-semibold py-2 px-6 rounded-lg transition text-white ${isCorrect ? 'bg-green-600' : 'bg-red-600'}`;

                container.querySelectorAll('.option-item').forEach(el => {
                    const correctAttr = el.getAttribute('data-correct') === 'true';
                    if (correctAttr) {
                        el.classList.add('border-green-500', 'bg-green-50', 'dark:bg-green-900/20', 'dark:border-green-500');
                        el.querySelector('.feedback').classList.remove('hidden');
                        el.querySelector('.feedback').classList.add('text-green-700', 'dark:text-green-400');
                    } else if (el.classList.contains('selected') && !isCorrect) {
                        el.classList.add('border-red-500', 'bg-red-50', 'dark:bg-red-900/20', 'dark:border-red-500');
                        el.querySelector('.feedback').classList.remove('hidden');
                        el.querySelector('.feedback').classList.add('text-red-700', 'dark:text-red-400');
                    }
                });
                document.getElementById(`resolucao-${qIndex}`).classList.remove('hidden');
            },

            handleRedacao: async function(tipo) {
                const input = document.getElementById('redacao-theme');
                const output = document.getElementById('redacao-output');
                const texto = document.getElementById('redacao-paragraph').value;
                output.classList.remove('hidden');
                output.innerHTML = this.getLoadingSpinner("Processando...");
                
                let prompt = "";
                const tema = input.value;
                if (tipo === 'tema') prompt = "Gere um tema de redação ENEM.";
                else if (tipo === 'repertorio') { if(!tema) return alert("Tema?"); prompt = `Repertório para: ${tema}`; }
                else if (tipo === 'esboco') { if(!tema) return alert("Tema?"); prompt = `Esboço para: ${tema}`; }
                else if (tipo === 'analise') { if(!texto) return alert("Texto?"); prompt = `Analise parágrafo: ${texto}`; }

                try {
                    let res = await this.callAPI(prompt, false);
                    res = res.replace(/```html/g, '').replace(/```/g, '');
                    if (tipo === 'tema') { input.value = res.replace(/["\n]/g, ''); output.classList.add('hidden'); }
                    else output.innerHTML = res;
                } catch (e) { output.innerHTML = `Erro: ${e.message}`; }
            },

            setupNavigation: function() {
                document.querySelectorAll('.nav-link').forEach(l => {
                    l.onclick = (e) => { e.preventDefault(); this.navigateTo(l.getAttribute('data-target')); };
                });
            },
            setupMobileMenu: function() {
                const menu = document.getElementById('mobile-menu');
                document.getElementById('mobile-menu-btn').onclick = () => menu.classList.toggle('hidden');
            },
            navigateTo: function(id) {
                document.querySelectorAll('.content-section').forEach(el => { el.classList.remove('active'); el.style.display = 'none'; });
                const t = document.getElementById(id);
                if(t) { t.style.display = 'block'; setTimeout(() => t.classList.add('active'), 10); }
                window.scrollTo(0,0);
            },
            
            renderMateriasGrid: function() {
                const grid = document.getElementById('materias-grid');
                if(grid) grid.innerHTML = this.db.materias.map(m => `<div class="p-6 rounded-lg shadow-sm border cursor-pointer flex flex-col items-center hover:shadow-md transition ${m.cor} dark:border-gray-700" onclick="window.app.openMateria('${m.id}')"><i data-lucide="${m.icone}" class="h-10 w-10 mb-3"></i><h3 class="font-bold text-lg">${m.nome}</h3></div>`).join('');
                lucide.createIcons();
            },
            
            openMateria: function(id) {
                const m = this.db.materias.find(x => x.id === id);
                if(!m) return;
                const detail = document.getElementById('materia-detalhe');
                document.getElementById('materias-home').classList.add('hidden');
                detail.classList.remove('hidden');
                
                detail.innerHTML = `
                    <div class="max-w-5xl mx-auto">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <button onclick="document.getElementById('materia-detalhe').classList.add('hidden'); document.getElementById('materias-home').classList.remove('hidden');" class="text-indigo-600 dark:text-indigo-400 font-bold flex items-center gap-2 hover:underline">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i> Voltar
                            </button>
                            <h2 class="text-3xl font-bold dark:text-white">${m.nome}</h2>
                            
                            <!-- Barra de Pesquisa Interna -->
                            <div class="relative w-full md:w-72">
                                <input type="text" placeholder="Buscar neste caderno..." class="w-full p-2 pl-10 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none transition" oninput="window.app.filterSubjectContents(this.value)">
                                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                            </div>
                        </div>

                        <div id="materia-conteudos-container" class="space-y-8">
                            ${m.frentes.map(f => `
                                <div class="materia-frente">
                                    <h3 class="text-2xl font-bold border-b pb-2 mb-4 dark:text-gray-200 dark:border-gray-600">${f.nome}</h3>
                                    <div class="grid gap-4">
                                        ${f.modulos.map(mod => `
                                            <div class="materia-modulo bg-white dark:bg-gray-800 p-5 rounded-lg border dark:border-gray-700">
                                                <h4 class="font-bold text-lg text-indigo-600 dark:text-indigo-400 mb-3">${mod.nome}</h4>
                                                <div class="space-y-2">
                                                    ${mod.assuntos.map(a => `
                                                        <div class="materia-assunto border-t pt-2 dark:border-gray-700">
                                                            <div class="font-medium dark:text-gray-300">${a.nome}</div>
                                                            ${a.subconteudos ? 
                                                                `<div class="pl-4 mt-2 space-y-2 border-l-2 border-indigo-100 dark:border-gray-700">
                                                                    ${a.subconteudos.map(s => `
                                                                        <div class="materia-subconteudo">
                                                                            <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">${s.nome}</div>
                                                                            <div class="flex flex-wrap gap-2">
                                                                                <button onclick="window.app.generateContent('${m.nome}', '${s.nome}', 'resumo', 'res-${s.id}')" class="text-xs bg-indigo-50 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-200 px-3 py-1 rounded hover:bg-indigo-100 transition">Resumo</button>
                                                                                <button onclick="window.app.generateContent('${m.nome}', '${s.nome}', 'explicacao', 'res-${s.id}')" class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded hover:bg-gray-50 transition">Aula</button>
                                                                                <button onclick="window.app.generateContent('${m.nome}', '${s.nome}', 'completo', 'res-${s.id}')" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 transition">Completo</button>
                                                                            </div>
                                                                            <div id="res-${s.id}" class="mt-2 text-gray-700 dark:text-gray-300 text-sm leading-relaxed prose max-w-none"></div>
                                                                        </div>
                                                                    `).join('')}
                                                                </div>` 
                                                                : 
                                                                `<div class="flex gap-2 mt-2">
                                                                    <button onclick="window.app.generateContent('${m.nome}', '${a.nome}', 'resumo', 'res-${a.id}')" class="text-xs bg-indigo-50 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-200 px-3 py-1 rounded hover:bg-indigo-100 transition">Resumo</button>
                                                                    <button onclick="window.app.generateContent('${m.nome}', '${a.nome}', 'explicacao', 'res-${a.id}')" class="text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-1 rounded hover:bg-gray-50 transition">Aula</button>
                                                                    <button onclick="window.app.generateContent('${m.nome}', '${a.nome}', 'completo', 'res-${a.id}')" class="text-xs bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 transition">Completo</button>
                                                                </div>
                                                                <div id="res-${a.id}" class="mt-2 text-gray-700 dark:text-gray-300 text-sm leading-relaxed prose max-w-none"></div>`
                                                            }
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                if(typeof lucide !== 'undefined') lucide.createIcons();
                window.scrollTo(0,0);
            },

            // Filtro da tela inicial de matérias
            filterSubjects: function(term) {
                const t = term.toLowerCase().trim();
                const grid = document.getElementById('materias-grid');
                if (!grid) return;
                
                const cards = grid.children;
                for (let card of cards) {
                    const title = card.querySelector('h3');
                    if (title) {
                        const name = title.textContent.toLowerCase();
                        if (name.includes(t)) {
                            card.classList.remove('hidden');
                        } else {
                            card.classList.add('hidden');
                        }
                    }
                }
            },

            // Filtro do conteúdo dentro de uma matéria
            filterSubjectContents: function(term) {
                const t = term.toLowerCase().trim();
                const container = document.getElementById('materia-conteudos-container');
                if (!container) return;

                const frentes = container.querySelectorAll('.materia-frente');

                frentes.forEach(frente => {
                    let frenteVisible = false;
                    const modulos = frente.querySelectorAll('.materia-modulo');

                    modulos.forEach(modulo => {
                        let moduloVisible = false;
                        const assuntos = modulo.querySelectorAll('.materia-assunto');

                        assuntos.forEach(assunto => {
                            const text = assunto.textContent.toLowerCase();
                            if (text.includes(t)) {
                                assunto.classList.remove('hidden');
                                moduloVisible = true;
                                if (t.length > 0) {
                                    const contentDiv = assunto.querySelector('div[id^="cont-"]');
                                    if (contentDiv) contentDiv.classList.remove('hidden');
                                }
                            } else {
                                assunto.classList.add('hidden');
                            }
                        });

                        if (moduloVisible) {
                            modulo.classList.remove('hidden');
                            frenteVisible = true;
                        } else {
                            modulo.classList.add('hidden');
                        }
                    });

                    if (frenteVisible) {
                        frente.classList.remove('hidden');
                    } else {
                        frente.classList.add('hidden');
                    }
                });
            },

            buildSearchIndex: function() {
                this.searchIndex = [];
                this.db.materias.forEach(m => m.frentes.forEach(f => f.modulos.forEach(mod => mod.assuntos.forEach(a => {
                    this.searchIndex.push({
                        label: a.nome,
                        type: 'Conteúdo',
                        context: m.nome,
                        data: { materiaId: m.id, conteudoId: a.id, subId: '' }
                    });
                    if (a.subconteudos) {
                        a.subconteudos.forEach(s => {
                            this.searchIndex.push({
                                label: s.nome,
                                type: 'Sub-conteúdo',
                                context: `${m.nome} > ${a.nome}`,
                                data: { materiaId: m.id, conteudoId: a.id, subId: s.nome } 
                            });
                        });
                    }
                }))));
            },
            
            selectSearch: function(data, label) {
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('search-topic').value = label;
                const disc = document.getElementById('filtro-disciplina');
                disc.value = data.materiaId;
                disc.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    const cont = document.getElementById('filtro-conteudo');
                    cont.value = data.conteudoId;
                    cont.dispatchEvent(new Event('change'));
                    
                    if(data.subId) {
                        setTimeout(() => {
                            const sub = document.getElementById('filtro-subconteudo');
                            sub.value = data.subId;
                        }, 50);
                    }
                }, 50);
            },

            setupSearch: function() {
                const input = document.getElementById('search-topic');
                const res = document.getElementById('search-results');
                input.addEventListener('input', (e) => {
                    const val = e.target.value.toLowerCase();
                    if(val.length < 2) { res.classList.add('hidden'); return; }
                    const hits = this.searchIndex.filter(i => i.label.toLowerCase().includes(val)).slice(0,5);
                    if(hits.length) {
                        res.innerHTML = hits.map(i => `<div class="p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer border-b dark:border-gray-700 transition-colors flex flex-col" onclick='window.app.selectSearchResult(${JSON.stringify(i.data)}, "${i.label}")'><span class="font-medium text-gray-800 dark:text-gray-200">${i.label}</span><span class="text-xs text-gray-500 dark:text-gray-400">${i.type} em ${i.context}</span></div>`).join('');
                        res.classList.remove('hidden');
                    } else {
                        res.innerHTML = `<div class="p-3 text-sm text-gray-500 text-center">Nenhum conteúdo encontrado.</div>`;
                        res.classList.remove('hidden');
                    }
                });
                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !res.contains(e.target)) res.classList.add('hidden');
                });
                document.getElementById('clear-search').onclick = () => {
                    input.value = '';
                    res.classList.add('hidden');
                };
            },
            
            clearQuestions: function() {
                if(confirm('Deseja apagar todas as questões geradas?')) {
                    this.db.questoes = [];
                    localStorage.removeItem(this.CACHE_PREFIX + 'questoes');
                    document.getElementById('questoes-list').innerHTML = `<div id="questoes-placeholder" class="text-center text-gray-500 py-12"><i data-lucide="book-open" class="mx-auto h-12 w-12 mb-3"></i><p>Inicie a geração.</p></div><div id="loading-indicator" class="hidden text-center py-8"><div class="inline-block animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full"></div></div>`;
                    lucide.createIcons();
                }
            }
        };

        window.app = app;
        window.onload = () => app.init();
    </script>
</body>
</html>
