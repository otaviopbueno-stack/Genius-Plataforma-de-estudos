<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsFlow - Plataforma de Estudos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Ícones -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Matemática (KaTeX) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        :root { --primary-color: #4338ca; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; color: #1f2937; }
        .nav-link.active { color: var(--primary-color); position: relative; }
        .nav-link.active::after { content: ''; position: absolute; width: 100%; height: 2px; bottom: -4px; left: 0; background-color: var(--primary-color); }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Utilitários */
        .option-item.selected { border-color: #4f46e5; background-color: #eef2ff; }
        .option-item.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .option-item.wrong { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        
        #search-results {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        #search-results::-webkit-scrollbar { width: 6px; }
        #search-results::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="text-gray-800">

    <!-- HEADER -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 h-16 flex items-center justify-between">
            <a href="#" class="text-2xl font-bold text-indigo-600" onclick="window.app.navigateTo('inicio')">InsFlow</a>
            
            <div class="hidden md:flex space-x-8">
                <a href="#" class="nav-link active" data-target="inicio">Início</a>
                <a href="#" class="nav-link" data-target="materias">Matérias</a>
                <a href="#" class="nav-link" data-target="questoes">Questões</a>
                <a href="#" class="nav-link" data-target="redacao">Redação</a>
            </div>

            <button id="mobile-menu-btn" class="md:hidden text-gray-600"><i data-lucide="menu"></i></button>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t p-4 space-y-2 shadow-lg">
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 rounded" onclick="window.app.navigateTo('inicio')">Início</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 rounded" onclick="window.app.navigateTo('materias')">Matérias</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 rounded" onclick="window.app.navigateTo('questoes')">Questões</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 rounded" onclick="window.app.navigateTo('redacao')">Redação</a>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto px-4 py-8 md:py-12">
        
        <!-- 1. INÍCIO -->
        <section id="inicio" class="content-section active">
            <div class="text-center py-16 md:py-24 bg-gradient-to-b from-blue-50 to-white rounded-2xl shadow-sm border border-blue-100">
                <h1 class="text-4xl md:text-6xl font-bold text-indigo-600 mb-6">Bem-vindo ao InsFlow</h1>
                <p class="text-lg md:text-xl text-gray-600 mb-8 max-w-2xl mx-auto">A sua plataforma inteligente para dominar o ENEM e Vestibulares. Estude com resumos, pratique com questões e aperfeiçoe a sua redação.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button class="bg-indigo-600 text-white py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 font-semibold transition" onclick="window.app.navigateTo('materias')">
                        Explorar Matérias
                    </button>
                    <button class="bg-white text-gray-800 border border-gray-200 py-3 px-8 rounded-lg shadow hover:bg-gray-50 font-semibold transition" onclick="window.app.navigateTo('questoes')">
                        Praticar Questões
                    </button>
                </div>
            </div>
        </section>

        <!-- 2. MATÉRIAS -->
        <section id="materias" class="content-section">
            <div id="materias-home">
                <h2 class="text-3xl font-bold mb-8 text-center text-gray-800">Matérias</h2>
                <div id="materias-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
            </div>
            <div id="materia-detalhe" class="hidden"></div>
        </section>

        <!-- 3. QUESTÕES -->
        <section id="questoes" class="content-section">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-4 text-center text-gray-800">Gerador de Questões</h2>
                
                <!-- BARRA DE PESQUISA INTELIGENTE -->
                <div class="mb-6 relative z-20">
                    <div class="relative">
                        <input type="text" id="search-topic" autocomplete="off" class="w-full p-4 pl-12 rounded-xl border border-gray-200 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Pesquise um tópico do banco de dados (ex: Logaritmos)...">
                        <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                        <button id="clear-search" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="search-results" class="absolute w-full bg-white mt-2 rounded-xl shadow-xl border border-gray-100 hidden overflow-hidden"></div>
                </div>

                <!-- FILTROS -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-8 relative z-10">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Disciplina</label>
                            <select id="filtro-disciplina" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Conteúdo</label>
                            <select id="filtro-conteudo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white" disabled>
                                <option value="">Selecione a Disciplina</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sub-conteúdo</label>
                            <select id="filtro-subconteudo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white" disabled>
                                <option value="">Selecione o Conteúdo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dificuldade</label>
                            <select id="filtro-dificuldade" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white font-medium text-gray-700">
                                <option value="medio" selected>Médio (Padrão ENEM)</option>
                                <option value="facil">Fácil (Conceitual)</option>
                                <option value="dificil">Difícil (Desafiador)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="btn-gerar-questoes" class="flex-1 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed shadow-md flex items-center justify-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> Gerar 5 Novas Questões
                        </button>
                        <button onclick="window.app.clearQuestions()" class="bg-gray-100 text-gray-600 font-bold py-3 px-4 rounded-lg hover:bg-gray-200 transition border border-gray-200" title="Limpar lista">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div id="questoes-list" class="space-y-6 pb-12">
                    <div id="questoes-placeholder" class="text-center text-gray-500 py-12 bg-white rounded-xl border border-dashed border-gray-300">
                        <i data-lucide="book-open" class="mx-auto h-12 w-12 text-gray-400 mb-3"></i>
                        <p>Selecione uma disciplina para começar.</p>
                    </div>
                </div>
                
                <div id="loading-indicator" class="hidden text-center py-8">
                    <div class="inline-block animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-4"></div>
                    <p class="text-gray-500 animate-pulse" id="loading-text">Criando questões inéditas...</p>
                </div>
            </div>
        </section>

        <!-- 4. REDAÇÃO -->
        <section id="redacao" class="content-section">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Assistente de Redação</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <div class="mb-6">
                        <label class="block text-gray-700 font-bold mb-2">Tema da Redação</label>
                        <div class="flex gap-2">
                            <input type="text" id="redacao-theme" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ex: Desafios da educação digital no Brasil">
                            <button onclick="window.app.handleRedacao('tema')" class="bg-gray-100 p-3 rounded-lg hover:bg-gray-200 border border-gray-300 transition"><i data-lucide="shuffle" class="text-gray-600"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <button onclick="window.app.handleRedacao('repertorio')" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-medium transition flex items-center justify-center gap-2"><i data-lucide="library"></i> Gerar Repertório</button>
                        <button onclick="window.app.handleRedacao('esboco')" class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 font-medium transition flex items-center justify-center gap-2"><i data-lucide="list"></i> Criar Esboço</button>
                    </div>
                    <div class="border-t pt-4">
                        <label class="block text-gray-700 font-bold mb-2">Analisar Parágrafo</label>
                        <textarea id="redacao-paragraph" rows="4" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 mb-2" placeholder="Cole o seu parágrafo aqui..."></textarea>
                        <button onclick="window.app.handleRedacao('analise')" class="w-full bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 font-medium transition">Analisar e Melhorar</button>
                    </div>
                    <div id="redacao-output" class="mt-6 p-6 bg-gray-50 rounded-lg min-h-[100px] text-gray-700 border border-gray-200 hidden"></div>
                </div>
            </div>
        </section>
    </main>
    
    <script type="module">
        // =================================================================
        // ⚠️ CONFIGURAÇÃO (HÍBRIDA) ⚠️
        // A chave não fica aqui. O app tentará usar o backend (/api/chat).
        // =================================================================
        let API_KEY = ""; 

        const app = {
            CACHE_PREFIX: 'insflow-full-',
            
            // --- BASE DE DADOS COMPLETA ---
            db: {
                materias: [
                    {
                        id: 'matematica',
                        nome: 'Matemática',
                        icone: 'calculator', 
                        cor: 'bg-red-50 text-red-700 border-red-200',
                        frentes: [
                            { 
                                nome: 'Matemática Básica e Álgebra',
                                modulos: [
                                    { nome: 'Módulo 1: Fundamentos', assuntos: [{id: 'operacoes-numericas', nome: 'Operações Numéricas', subconteudos: [{id: 'basicas', nome: '4 Operações Básicas'}, {id: 'pot-rad', nome: 'Potenciação e Radiciação'}]}, {id: 'razoes-proporcoes', nome: 'Razões e Proporções', subconteudos: [{id: 'razao-prop', nome: 'Razão e Proporção'}, {id: 'escalas', nome: 'Escalas e Grandezas'}]}, {id: 'regra-de-tres', nome: 'Regra de Três', subconteudos: [{id: 'regra-tres-simples', nome: 'Simples'}, {id: 'regra-tres-composta', nome: 'Composta'}]}, {id: 'porcentagem', nome: 'Porcentagem', subconteudos: [{id: 'calc-porcentagem', nome: 'Cálculos Básicos'}, {id: 'acresc-descontos', nome: 'Acréscimos e Descontos'}]}]},
                                    { nome: 'Módulo 2: Funções', assuntos: [{id: 'funcao-afim', nome: 'Função Afim'},{id: 'funcao-quadratica', nome: 'Função Quadrática', subconteudos: [{id: 'graf-parabola', nome: 'Gráfico (Parábola)'}, {id: 'vertice-max-min', nome: 'Vértice (Máximos e Mínimos)'}, {id: 'raizes-bhaskara', nome: 'Raízes (Bhaskara)'}]}, {id: 'funcao-modular', nome: 'Função Modular'},{id: 'funcao-composta-inversa', nome: 'Função Composta e Inversa'}]},
                                    { nome: 'Módulo 3: Funções Transcendentais', assuntos: [{id: 'funcao-exponencial', nome: 'Função Exponencial', subconteudos: [{id: 'eq-exp', nome: 'Equações Exponenciais'}, {id: 'ineq-exp', nome: 'Inequações Exponenciais'}]}, {id: 'funcao-logaritmica', nome: 'Função Logarítmica', subconteudos: [{id: 'prop-log', nome: 'Propriedades dos Logaritmos'}, {id: 'eq-log', nome: 'Equações Logarítmicas'}]}]},
                                    { nome: 'Módulo 4: Álgebra Avançada', assuntos: [{id: 'polinomios', nome: 'Polinômios'},{id: 'equacoes', nome: 'Equações Algébricas'},{id: 'sistemas-equacoes', nome: 'Sistemas Lineares'},{id: 'numeros-complexos', nome: 'Números Complexos'},{id: 'matrizes-determinantes', nome: 'Matrizes e Determinantes', subconteudos: [{id: 'op-matrizes', nome: 'Operações com Matrizes'}, {id: 'calc-determinantes', nome: 'Cálculo de Determinantes'}]}]}
                                ]
                            },
                            {
                                nome: 'Geometria e Trigonometria',
                                modulos: [
                                    { nome: 'Módulo 1: Geometria Plana', assuntos: [{id: 'angulos-poligonos', nome: 'Ângulos e Polígonos'},{id: 'triangulos-quadrilateros', nome: 'Triângulos e Quadriláteros', subconteudos: [{id: 'semelhanca-tri', nome: 'Semelhança de Triângulos'}, {id: 'rel-met-tri-ret', nome: 'Relações Métricas no Triângulo Retângulo'}]}, {id: 'circulo-circunferencia', nome: 'Círculo e Circunferência'},{id: 'areas-figuras-planas', nome: 'Áreas de Figuras Planas'}]},
                                    { nome: 'Módulo 2: Geometria Espacial', assuntos: [
                                        {id: 'poliedros', nome: 'Poliedros', subconteudos: [{id: 'relacao-euler', nome: 'Relação de Euler'}, {id: 'poliedros-platao', nome: 'Poliedros de Platão'}, {id: 'elementos-poliedros', nome: 'Elementos (Faces, Vértices, Arestas)'}, {id: 'volume-poliedros', nome: 'Volume de Poliedros'}]},
                                        {id: 'prismas-piramides', nome: 'Prismas e Pirâmides', subconteudos: [{id: 'areas-prismas-piramides', nome: 'Áreas de Prismas e Pirâmides'}, {id: 'volumes-prismas-piramides', nome: 'Volumes de Prismas e Pirâmides'}]}, 
                                        {id: 'cilindros-cones', nome: 'Cilindros e Cones', subconteudos: [{id: 'areas-cilindros-cones', nome: 'Áreas de Cilindros e Cones'}, {id: 'volumes-cilindros-cones', nome: 'Volumes de Cilindros e Cones'}]}, 
                                        {id: 'esferas', nome: 'Esferas', subconteudos: [{id: 'area-volume-esfera', nome: 'Área e Volume da Esfera'}]}
                                    ]},
                                    { nome: 'Módulo 3: Geometria Analítica', assuntos: [{id: 'ponto-reta-circunferencia', nome: 'Ponto, Reta e Circunferência', subconteudos: [{id: 'estudo-ponto', nome: 'Estudo do Ponto'}, {id: 'estudo-reta', nome: 'Estudo da Reta'}, {id: 'estudo-circunferencia', nome: 'Estudo da Circunferência'}]}, {id: 'conicas', nome: 'Cônicas'}]},
                                    { nome: 'Módulo 4: Trigonometria', assuntos: [{id: 'razoes-trigonometricas', nome: 'Razões Trigonométricas no Triângulo Retângulo'},{id: 'ciclo-funcoes-trig', nome: 'Ciclo e Funções Trigonométricas', subconteudos: [{id: 'ciclo-trig', nome: 'Ciclo Trigonométrico'}, {id: 'funcoes-sen-cos-tan', nome: 'Funções Trigonométricas'}]}, {id: 'leis-seno-cosseno', nome: 'Leis do Seno e do Cosseno'}]}
                                ]
                            },
                            {
                                nome: 'Estatística e Lógica',
                                modulos: [
                                    { nome: 'Módulo 1: Análise de Dados', assuntos: [{id: 'analise-combinatoria', nome: 'Análise Combinatória', subconteudos: [{id: 'pfc', nome: 'Princípio Fundamental da Contagem'}, {id: 'arr-perm-comb', nome: 'Arranjo, Permutação e Combinação'}]}, {id: 'probabilidade', nome: 'Probabilidade'},{id: 'estatistica-descritiva', nome: 'Estatística Descritiva', subconteudos: [{id: 'medidas-tend-central', nome: 'Medidas de Tendência Central'}, {id: 'medidas-dispersao', nome: 'Medidas de Dispersão'}]}]},
                                    { nome: 'Módulo 2: Matemática Financeira e Sequências', assuntos: [{id: 'juros', nome: 'Juros Simples e Compostos'},{id: 'pa-pg', nome: 'Progressões (PA e PG)'},{id: 'sequencias-numericas', nome: 'Sequências Numéricas'},{id: 'raciocinio-logico', nome: 'Raciocínio Lógico'}]}
                                ]
                            }
                        ]
                    },
                    { 
                        id: 'fisica', 
                        nome: 'Física', 
                        icone: 'atom',
                        cor: 'bg-blue-50 text-blue-700 border-blue-200',
                        frentes: [
                            {
                                nome: 'Mecânica',
                                modulos: [
                                    { nome: 'Módulo 1: Cinemática', assuntos: [{id: 'cinematica', nome: 'Cinemática', subconteudos: [{id: 'mru', nome: 'MRU'}, {id: 'mruv', nome: 'MRUV'}, {id: 'mov-circular', nome: 'Movimento Circular'}]}]},
                                    { nome: 'Módulo 2: Leis de Newton e Dinâmica', assuntos: [{id: 'leis-newton', nome: 'Leis de Newton', subconteudos: [{id: 'primeira-lei', nome: '1ª Lei (Inércia)'}, {id: 'segunda-lei', nome: '2ª Lei (Princípio Fundamental)'}, {id: 'terceira-lei', nome: '3ª Lei (Ação e Reação)'}, {id: 'forcas', nome: 'Forças Fundamentais'}]}]},
                                    { nome: 'Módulo 3: Trabalho, Energia e Potência', assuntos: [{id: 'trabalho-energia-potencia', nome: 'Trabalho, Energia e Potência', subconteudos: [{id: 'trab-forca', nome: 'Trabalho de uma Força'}, {id: 'energia-cin-pot', nome: 'Energia Cinética e Potencial'}, {id: 'conservacao-energia', nome: 'Conservação de Energia'}]}]},
                                    { nome: 'Módulo 4: Impulso e Quantidade de Movimento', assuntos: [{id: 'impulso-quantidade-movimento', nome: 'Impulso e Colisões'}]},
                                    { nome: 'Módulo 5: Estática e Hidrostática', assuntos: [{id: 'estatica-hidrostatica', nome: 'Estática e Hidrostática', subconteudos: [{id: 'equilibrio-corpos', nome: 'Equilíbrio de Corpos'}, {id: 'empuxo-pascal', nome: 'Princípios de Pascal, Arquimedes e Stevin'}]}]},
                                    { nome: 'Módulo 6: Gravitação Universal', assuntos: [{id: 'gravitacao-universal', nome: 'Gravitação Universal', subconteudos: [{id: 'leis-kepler', nome: 'Leis de Kepler'}, {id: 'lei-grav-newton', nome: 'Lei da Gravitação de Newton'}]}]}
                                ]
                            },
                            {
                                nome: 'Termologia e Óptica',
                                modulos: [
                                    { nome: 'Módulo 1: Termometria e Calorimetria', assuntos: [{id: 'termometria-calorimetria', nome: 'Termometria e Calorimetria', subconteudos: [{id: 'escalas-term', nome: 'Escalas Termométricas'}, {id: 'calor-sens-lat', nome: 'Calor Sensível e Latente'}, {id: 'transm-calor', nome: 'Transmissão de Calor'}]}]},
                                    { nome: 'Módulo 2: Termodinâmica e Gases', assuntos: [{id: 'termodinamica-gases', nome: 'Termodinâmica e Gases', subconteudos: [{id: 'gases-ideais', nome: 'Gases Ideais'}, {id: 'leis-termo', nome: 'Leis da Termodinâmica'}]}]},
                                    { nome: 'Módulo 3: Óptica Geométrica', assuntos: [{id: 'optica-geometrica', nome: 'Óptica Geométrica', subconteudos: [{id: 'reflexao-espelhos', nome: 'Reflexão e Espelhos'}, {id: 'refracao-lentes', nome: 'Refração e Lentes'}]}]}
                                ]
                            },
                            {
                                nome: 'Ondulatória e Eletromagnetismo',
                                modulos: [
                                    { nome: 'Módulo 1: Ondulatória', assuntos: [{id: 'ondulatoria', nome: 'Ondulatória', subconteudos: [{id: 'fen-ondul', nome: 'Fenômenos Ondulatórios'}, {id: 'acustica', nome: 'Acústica'}]}]},
                                    { nome: 'Módulo 2: Eletrostática', assuntos: [{id: 'eletrostatica', nome: 'Eletrostática'}]},
                                    { nome: 'Módulo 3: Eletrodinâmica', assuntos: [{id: 'eletrodinamica', nome: 'Eletrodinâmica', subconteudos: [{id: 'corrente-resist', nome: 'Corrente e Resistores'}, {id: 'circuitos', nome: 'Circuitos Elétricos'}, {id: 'pot-ele', nome: 'Potência Elétrica'}]}]},
                                    { nome: 'Módulo 4: Magnetismo e Eletromagnetismo', assuntos: [{id: 'magnetismo-eletromagnetismo', nome: 'Magnetismo e Eletromagnetismo', subconteudos: [{id: 'campo-magnetico', nome: 'Campo Magnético'}, {id: 'forca-magnetica', nome: 'Força Magnética'}, {id: 'inducao-eletromagnetica', nome: 'Indução Eletromagnética'}]}]},
                                    { nome: 'Módulo 5: Física Moderna', assuntos: [{id: 'fisica-moderna', nome: 'Física Moderna'}]}
                                ]
                            }
                        ]
                    },
                    {
                        id: 'quimica',
                        nome: 'Química',
                        icone: 'flask-conical',
                        cor: 'bg-purple-50 text-purple-700 border-purple-200',
                        frentes: [
                             {
                                nome: 'Química Geral',
                                modulos: [
                                    { nome: 'Módulo 1: Estrutura da Matéria', assuntos: [{id: 'estrutura-atomica', nome: 'Estrutura atômica', subconteudos: [{id: 'modelos-atom', nome: 'Modelos Atômicos'}, {id: 'dist-eletronica', nome: 'Distribuição Eletrônica'}]}]},
                                    { nome: 'Módulo 2: Tabela Periódica e Propriedades', assuntos: [{id: 'tabela-periodica', nome: 'Tabela Periódica', subconteudos: [{id: 'org-tabela', nome: 'Organização da Tabela'}, {id: 'prop-period', nome: 'Propriedades Periódicas'}]}]},
                                    { nome: 'Módulo 3: Ligações e Interações', assuntos: [{id: 'ligacoes-quimicas', nome: 'Ligações Químicas e Geometria Molecular', subconteudos: [{id: 'lig-ion-cov-met', nome: 'Iônica, Covalente e Metálica'}, {id: 'intermoleculares', nome: 'Forças Intermoleculares'}]}]},
                                    { nome: 'Módulo 4: Funções Inorgânicas', assuntos: [{id: 'funcoes-inorganicas', nome: 'Funções Inorgânicas', subconteudos: [{id: 'acidos', nome: 'Ácidos'}, {id: 'bases', nome: 'Bases'}, {id: 'sais', nome: 'Sais'}, {id: 'oxidos', nome: 'Óxidos'}]}]},
                                    { nome: 'Módulo 5: Radioatividade', assuntos: [{id: 'radioatividade', nome: 'Radioatividade', subconteudos: [{id: 'leis-radioatividade', nome: 'Leis da Radioatividade'}, {id: 'meia-vida', nome: 'Meia-vida'}]}]}
                                ]
                            },
                            {
                                nome: 'Físico-Química',
                                modulos: [
                                    { nome: 'Módulo 1: Cálculos e Soluções', assuntos: [{id: 'estequiometria', nome: 'Estequiometria', subconteudos: [{id: 'leis-ponderais', nome: 'Leis Ponderais'}, {id: 'calculos-esteq', nome: 'Cálculos Estequiométricos'}]}, {id: 'solucoes', nome: 'Soluções', subconteudos: [{id: 'concentracoes', nome: 'Concentrações'}, {id: 'prop-coligativas', nome: 'Propriedades Coligativas'}]}]},
                                    { nome: 'Módulo 2: Termoquímica', assuntos: [{id: 'termoquimica', nome: 'Termoquímica', subconteudos: [{id: 'entalpia', nome: 'Entalpia'}, {id: 'lei-hess', nome: 'Lei de Hess'}]}]},
                                    { nome: 'Módulo 3: Cinética e Equilíbrio', assuntos: [{id: 'cinetica-quimica', nome: 'Cinética Química', subconteudos: [{id: 'velocidade-reacoes', nome: 'Velocidade das Reações'}, {id: 'fatores-velocidade', nome: 'Fatores que afetam a velocidade'}]}, {id: 'equilibrio-quimico', nome: 'Equilíbrio Químico e Iônico', subconteudos: [{id: 'keq-ph-poh', nome: 'Keq, pH e pOH'}, {id: 'desloc-equilibrio', nome: 'Deslocamento de Equilíbrio'}]}]},
                                    { nome: 'Módulo 4: Eletroquímica', assuntos: [{id: 'eletroquimica', nome: 'Eletroquímica e Oxirredução', subconteudos: [{id: 'pilhas', nome: 'Pilhas'}, {id: 'eletrolise', nome: 'Eletrólise'}]}]}
                                ]
                            },
                            {
                                nome: 'Química Orgânica',
                                modulos: [
                                    { nome: 'Módulo 1: Introdução e Hidrocarbonetos', assuntos: [{id: 'intro-organica', nome: 'Introdução à Química Orgânica', subconteudos: [{id: 'class-carbono', nome: 'Classificação do Carbono'}, {id: 'class-cadeias', nome: 'Classificação de Cadeias'}]}]},
                                    { nome: 'Módulo 2: Funções Orgânicas', assuntos: [{id: 'funcoes-organicas', nome: 'Funções Orgânicas', subconteudos: [{id: 'funcoes-oxigenadas', nome: 'Funções Oxigenadas'}, {id: 'funcoes-nitrogenadas', nome: 'Funções Nitrogenadas'}]}]},
                                    { nome: 'Módulo 3: Isomeria', assuntos: [{id: 'isomeria', nome: 'Isomeria', subconteudos: [{id: 'isomeria-plana', nome: 'Isomeria Plana'}, {id: 'isomeria-espacial', nome: 'Isomeria Espacial'}]}]},
                                    { nome: 'Módulo 4: Reações Orgânicas', assuntos: [{id: 'reacoes-organicas', nome: 'Reações Orgânicas', subconteudos: [{id: 'reacoes-adicao', nome: 'Reações de Adição'}, {id: 'reacoes-substituicao', nome: 'Reações de Substituição'}, {id: 'reacoes-eliminacao', nome: 'Reações de Eliminação'}]}]},
                                    { nome: 'Módulo 5: Macromoléculas', assuntos: [{id: 'polimeros-bioquimica', nome: 'Polímeros e Bioquímica', subconteudos: [{id: 'polimeros', nome: 'Polímeros'}, {id: 'biomoleculas', nome: 'Carboidratos, Lipídios e Proteínas'}]}]}
                                ]
                            }
                        ]
                    },
                    { 
                        id: 'biologia', 
                        nome: 'Biologia', 
                        icone: 'leaf', 
                        cor: 'bg-green-50 text-green-700 border-green-200', 
                        frentes: [
                            {
                                nome: 'Base da Vida',
                                modulos: [
                                    { nome: 'Módulo 1: Origem da Vida e Bioquímica', assuntos: [{id: 'origem-vida-bioquimica', nome: 'Origem da Vida e Bioquímica'}]},
                                    { nome: 'Módulo 2: Citologia', assuntos: [{id: 'citologia', nome: 'Citologia', subconteudos: [{id: 'organelas', nome: 'Organelas'}, {id: 'metabolismo-cel', nome: 'Metabolismo Celular'}, {id: 'divisao-cel', nome: 'Divisão Celular'}]}]},
                                    { nome: 'Módulo 3: Biologia Molecular', assuntos: [{id: 'biologia-molecular', nome: 'Biologia Molecular'}]},
                                    { nome: 'Módulo 4: Histologia e Embriologia', assuntos: [{id: 'histologia-embriologia', nome: 'Histologia e Embriologia'}]}
                                ]
                            },
                            {
                                nome: 'Genética e Evolução',
                                modulos: [
                                    { nome: 'Módulo 1: Genética', assuntos: [{id: 'genetica', nome: 'Genética Mendeliana e Pós-Mendeliana', subconteudos: [{id: 'leis-mendel', nome: 'Leis de Mendel'}, {id: 'heranca-sexual', nome: 'Herança Ligada ao Sexo'}]}]},
                                    { nome: 'Módulo 2: Evolução', assuntos: [{id: 'evolucao', nome: 'Evolução', subconteudos: [{id: 'teorias-evol', nome: 'Teorias Evolutivas'}, {id: 'especiacao', nome: 'Especiação'}]}]},
                                    { nome: 'Módulo 3: Biotecnologia', assuntos: [{id: 'biotecnologia', nome: 'Biotecnologia'}]}
                                ]
                            },
                            {
                                nome: 'Fisiologia e Seres Vivos',
                                modulos: [
                                    { nome: 'Módulo 1: Fisiologia Humana', assuntos: [{id: 'fisiologia-humana', nome: 'Fisiologia Humana', subconteudos: [{id: 'sist-digest', nome: 'Sistema Digestório'}, {id: 'sist-resp', nome: 'Sistema Respiratório'}, {id: 'sist-circ', nome: 'Sistema Circulatório'}, {id: 'sist-nerv-endoc', nome: 'Sistemas Nervoso e Endócrino'}]}]},
                                    { nome: 'Módulo 2: Microbiologia e Parasitologia', assuntos: [{id: 'micro-parasito', nome: 'Microbiologia e Parasitologia'}]},
                                    { nome: 'Módulo 3: Zoologia', assuntos: [{id: 'zoologia', nome: 'Zoologia'}]},
                                    { nome: 'Módulo 4: Botânica', assuntos: [{id: 'botanica', nome: 'Botânica'}]}
                                ]
                            },
                            {
                                nome: 'Ecologia',
                                modulos: [
                                    { nome: 'Módulo 1: Fundamentos da Ecologia', assuntos: [{id: 'fundamentos-ecologia', nome: 'Conceitos e Cadeias Alimentares'}]},
                                    { nome: 'Módulo 2: Populações e Comunidades', assuntos: [{id: 'populacoes-comunidades', nome: 'Dinâmica de Populações e Relações'}]},
                                    { nome: 'Módulo 3: Biomas e Sucessão', assuntos: [{id: 'biomas-sucessao', nome: 'Biomas e Sucessão Ecológica'}]},
                                    { nome: 'Módulo 4: Ecologia Aplicada', assuntos: [{id: 'impactos-ambientais', nome: 'Impactos Ambientais'}]}
                                ]
                            }
                        ]
                    },
                    {
                        id: 'historia',
                        nome: 'História',
                        icone: 'landmark', 
                        cor: 'bg-yellow-50 text-yellow-700 border-yellow-200', 
                        frentes: [
                            {
                                nome: 'História Geral',
                                modulos: [
                                    { nome: 'Módulo 1: Antiguidade e Idade Média', assuntos: [{id: 'antiguidade-media', nome: 'Antiguidade e Idade Média', subconteudos: [{id: 'antiguidade-oriental', nome: 'Antiguidade Oriental'}, {id: 'antiguidade-classica', nome: 'Antiguidade Clássica'}, {id: 'alta-idade-media', nome: 'Alta Idade Média'}, {id: 'baixa-idade-media', nome: 'Baixa Idade Média'}]}]},
                                    { nome: 'Módulo 2: Idade Moderna', assuntos: [{id: 'idade-moderna', nome: 'Idade Moderna', subconteudos: [{id: 'expansao-maritima', nome: 'Expansão Marítima'}, {id: 'renascimento-cultural', nome: 'Renascimento Cultural'}, {id: 'reformas-religiosas', nome: 'Reformas Religiosas'}, {id: 'absolutismo-mercantilismo', nome: 'Absolutismo e Mercantilismo'}, {id: 'iluminismo', nome: 'Iluminismo'}]}]},
                                    { nome: 'Módulo 3: Idade Contemporânea', assuntos: [{id: 'idade-contemporanea', nome: 'Idade Contemporânea', subconteudos: [{id: 'rev-francesa-era-nap', nome: 'Revolução Francesa e Era Napoleônica'}, {id: 'revolucoes-industriais', nome: 'Revoluções Industriais'}, {id: 'imperialismo', nome: 'Imperialismo'}, {id: 'primeira-guerra', nome: 'Primeira Guerra Mundial'}, {id: 'crise-29-totalitarismo', nome: 'Crise de 1929 e Regimes Totalitários'}, {id: 'segunda-guerra', nome: 'Segunda Guerra Mundial'}, {id: 'guerra-fria', nome: 'Guerra Fria'}]}]}
                                ]
                            },
                            {
                                nome: 'História do Brasil',
                                modulos: [
                                    { nome: 'Módulo 1: Brasil Colônia', assuntos: [{id: 'brasil-colonia', nome: 'Brasil Colônia', subconteudos: [{id: 'periodo-pre-colonial', nome: 'Período Pré-Colonial'}, {id: 'administracao-colonial', nome: 'Administração Colonial'}, {id: 'economia-acucareira', nome: 'Economia Açucareira'}, {id: 'mineracao', nome: 'Mineração'}, {id: 'revoltas-coloniais', nome: 'Revoltas Coloniais'}]}]},
                                    { nome: 'Módulo 2: Brasil Império', assuntos: [{id: 'brasil-imperio', nome: 'Brasil Império', subconteudos: [{id: 'processo-independencia', nome: 'Processo de Independência'}, {id: 'primeiro-reinado', nome: 'Primeiro Reinado'}, {id: 'periodo-regencial', nome: 'Período Regencial'}, {id: 'segundo-reinado', nome: 'Segundo Reinado'}, {id: 'crise-imperio', nome: 'Crise do Império'}]}]},
                                    { nome: 'Módulo 3: Brasil República', assuntos: [{id: 'brasil-republica', nome: 'Brasil República', subconteudos: [{id: 'republica-velha', nome: 'República Velha'}, {id: 'era-vargas', nome: 'Era Vargas'}, {id: 'republica-populista', nome: 'República Populista'}, {id: 'ditadura-militar', nome: 'Ditadura Militar'}, {id: 'nova-republica', nome: 'Nova República'}]}]}
                                ]
                            }
                        ]
                    },
                    {
                        id: 'geografia',
                        nome: 'Geografia',
                        icone: 'globe', 
                        cor: 'bg-indigo-50 text-indigo-700 border-indigo-200', 
                        frentes: [
                             {
                                nome: 'Geografia Geral',
                                modulos: [
                                    { 
                                        nome: 'Módulo 1: Introdução e Natureza', 
                                        assuntos: [{
                                            id: 'geografia-fisica-cartografia', nome: 'Geografia Física e Cartografia',
                                            subconteudos: [
                                                { id: 'cartografia', nome: 'Cartografia'},
                                                { id: 'estrutura-geologica', nome: 'Estrutura Geológica e Relevo'},
                                                { id: 'clima-vegetacao', nome: 'Clima e Formações Vegetais'},
                                                { id: 'hidrografia-geral', nome: 'Hidrografia'}
                                            ]
                                        }]
                                    },
                                    { 
                                        nome: 'Módulo 2: População e Urbanização', 
                                        assuntos: [{
                                            id: 'demografia-urbanizacao-mundial', nome: 'Demografia e Urbanização Mundial',
                                            subconteudos: [
                                                { id: 'teorias-demograficas', nome: 'Teorias Demográficas e Indicadores'},
                                                { id: 'migracoes-internacionais', nome: 'Migrações Internacionais'},
                                                { id: 'processo-urbanizacao', nome: 'Processo de Urbanização'},
                                                { id: 'problemas-urbanos-geral', nome: 'Problemas Urbanos'}
                                            ]
                                        }]
                                    },
                                    { 
                                        nome: 'Módulo 3: Economia e Globalização', 
                                        assuntos: [{
                                            id: 'economia-globalizacao', nome: 'Economia, Indústria e Globalização',
                                            subconteudos: [
                                                { id: 'fontes-energia', nome: 'Fontes de Energia e Recursos Minerais'},
                                                { id: 'modelos-producao', nome: 'Modelos de Produção'},
                                                { id: 'globalizacao-blocos', nome: 'Globalização e Blocos Econômicos'},
                                                { id: 'transportes-comercio', nome: 'Transportes e Comércio Mundial'}
                                            ]
                                        }]
                                    },
                                    { 
                                        nome: 'Módulo 4: Geopolítica', 
                                        assuntos: [{
                                            id: 'geopolitica', nome: 'Geopolítica e Conflitos Atuais',
                                            subconteudos: [
                                                { id: 'ordem-mundial', nome: 'Ordem Mundial'},
                                                { id: 'focos-tensao', nome: 'Principais Focos de Tensão'},
                                                { id: 'organismos-internacionais', nome: 'Organismos Internacionais'},
                                                { id: 'nova-ordem-mundial', nome: 'Nova Ordem Mundial e Globalização'}
                                            ]
                                        }]
                                    }
                                ]
                            },
                            {
                                nome: 'Geografia do Brasil',
                                modulos: [
                                    { 
                                        nome: 'Módulo 1: Aspectos Naturais', 
                                        assuntos: [{
                                            id: 'aspectos-naturais-brasil', nome: 'Aspectos Naturais do Brasil',
                                            subconteudos: [
                                                { id: 'relevo-brasil', nome: 'Relevo Brasileiro'},
                                                { id: 'climas-brasil', nome: 'Climas do Brasil'},
                                                { id: 'dominios-morfoclimaticos', nome: 'Domínios Morfoclimáticos e Biomas'},
                                                { id: 'hidrografia-brasil', nome: 'Bacias Hidrográficas Brasileiras'}
                                            ]
                                        }]
                                    },
                                    { 
                                        nome: 'Módulo 2: População e Urbanização', 
                                        assuntos: [{
                                            id: 'populacao-urbanizacao-br', nome: 'População e Urbanização Brasileira',
                                            subconteudos: [
                                                { id: 'formacao-populacao-br', nome: 'Formação da População Brasileira'},
                                                { id: 'dinamica-demografica-br', nome: 'Dinâmica Demográfica'},
                                                { id: 'urbanizacao-metropolizacao-br', nome: 'Urbanização e Metropolização no Brasil'},
                                                { id: 'problemas-urbanos-br', nome: 'Problemas Urbanos Brasileiros'}
                                            ]
                                        }]
                                    },
                                    { 
                                        nome: 'Módulo 3: Economia e Espaço Rural/Industrial', 
                                        assuntos: [{
                                            id: 'economia-brasil', nome: 'Economia, Agricultura e Indústria',
                                            subconteudos: [
                                                { id: 'estrutura-fundiaria-br', nome: 'Estrutura Fundiária e Reforma Agrária'},
                                                { id: 'modernizacao-agricultura-br', nome: 'Modernização da Agricultura'},
                                                { id: 'industrializacao-br', nome: 'Processo de Industrialização Brasileiro'},
                                                { id: 'fontes-energia-br', nome: 'Fontes de Energia no Brasil'}
                                            ]
                                        }]
                                    },
                                    { 
                                        nome: 'Módulo 4: Questões Ambientais e Regionais', 
                                        assuntos: [{
                                            id: 'questoes-ambientais-br', nome: 'Questões Ambientais e Regionais',
                                            subconteudos: [
                                                { id: 'problemas-ambientais-br', nome: 'Principais Problemas Ambientais no Brasil'},
                                                { id: 'politicas-preservacao-br', nome: 'Políticas de Preservação'},
                                                { id: 'divisao-regional-br', nome: 'Divisão Regional'},
                                                { id: 'desigualdades-regionais-br', nome: 'Desigualdades Regionais'}
                                            ]
                                        }]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        id: 'filosofia',
                        nome: 'Filosofia',
                        icone: 'brain-circuit', 
                        cor: 'bg-teal-50 text-teal-700 border-teal-200', 
                        frentes: [
                            {
                                nome: 'Módulos',
                                modulos: [
                                    { nome: 'Módulo 1: Filosofia Antiga e Medieval', assuntos: [{id: 'filosofia-antiga-media', nome: 'Filosofia Antiga e Medieval', subconteudos: [{id: 'pre-socraticos', nome: 'Pré-Socráticos'}, {id: 'socrates-platao-aristoteles', nome: 'Sócrates, Platão e Aristóteles'}, {id: 'helenistica-medieval', nome: 'Filosofia Helenística e Medieval'}]}]},
                                    { nome: 'Módulo 2: Filosofia Moderna e Contemporânea', assuntos: [{id: 'filosofia-moderna-contemporanea', nome: 'Filosofia Moderna e Contemporânea', subconteudos: [{id: 'racionalismo-empirismo', nome: 'Racionalismo e Empirismo'}, {id: 'kant-hegel', nome: 'Kant e Hegel'}, {id: 'existencialismo-pos-modernismo', nome: 'Existencialismo e Pós-Modernismo'}]}]},
                                    { nome: 'Módulo 3: Eixos Temáticos', assuntos: [{id: 'etica-politica-ciencia', nome: 'Ética, Política e Ciência', subconteudos: [{id: 'etica-moral', nome: 'Ética e Moral'}, {id: 'filosofia-politica', nome: 'Filosofia Política'}, {id: 'filosofia-ciencia', nome: 'Filosofia da Ciência'}]}]}
                                ]
                            }
                        ]
                    },
                    {
                        id: 'sociologia',
                        nome: 'Sociologia',
                        icone: 'users', 
                        cor: 'bg-cyan-50 text-cyan-700 border-cyan-200', 
                        frentes: [
                             {
                                nome: 'Módulos',
                                modulos: [
                                    { nome: 'Módulo 1: Conceitos Fundamentais', assuntos: [{id: 'conceitos-sociologicos', nome: 'Cultura, Identidade e Estratificação Social', subconteudos: [{id: 'cultura-ideologia', nome: 'Cultura e Ideologia'}, {id: 'identidade-socializacao', nome: 'Identidade e Socialização'}, {id: 'estratificacao-desigualdade', nome: 'Estratificação e Desigualdade'}]}]},
                                    { nome: 'Módulo 2: Estruturas Sociais', assuntos: [{id: 'estruturas-sociais', nome: 'Trabalho, Política e Movimentos Sociais', subconteudos: [{id: 'sociologia-trabalho', nome: 'Sociologia do Trabalho'}, {id: 'estado-poder-politica', nome: 'Estado, Poder e Política'}, {id: 'movimentos-sociais', nome: 'Movimentos Sociais'}]}]},
                                    { nome: 'Módulo 3: Pensadores da Sociologia', assuntos: [{id: 'pensadores-sociologia', nome: 'Sociologia Clássica e Contemporânea', subconteudos: [{id: 'comte', nome: 'Augusto Comte'}, {id: 'durkheim', nome: 'Émile Durkheim'}, {id: 'weber', nome: 'Max Weber'}, {id: 'marx', nome: 'Karl Marx'}]}]}
                                ]
                            }
                        ]
                    },
                    {
                        id: 'portugues',
                        nome: 'Português',
                        icone: 'book-a', 
                        cor: 'bg-orange-50 text-orange-700 border-orange-200', 
                        frentes: [
                            {
                                nome: 'Gramática',
                                modulos: [
                                     { nome: 'Módulo 1: Morfologia', assuntos: [{id: 'morfologia', nome: 'Morfologia', subconteudos: [{id: 'classes-palavras-variaveis', nome: 'Classes de Palavras Variáveis'}, {id: 'classes-palavras-invariaveis', nome: 'Classes de Palavras Invariáveis'}, {id: 'formacao-palavras', nome: 'Processos de Formação de Palavras'}]}]},
                                     { nome: 'Módulo 2: Sintaxe', assuntos: [{id: 'sintaxe', nome: 'Sintaxe', subconteudos: [{id: 'periodo-simples', nome: 'Período Simples: Termos da Oração'}, {id: 'oracoes-coordenadas', nome: 'Período Composto: Orações Coordenadas'}, {id: 'oracoes-subordinadas-substantivas', nome: 'Orações Subordinadas Substantivas'}, {id: 'oracoes-subordinadas-adjetivas', nome: 'Orações Subordinadas Adjetivas'}, {id: 'oracoes-subordinadas-adverbiais', nome: 'Orações Subordinadas Adverbiais'}]}]},
                                     { nome: 'Módulo 3: Normas e Pontuação', assuntos: [{id: 'concordancia-regencia-crase', nome: 'Concordância, Regência e Crase', subconteudos: [{id: 'concordancia-verbal', nome: 'Concordância Verbal'}, {id: 'concordancia-nominal', nome: 'Concordância Nominal'}, {id: 'regencia-verbal-nominal', nome: 'Regência Verbal e Nominal'}, {id: 'crase', nome: 'Crase'}]}, {id: 'pontuacao', nome: 'Pontuação'}]}
                                ]
                            },
                            {
                                nome: 'Texto e Interpretação',
                                modulos: [
                                    { nome: 'Módulo 1: Fundamentos do Texto', assuntos: [{id: 'coesao-coerencia', nome: 'Coesão e Coerência'}]},
                                    { nome: 'Módulo 2: Análise Textual', assuntos: [{id: 'interpretacao-textos', nome: 'Interpretação e Tipos Textuais', subconteudos: [{id: 'tipologia-textual', nome: 'Tipologia Textual'}, {id: 'generos-textuais', nome: 'Gêneros Textuais'}, {id: 'intertextualidade', nome: 'Intertextualidade'}]}]},
                                    { nome: 'Módulo 3: Recursos Expressivos', assuntos: [{id: 'figuras-variacao-linguistica', nome: 'Figuras e Variação Linguística', subconteudos: [{id: 'figuras-linguagem', nome: 'Figuras de Linguagem'}, {id: 'variacao-linguistica', nome: 'Variação Linguística'}, {id: 'funcoes-linguagem', nome: 'Funções da Linguagem'}]}]}
                                ]
                            }
                        ]
                    },
                    {
                        id: 'literatura',
                        nome: 'Literatura',
                        icone: 'book-open', 
                        cor: 'bg-lime-50 text-lime-700 border-lime-200', 
                        frentes: [
                            {
                                nome: 'Módulos',
                                modulos: [
                                    { nome: 'Módulo 1: Período Colonial', assuntos: [{id: 'literatura-colonial', nome: 'Período Colonial', subconteudos: [{id: 'trovadorismo-classicismo', nome: 'Trovadorismo e Classicismo'}, {id: 'barroco-arcadismo', nome: 'Barroco e Arcadismo'}]}]},
                                    { nome: 'Módulo 2: Século XIX', assuntos: [{id: 'literatura-seculo-xix', nome: 'Século XIX', subconteudos: [{id: 'romantismo', nome: 'Romantismo (Prosa e Poesia)'}, {id: 'realismo-naturalismo', nome: 'Realismo e Naturalismo'}, {id: 'parnasianismo-simbolismo', nome: 'Parnasianismo e Simbolismo'}]}]},
                                    { nome: 'Módulo 3: Século XX e XXI', assuntos: [{id: 'literatura-moderna', nome: 'Século XX e XXI', subconteudos: [{id: 'pre-modernismo', nome: 'Pré-Modernismo'}, {id: 'modernismo-br', nome: 'Modernismo no Brasil'}, {id: 'tendencias-contemp', nome: 'Tendências Contemporâneas'}]}]}
                                ]
                            }
                        ]
                    },
                    {
                        id: 'ingles',
                        nome: 'Inglês',
                        icone: 'languages', 
                        cor: 'bg-pink-50 text-pink-700 border-pink-200', 
                        frentes: [
                            {
                                nome: 'Gramática (Grammar)',
                                modulos: [
                                    {
                                        nome: 'Módulo 1: Tempos Verbais',
                                        assuntos: [
                                            {
                                                id: 'verb-tenses', nome: 'Tempos Verbais',
                                                subconteudos: [
                                                    { id: 'simple-tenses', nome: 'Simple Tenses' },
                                                    { id: 'continuous-tenses', nome: 'Continuous Tenses' },
                                                    { id: 'perfect-tenses', nome: 'Perfect Tenses' },
                                                    { id: 'tenses-comparison', nome: 'Comparativo entre Tempos Verbais' }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        nome: 'Módulo 2: Estrutura da Frase',
                                        assuntos: [
                                            { 
                                                id: 'prepositions-conjunctions', nome: 'Prepositions and Conjunctions',
                                                subconteudos: [
                                                    { id: 'prepositions-time', nome: 'Prepositions of Time' },
                                                    { id: 'prepositions-place', nome: 'Prepositions of Place' },
                                                    { id: 'coordinating-conjunctions', nome: 'Coordinating Conjunctions' },
                                                    { id: 'subordinating-conjunctions', nome: 'Subordinating Conjunctions' }
                                                ]
                                            },
                                            { 
                                                id: 'pronouns-articles', nome: 'Pronouns and Articles',
                                                subconteudos: [
                                                    { id: 'subject-object-pronouns', nome: 'Subject & Object Pronouns' },
                                                    { id: 'possessive-pronouns-adjectives', nome: 'Possessive Pronouns & Adjectives' },
                                                    { id: 'definite-indefinite-articles', nome: 'Definite & Indefinite Articles' }
                                                ]
                                            },
                                            {
                                                id: 'reported-speech', nome: 'Reported Speech',
                                                subconteudos: [
                                                    { id: 'reported-statements', nome: 'Reported Statements' },
                                                    { id: 'reported-questions', nome: 'Reported Questions' },
                                                    { id: 'reporting-verbs', nome: 'Reporting Verbs' },
                                                    { id: 'tense-pronoun-changes', nome: 'Changes in Tense, Pronouns, and Time' }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        nome: 'Módulo 3: Verbos Modais e Condicionais',
                                        assuntos: [
                                            { 
                                                id: 'modal-verbs', nome: 'Modal Verbs',
                                                subconteudos: [
                                                    { id: 'modals-ability', nome: 'Modals of Ability' },
                                                    { id: 'modals-obligation', nome: 'Modals of Obligation' },
                                                    { id: 'modals-possibility', nome: 'Modals of Possibility' }
                                                ]
                                            },
                                            {
                                                id: 'conditionals', nome: 'Conditionals',
                                                subconteudos: [
                                                    { id: 'zero-first-conditional', nome: 'Zero & First Conditional' },
                                                    { id: 'second-conditional', nome: 'Second Conditional' },
                                                    { id: 'third-conditional', nome: 'Third Conditional' }
                                                ]
                                            },
                                            { 
                                                id: 'passive-voice', nome: 'Passive Voice',
                                                subconteudos: [
                                                    { id: 'passive-voice-tenses', nome: 'Passive Voice in Different Tenses' },
                                                    { id: 'passive-with-by', nome: 'Using "by" in the Passive Voice' }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                nome: 'Vocabulário e Interpretação',
                                modulos: [
                                    {
                                        nome: 'Módulo 1: Habilidades de Leitura',
                                        assuntos: [
                                            { 
                                                id: 'skimming-scanning', nome: 'Skimming and Scanning',
                                                subconteudos: [
                                                    { id: 'skimming-techniques', nome: 'Techniques for Skimming' },
                                                    { id: 'scanning-techniques', nome: 'Techniques for Scanning' }
                                                ]
                                            },
                                            { 
                                                id: 'main-idea-inference', nome: 'Main Idea and Inference',
                                                subconteudos: [
                                                    { id: 'identifying-main-idea', nome: 'Identifying the Main Idea' },
                                                    { id: 'making-inferences', nome: 'Making Inferences from Text' }
                                                ]
                                            },
                                            { 
                                                id: 'text-comprehension', nome: 'Interpretação de Textos',
                                                subconteudos: [
                                                    { id: 'understanding-context', nome: 'Understanding Context and Tone' },
                                                    { id: 'identifying-purpose', nome: 'Identifying Author\'s Purpose' }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        nome: 'Módulo 2: Construção de Vocabulário',
                                        assuntos: [
                                            { 
                                                id: 'phrasal-verbs', nome: 'Phrasal Verbs',
                                                subconteudos: [
                                                    { id: 'common-phrasal-verbs', nome: 'Common Phrasal Verbs' },
                                                    { id: 'separable-inseparable', nome: 'Separable vs. Inseparable' }
                                                ]
                                            },
                                            { 
                                                id: 'idioms', nome: 'Idiomatic Expressions',
                                                subconteudos: [
                                                    { id: 'common-idioms', nome: 'Common English Idioms' }
                                                ]
                                            },
                                            { 
                                                id: 'false-cognates', nome: 'False Cognates',
                                                subconteudos: [
                                                    { id: 'common-false-friends', nome: 'Common False Friends' }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        id: 'redacao',
                        nome: 'Redação',
                        icone: 'file-pen-line', 
                        cor: 'bg-rose-50 text-rose-700 border-rose-200', 
                        frentes: [
                            {
                                nome: 'Módulos',
                                modulos: [
                                     { nome: 'Módulo 1: Estrutura e Competências', assuntos: [{id: 'estrutura-dissertativa', nome: 'Estrutura Dissertativo-Argumentativa'}, {id: 'competencias-enem', nome: 'Competências do ENEM'}]}
                                ]
                            }
                        ]
                    }
                ],
                questoes: []
            },
            
            // Novo: Índice para busca
            searchIndex: [],
            currentAssuntos: [], 

            init: function() {
                if (typeof lucide !== 'undefined') lucide.createIcons();
                
                // REMOVIDO: Prompt inicial bloqueante. 
                // Agora o app carrega livremente e só valida autenticação na hora de gerar.

                const savedQ = localStorage.getItem(this.CACHE_PREFIX + 'questoes');
                if (savedQ) {
                    try {
                        this.db.questoes = JSON.parse(savedQ);
                        this.renderQuestoes();
                    } catch(e) { console.error("Cache inválido", e); }
                }

                this.setupNavigation();
                this.setupMobileMenu();
                this.buildSearchIndex();
                this.renderMateriasGrid();
                this.populateFilters();
                this.setupSearch();
            },

            // --- API CORE (Lógica Híbrida Inteligente) ---
            callAPI: async function(prompt, isJson) {
                const requestBody = {
                    model: "gpt-4o-mini", 
                    messages: [{ role: "user", content: prompt }],
                    response_format: isJson ? { type: "json_object" } : undefined,
                    temperature: 0.7
                };

                // 1. TENTATIVA PRINCIPAL: Backend Vercel (Seguro)
                // Tenta conectar na rota que criamos. Se funcionar, não pede chave.
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        const json = await response.json();
                        return json.choices[0].message.content;
                    }
                    // Se der erro (ex: 404 ou 500), o código continua para o bloco abaixo (Fallback)
                    console.warn("Backend Vercel não respondeu. Tentando modo direto...");
                } catch (e) {
                    console.log("Erro de conexão com backend:", e);
                }

                // 2. FALLBACK: Modo Direto (Requer Chave Local)
                // Só chega aqui se o servidor falhar.
                let localKey = localStorage.getItem('insflow_openai_key');

                if (!localKey) {
                    localKey = window.prompt("O servidor de IA não está acessível (provavelmente rodando localmente).\n\nPara continuar, insira sua API Key da OpenAI:");
                    if (localKey) {
                        localStorage.setItem('insflow_openai_key', localKey.trim());
                    } else {
                        throw new Error("Operação cancelada: Chave API necessária para modo local.");
                    }
                }

                try {
                    const response = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${localKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        // Se a chave local for inválida, limpa para pedir de novo
                        if (response.status === 401) localStorage.removeItem('insflow_openai_key');
                        throw new Error(`Erro da API (${response.status}): ${errText}`);
                    }

                    const json = await response.json();
                    return json.choices[0].message.content;

                } catch (e) {
                    console.error("API Error:", e);
                    throw e;
                }
            },

            // --- UI HELPERS ---
            getLoadingSpinner: function(text = "A processar...") {
                return `
                    <div class="flex flex-col items-center justify-center p-6 space-y-3 bg-gray-50 rounded-lg border border-gray-100">
                        <div class="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                        <p class="text-sm text-indigo-600 font-medium animate-pulse">${text}</p>
                    </div>
                `;
            },

            // --- GERAÇÃO DE CONTEÚDO ---
            generateContent: async function(materia, topico, tipo, targetId) {
                const target = document.getElementById(targetId);
                if(!target) return;

                // Usa o novo spinner padronizado
                target.innerHTML = this.getLoadingSpinner("A preparar uma aula incrível...");
                
                // Lógica específica para Sociologia/Humanas
                let diretrizesEspecificas = "";
                if (['Sociologia', 'Filosofia', 'História'].includes(materia)) {
                    diretrizesEspecificas = `
                    **DIRETRIZES OBRIGATÓRIAS PARA SOCIOLOGIA/HUMANAS:**
                    1. **Foco Conceitual:** Explique os conceitos-chave (ex: Fato Social, Ação Social, Mais-Valia) de forma direta e inequívoca.
                    2. **Autores Clássicos:** Sempre vincule o tópico aos seus principais teóricos (ex: Durkheim, Weber, Marx, Bauman) se aplicável, explicando a visão deles.
                    3. **Sem Dispersão:** Não use dados estatísticos aleatórios ou lógica matemática. Foque na análise social, histórica e crítica.
                    4. **Contextualização:** Mostre como esse conceito se aplica na sociedade atual ou no contexto histórico em que surgiu.
                    `;
                }

                const prompt = `
                Aja como um professor de alto desempenho do ENEM, famoso por sua didática impecável e por prender a atenção dos alunos.
                
                Tópico: "${topico}"
                Matéria: "${materia}"
                Formato: ${tipo === 'resumo' ? 'Resumo "Flashcard" (Direto e Visual)' : 'Aula Explicativa Engajadora'}
                
                ${diretrizesEspecificas}

                **DIRETRIZES DE ESTILO (ANTI-TÉDIO):**
                1. **Visual Leve:** Nada de blocos de texto gigantes ("muralhas de texto"). Use parágrafos curtos.
                2. **Estrutura HTML:** - Use <h3> para subtítulos claros.
                   - Use MUITAS listas (<ul><li>) para enumerar características ou passos.
                   - Use <b>negrito</b> para destacar palavras-chave e conceitos.
                   - Use <blockquote> para "Dicas de Ouro" ou curiosidades.
                3. **Conexão Real:** Comece com uma analogia do dia a dia ou uma aplicação prática para gerar interesse imediato.
                4. **Linguagem:** Didática, conversacional e motivadora (ex: "Imagine que...", "O segredo aqui é...").
                5. **Matemática:** Se houver fórmulas, use LaTeX estritamente entre $$.

                Objetivo: Transformar esse conteúdo técnico em algo que o aluno sinta prazer em ler e facilidade em entender, mantendo o rigor conceitual da disciplina.
                `;

                try {
                    let content = await this.callAPI(prompt, false);
                    // Limpeza de Markdown para evitar exibição de ```html
                    content = content.replace(/```html/g, '').replace(/```/g, '');
                    
                    target.innerHTML = content;
                    if(window.renderMathInElement) renderMathInElement(target);
                } catch (e) {
                    target.innerHTML = `<div class="text-red-500 p-2 bg-red-50 rounded text-xs">Falha: ${e.message}</div>`;
                }
            },

            // --- QUESTÕES (LÓGICA DE FILTROS ATUALIZADA) ---
            populateFilters: function() {
                const discSel = document.getElementById('filtro-disciplina');
                const contSel = document.getElementById('filtro-conteudo');
                const subSel = document.getElementById('filtro-subconteudo');
                const btn = document.getElementById('btn-gerar-questoes');

                if(!discSel) return;

                // 1. Popular Disciplinas
                discSel.innerHTML = '<option value="">Selecione a Disciplina</option>' + 
                    this.db.materias.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');

                // Helper para resetar os selects seguintes
                const resetSelect = (el, defaultText) => {
                    el.innerHTML = `<option value="">${defaultText}</option>`;
                    el.disabled = true;
                };

                // 2. Evento: Mudança de Disciplina
                discSel.onchange = () => {
                    const mId = discSel.value;
                    resetSelect(contSel, 'Selecione o Conteúdo');
                    resetSelect(subSel, 'Selecione o Conteúdo primeiro');

                    if (!mId) return;

                    const m = this.db.materias.find(x => x.id === mId);
                    if (m) {
                        const assuntosList = [];
                        m.frentes.forEach(f => {
                            f.modulos.forEach(mod => {
                                mod.assuntos.forEach(a => {
                                    assuntosList.push(a);
                                });
                            });
                        });

                        assuntosList.sort((a, b) => a.nome.localeCompare(b.nome));

                        contSel.innerHTML = '<option value="">Selecione o Conteúdo</option>' + 
                            assuntosList.map(a => `<option value="${a.id}">${a.nome}</option>`).join('');
                        contSel.disabled = false;
                        this.currentAssuntos = assuntosList;
                    }
                };

                // 3. Evento: Mudança de Conteúdo
                contSel.onchange = () => {
                    const aId = contSel.value;
                    resetSelect(subSel, 'Selecione o Sub-conteúdo (Opcional)');

                    if (!aId || !this.currentAssuntos) return;

                    const assunto = this.currentAssuntos.find(a => a.id === aId);
                    
                    if (assunto && assunto.subconteudos && assunto.subconteudos.length > 0) {
                        subSel.innerHTML = '<option value="">Geral / Todos</option>' + 
                            assunto.subconteudos.map(s => `<option value="${s.nome}">${s.nome}</option>`).join('');
                        subSel.disabled = false;
                    } else {
                        subSel.innerHTML = '<option value="">Sem sub-tópicos</option>';
                        subSel.disabled = true;
                    }
                };

                if(btn) btn.onclick = () => this.handleGenerateQuestions();
            },

            handleGenerateQuestions: async function() {
                const discSel = document.getElementById('filtro-disciplina');
                const contSel = document.getElementById('filtro-conteudo');
                const subSel = document.getElementById('filtro-subconteudo');
                const difSel = document.getElementById('filtro-dificuldade'); 
                const searchInput = document.getElementById('search-topic');
                const btn = document.getElementById('btn-gerar-questoes');
                const loadingEl = document.getElementById('loading-indicator');
                const placeholderEl = document.getElementById('questoes-placeholder');

                // 1. Definir Tópico e Contexto
                const searchVal = searchInput.value.trim();
                let topicoPrompt = "";
                let discNome = "Conhecimentos Gerais/ENEM";
                let discId = ""; // Novo: Capturar o ID para saber se é Exatas ou Humanas
                let dificuldade = difSel ? difSel.value : "medio";

                if (searchVal) {
                    topicoPrompt = searchVal;
                } else {
                    if(!discSel.value || !contSel.value) return alert("Por favor, selecione pelo menos a disciplina e o conteúdo, ou digite um assunto na barra de pesquisa.");
                    
                    discId = discSel.value; // Captura o ID (ex: 'sociologia', 'matematica')
                    discNome = discSel.options[discSel.selectedIndex].text;
                    const conteudoNome = contSel.options[contSel.selectedIndex].text;
                    topicoPrompt = conteudoNome;
                    
                    if (subSel && !subSel.disabled && subSel.value) {
                        topicoPrompt = `${conteudoNome}: ${subSel.value}`;
                    }
                }

                // Identificar se é matéria de cálculo
                const isExatas = ['matematica', 'fisica', 'quimica'].includes(discId);

                // UI Loading
                btn.disabled = true;
                btn.innerHTML = `<span class="animate-spin inline-block mr-2">⟳</span> Gerando...`;
                loadingEl.classList.remove('hidden');
                if(placeholderEl) placeholderEl.classList.add('hidden');

                // Config Dificuldade
                let regrasDificuldade = "";
                if (dificuldade === 'facil') {
                    regrasDificuldade = "NÍVEL FÁCIL (Recordar/Entender): Questões de aplicação direta do conceito. Textos curtos e objetivos.";
                } else if (dificuldade === 'dificil') {
                    regrasDificuldade = "NÍVEL DIFÍCIL (Analisar/Avaliar): A dificuldade deve vir da INTERPRETAÇÃO complexa e relação entre conceitos distintos.";
                } else {
                    regrasDificuldade = "NÍVEL MÉDIO (Aplicar/Analisar - Padrão ENEM): Questões contextualizadas clássicas. Equilíbrio entre leitura e resolução.";
                }

                // SELEÇÃO DE PROTOCOLO (A CORREÇÃO PRINCIPAL)
                let protocoloLogico = "";
                
                if (isExatas) {
                    // Protocolo para MATEMÁTICA/FÍSICA/QUÍMICA (Foco em números)
                    protocoloLogico = `
                    PROTOCOLO DE SEGURANÇA (CÁLCULO/EXATAS):
                    1. **RESOLUÇÃO PRIMEIRO:** Resolva matematicamente no campo 'resolucao'.
                    2. **SEM ALUCINAÇÃO:** A alternativa 'true' DEVE ser cópia exata do valor final do cálculo. Se deu 100, a resposta é "100".
                    3. **DISTRATORES:** Crie valores errados plausíveis (erros de sinal, etc), mas diferentes do correto.
                    `;
                } else {
                    // Protocolo para HUMANAS/BIOLÓGICAS/LINGUAGENS (Foco em conceitos)
                    protocoloLogico = `
                    PROTOCOLO DE SEGURANÇA (CONCEITUAL/HUMANAS):
                    1. **FOCO CONCEITUAL:** A questão DEVE cobrar teoria, interpretação de texto, contexto histórico ou análise social.
                    2. **PROIBIDO CÁLCULOS:** NÃO crie questões matemáticas ou de lógica quantitativa se o assunto for Sociologia, História, Geografia ou Linguagens.
                    3. **COERÊNCIA:** A alternativa correta deve ser a única que se alinha perfeitamente com o texto base e o comando.
                    4. **DISTRATORES:** As alternativas erradas devem ser conceitos reais mas aplicados incorretamente, ou interpretações exageradas/reducionistas do texto.
                    `;
                }

                const prompt = `
                Aja como um Elaborador Sênior de Itens do INEP (ENEM).
                Crie 5 questões INÉDITAS de múltipla escolha.
                Tópico: "${topicoPrompt}" (Disciplina: ${discNome}).
                
                CALIBRAGEM PEDAGÓGICA:
                ${regrasDificuldade}

                ${protocoloLogico}

                ESTRUTURA DA QUESTÃO:
                1. Enunciado com Texto Base (Contextualização).
                2. Comando claro.
                3. 5 Alternativas.

                RETORNE APENAS O JSON VÁLIDO (SEM MARKDOWN \`\`\`json ... \`\`\`):
                {
                    "questoes": [
                        {
                            "enunciado": "Texto motivador + Pergunta...",
                            "alternativas": [
                                {"letra": "A", "texto": "...", "correta": false, "justificativa_erro": "..."},
                                {"letra": "B", "texto": "...", "correta": true, "justificativa_erro": "Gabarito."},
                                {"letra": "C", "texto": "...", "correta": false, "justificativa_erro": "..."},
                                {"letra": "D", "texto": "...", "correta": false, "justificativa_erro": "..."},
                                {"letra": "E", "texto": "...", "correta": false, "justificativa_erro": "..."}
                            ],
                            "resolucao": "Explicação detalhada do conceito e por que as outras estão erradas."
                        }
                    ]
                }`;

                try {
                    let jsonString = await this.callAPI(prompt, true);
                    jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();

                    const data = JSON.parse(jsonString);
                    
                    if(!data.questoes || !Array.isArray(data.questoes)) throw new Error("JSON inválido.");

                    const novasQuestoes = data.questoes;
                    const startIndex = this.db.questoes.length;
                    this.db.questoes = [...this.db.questoes, ...novasQuestoes];
                    
                    try { localStorage.setItem(this.CACHE_PREFIX + 'questoes', JSON.stringify(this.db.questoes)); } catch(e){}
                    
                    this.appendQuestoesToDOM(novasQuestoes, startIndex);

                } catch (error) {
                    console.error(error);
                    alert(`Erro: ${error.message}`);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = "Gerar 5 Questões com IA";
                    loadingEl.classList.add('hidden');
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                }
            },

            // --- RENDERIZAÇÃO (APPEND MODE) ---
            appendQuestoesToDOM: function(questoes, startIndex) {
                const list = document.getElementById('questoes-list');
                
                const html = questoes.map((q, i) => {
                    const globalIndex = startIndex + i;
                    return `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6 animate-fade-in">
                        <div class="flex gap-3 mb-4">
                            <span class="bg-indigo-100 text-indigo-700 font-bold px-2 py-1 rounded text-sm h-fit">Q${globalIndex+1}</span>
                            <div class="text-gray-800 font-medium text-lg">${q.enunciado}</div>
                        </div>
                        
                        <div class="space-y-2 pl-0 md:pl-10" id="q-options-${globalIndex}">
                            ${q.alternativas.map((alt, idx) => `
                                <div class="option-item group p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors relative"
                                     onclick="window.app.selectAlternativa(${globalIndex}, ${idx})"
                                     data-idx="${idx}"
                                     data-correct="${alt.correta}">
                                     
                                    <div class="flex gap-3 items-center">
                                        <div class="option-radio w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                            <div class="w-2.5 h-2.5 rounded-full bg-indigo-600 hidden"></div>
                                        </div>
                                        <div class="font-bold text-gray-400 group-hover:text-gray-600">${alt.letra})</div>
                                        <div class="text-gray-700">${alt.texto}</div>
                                    </div>

                                    <div class="feedback hidden mt-2 text-sm p-2 rounded bg-opacity-50">
                                        ${!alt.correta ? (alt.justificativa_erro || 'Incorreto.') : 'Correto!'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="mt-6 pl-0 md:pl-10 flex flex-col gap-4">
                            <button id="btn-responder-${globalIndex}" onclick="window.app.verificarResposta(${globalIndex})" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                                Responder
                            </button>

                            <div id="resolucao-${globalIndex}" class="hidden">
                                <div class="p-3 bg-blue-50 rounded border border-blue-100 text-sm text-gray-700">
                                    <span class="font-bold text-blue-700 block mb-1">Resolução:</span>
                                    ${q.resolucao}
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');

                const loadingEl = document.getElementById('loading-indicator');
                loadingEl.insertAdjacentHTML('beforebegin', html);
                
                if(window.renderMathInElement) renderMathInElement(list);
            },

            renderQuestoes: function() {
                const list = document.getElementById('questoes-list');
                const placeholder = document.getElementById('questoes-placeholder');
                
                if(!this.db.questoes.length) return;
                
                if(placeholder) placeholder.classList.add('hidden');
                
                const staticContent = `
                    <div id="questoes-placeholder" class="hidden text-center text-gray-500 py-12 bg-white rounded-xl border border-dashed border-gray-300">
                        <i data-lucide="book-open" class="mx-auto h-12 w-12 text-gray-400 mb-3"></i>
                        <p>Selecione uma disciplina, use a busca ou cole um texto para começar.</p>
                    </div>
                    <div id="loading-indicator" class="hidden text-center py-8">
                        <div class="inline-block animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-4"></div>
                        <p class="text-gray-500 animate-pulse">Criando questões inéditas estilo ENEM...</p>
                    </div>
                `;
                list.innerHTML = staticContent;
                this.appendQuestoesToDOM(this.db.questoes, 0);
            },

            clearQuestions: function() {
                if(confirm('Deseja apagar todas as questões geradas?')) {
                    this.db.questoes = [];
                    try { localStorage.removeItem(this.CACHE_PREFIX + 'questoes'); } catch(e){}
                    
                    const list = document.getElementById('questoes-list');
                    list.innerHTML = `
                        <div id="questoes-placeholder" class="text-center text-gray-500 py-12 bg-white rounded-xl border border-dashed border-gray-300">
                            <i data-lucide="book-open" class="mx-auto h-12 w-12 text-gray-400 mb-3"></i>
                            <p>Selecione uma disciplina, use a busca ou cole um texto para começar.</p>
                        </div>
                        <div id="loading-indicator" class="hidden text-center py-8">
                            <div class="inline-block animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-4"></div>
                            <p class="text-gray-500 animate-pulse" id="loading-text">Criando questões inéditas estilo ENEM...</p>
                        </div>
                    `;
                }
            },

            selectAlternativa: function(qIndex, altIndex) {
                const btn = document.getElementById(`btn-responder-${qIndex}`);
                if (btn && btn.disabled && btn.classList.contains('bg-gray-400')) return;

                const container = document.getElementById(`q-options-${qIndex}`);
                container.querySelectorAll('.option-item').forEach(el => {
                    el.classList.remove('selected');
                    el.querySelector('.option-radio').classList.remove('border-indigo-600');
                    el.querySelector('.option-radio div').classList.add('hidden');
                });

                const selected = container.querySelector(`.option-item[data-idx="${altIndex}"]`);
                if(selected) {
                    selected.classList.add('selected');
                    selected.querySelector('.option-radio').classList.add('border-indigo-600');
                    selected.querySelector('.option-radio div').classList.remove('hidden');
                }
            },

            verificarResposta: function(qIndex) {
                const container = document.getElementById(`q-options-${qIndex}`);
                const selected = container.querySelector('.option-item.selected');
                if (!selected) return alert("Selecione uma alternativa.");

                const isCorrect = selected.getAttribute('data-correct') === 'true';
                const btn = document.getElementById(`btn-responder-${qIndex}`);
                const resDiv = document.getElementById(`resolucao-${qIndex}`);

                btn.disabled = true;
                btn.classList.add('bg-gray-400');
                btn.textContent = isCorrect ? "Resposta Correta" : "Resposta Incorreta";
                btn.classList.replace('bg-indigo-600', isCorrect ? 'bg-green-600' : 'bg-red-600');
                btn.classList.replace('hover:bg-indigo-700', isCorrect ? 'hover:bg-green-700' : 'hover:bg-red-700');

                container.querySelectorAll('.option-item').forEach(el => {
                    const correctAttr = el.getAttribute('data-correct') === 'true';
                    if (correctAttr) {
                        el.classList.add('correct');
                        el.querySelector('.feedback').classList.remove('hidden');
                        el.querySelector('.feedback').classList.add('text-green-700');
                    }
                    else if (el.classList.contains('selected') && !isCorrect) {
                        el.classList.add('wrong');
                        el.querySelector('.feedback').classList.remove('hidden');
                        el.querySelector('.feedback').classList.add('text-red-700');
                    }
                });

                resDiv.classList.remove('hidden');
            },

            // --- REDAÇÃO ---
            handleRedacao: async function(tipo) {
                const input = document.getElementById('redacao-theme');
                const output = document.getElementById('redacao-output');
                const texto = document.getElementById('redacao-paragraph').value;
                
                output.classList.remove('hidden');
                output.innerHTML = this.getLoadingSpinner("A analisar dados e gerar resposta...");
                
                let prompt = "";
                const tema = input.value;

                if (tipo === 'tema') {
                    prompt = "Gere apenas UM título de tema de redação estilo ENEM sobre um problema social atual no Brasil. Não use aspas.";
                } else if (tipo === 'repertorio') {
                    if(!tema) return alert("Escreva um tema primeiro.");
                    prompt = `Para o tema de redação "${tema}", liste 3 repertórios socioculturais legítimos (Filósofos, Livros ou Fatos Históricos) e explique brevemente como conectar cada um ao tema.`;
                } else if (tipo === 'esboco') {
                    if(!tema) return alert("Escreva um tema primeiro.");
                    prompt = `Crie um projeto de texto estruturado (Tese, Argumento 1, Argumento 2, Proposta de Intervenção) para o tema "${tema}".`;
                } else if (tipo === 'analise') {
                    if(!texto) return alert("Cole um parágrafo primeiro.");
                    prompt = `Analise este parágrafo de redação ENEM com base na norma culta e coesão. Aponte erros e sugira melhorias:\n\n"${texto}"`;
                }

                try {
                    let result = await this.callAPI(prompt, false);
                    result = result.replace(/```html/g, '').replace(/```/g, '');

                    if (tipo === 'tema') {
                        input.value = result.replace(/["\n]/g, '');
                        output.classList.add('hidden');
                    } else {
                        output.innerHTML = result.replace(/\n/g, '<br>');
                    }
                } catch (e) {
                    output.innerHTML = `<span class="text-red-500">Erro: ${e.message}</span>`;
                }
            },

            // --- NAVEGAÇÃO ---
            setupNavigation: function() {
                document.querySelectorAll('.nav-link, [data-target]').forEach(l => {
                    l.onclick = (e) => {
                        const t = l.getAttribute('data-target');
                        if (t) { e.preventDefault(); this.navigateTo(t); }
                    };
                });
            },
            setupMobileMenu: function() {
                const btn = document.getElementById('mobile-menu-btn');
                const menu = document.getElementById('mobile-menu');
                if(btn && menu) btn.onclick = () => menu.classList.toggle('hidden');
            },
            navigateTo: function(id) {
                document.querySelectorAll('.content-section').forEach(el => {
                    el.classList.remove('active');
                    el.style.display = 'none';
                });
                const target = document.getElementById(id);
                if(target) {
                    target.style.display = 'block';
                    setTimeout(() => target.classList.add('active'), 10);
                }
                document.querySelectorAll('.nav-link').forEach(l => {
                    l.classList.toggle('active', l.getAttribute('data-target') === id);
                });
                window.scrollTo(0,0);
            },

            // --- FUNÇÕES DE RENDERIZAÇÃO DE MATÉRIAS ---
            renderMateriasGrid: function() {
                const grid = document.getElementById('materias-grid');
                if(!grid) return;
                
                grid.innerHTML = this.db.materias.map(m => `
                    <div class="subject-card ${m.cor} p-6 rounded-lg shadow-sm border cursor-pointer flex flex-col items-center hover:shadow-md transition hover:-translate-y-1" onclick="window.app.openMateria('${m.id}')">
                        <i data-lucide="${m.icone}" class="h-10 w-10 mb-3"></i>
                        <h3 class="font-bold text-lg">${m.nome}</h3>
                    </div>
                `).join('');
                
                if(typeof lucide !== 'undefined') lucide.createIcons();
            },

            openMateria: function(id) {
                const m = this.db.materias.find(x => x.id === id);
                if (!m) return;
                
                const detail = document.getElementById('materia-detalhe');
                document.getElementById('materias-home').classList.add('hidden');
                detail.classList.remove('hidden');
                
                detail.innerHTML = `
                    <div class="max-w-5xl mx-auto">
                        <button onclick="document.getElementById('materia-detalhe').classList.add('hidden'); document.getElementById('materias-home').classList.remove('hidden');" class="mb-6 text-indigo-600 font-bold flex items-center gap-2 hover:underline">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i> Voltar para Matérias
                        </button>
                        
                        <div class="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
                            <h2 class="text-4xl font-bold text-gray-800">${m.nome}</h2>
                            
                            <!-- BARRA DE PESQUISA DE CONTEÚDOS -->
                            <div class="relative w-full md:w-96">
                                <input type="text" 
                                    class="w-full p-3 pl-10 rounded-lg border border-gray-200 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none transition" 
                                    placeholder="Buscar conteúdo em ${m.nome}..." 
                                    oninput="window.app.filterSubjectContents(this.value)">
                                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                            </div>
                        </div>

                        <div class="space-y-8" id="materia-conteudos-container">
                        ${m.frentes.map(f => `
                            <div class="materia-frente">
                                <h3 class="text-2xl font-bold text-gray-700 border-b pb-2 mb-4">${f.nome}</h3>
                                <div class="grid gap-4">
                                    ${f.modulos.map(mod => `
                                        <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-100 materia-modulo">
                                            <h4 class="font-bold text-lg text-indigo-600 mb-3">${mod.nome}</h4>
                                            <div class="space-y-2">
                                                ${mod.assuntos.map(a => `
                                                    <div class="border-t pt-2 materia-assunto">
                                                        <button class="w-full flex justify-between items-center py-2 hover:text-indigo-600 text-left" 
                                                            onclick="const el = document.getElementById('cont-${a.id}'); el.classList.toggle('hidden');">
                                                            <span class="font-medium">${a.nome}</span>
                                                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                                        </button>
                                                        
                                                        <div id="cont-${a.id}" class="hidden mt-2 pl-4 border-l-2 border-indigo-100 pb-2">
                                                            ${a.subconteudos ? a.subconteudos.map(sub => `
                                                                <div class="mt-2 pl-2 border-l-2 border-gray-100 sub-conteudo-item">
                                                                    <div class="font-medium text-sm text-gray-600 mb-2">${sub.nome}</div>
                                                                    <div class="flex flex-wrap gap-2 mb-3">
                                                                        <button onclick="window.app.generateContent('${m.nome}', '${sub.nome}', 'resumo', 'res-${sub.id}')" class="text-xs font-semibold bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded hover:bg-indigo-100 border border-indigo-100 transition" title="Revisão rápida e tópicos">Resumo</button>
                                                                        <button onclick="window.app.generateContent('${m.nome}', '${sub.nome}', 'explicacao', 'res-${sub.id}')" class="text-xs font-semibold bg-indigo-100 text-indigo-800 px-3 py-1.5 rounded hover:bg-indigo-200 border border-indigo-200 transition" title="Aula didática padrão">Explicação</button>
                                                                        <button onclick="window.app.generateContent('${m.nome}', '${sub.nome}', 'completo', 'res-${sub.id}')" class="text-xs font-semibold bg-indigo-600 text-white px-3 py-1.5 rounded hover:bg-indigo-700 shadow-sm transition" title="Dossiê aprofundado">Explicação Completa</button>
                                                                    </div>
                                                                    <div id="res-${sub.id}" class="text-gray-700 text-sm leading-relaxed prose max-w-none"></div>
                                                                </div>
                                                            `).join('') : `
                                                                <div class="flex flex-wrap gap-2 mb-3">
                                                                    <button onclick="window.app.generateContent('${m.nome}', '${a.nome}', 'resumo', 'res-${a.id}')" class="text-xs font-semibold bg-indigo-50 text-indigo-700 px-3 py-1.5 rounded hover:bg-indigo-100 border border-indigo-100 transition">Resumo</button>
                                                                    <button onclick="window.app.generateContent('${m.nome}', '${a.nome}', 'explicacao', 'res-${a.id}')" class="text-xs font-semibold bg-indigo-100 text-indigo-800 px-3 py-1.5 rounded hover:bg-indigo-200 border border-indigo-200 transition">Explicação</button>
                                                                    <button onclick="window.app.generateContent('${m.nome}', '${a.nome}', 'completo', 'res-${a.id}')" class="text-xs font-semibold bg-indigo-600 text-white px-3 py-1.5 rounded hover:bg-indigo-700 shadow-sm transition">Explicação Completa</button>
                                                                </div>
                                                                <div id="res-${a.id}" class="text-gray-700 text-sm leading-relaxed prose max-w-none"></div>
                                                            `}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        </div>
                    </div>
                `;
                
                if(typeof lucide !== 'undefined') lucide.createIcons();
                window.scrollTo(0,0);
            },

            // ... (filterSubjectContents mantido igual) ...

            // --- GERAÇÃO DE CONTEÚDO ---
            generateContent: async function(materia, topico, tipo, targetId) {
                const target = document.getElementById(targetId);
                if(!target) return;

                let loadingMsg = "A preparar conteúdo...";
                if (tipo === 'resumo') loadingMsg = "Sintetizando pontos-chave...";
                if (tipo === 'explicacao') loadingMsg = "Preparando aula didática...";
                if (tipo === 'completo') loadingMsg = "Elaborando dossiê completo...";

                target.innerHTML = this.getLoadingSpinner(loadingMsg);
                
                // Definição dos Formatos
                let formatoInstrucao = "";
                if (tipo === 'resumo') {
                    formatoInstrucao = `
                    **FORMATO: RESUMO FLASHCARD (Alta Densidade)**
                    - Objetivo: Revisão rápida e memorização.
                    - Estrutura: Use listas com marcadores (bullet points) para quase tudo.
                    - Conteúdo: Apenas definições cruciais, fórmulas essenciais (se houver) e palavras-chave.
                    - Estilo: Direto ao ponto. Sem introduções longas ou histórias. Economize palavras.
                    `;
                } else if (tipo === 'explicacao') {
                    formatoInstrucao = `
                    **FORMATO: AULA DIDÁTICA (Engajadora/Anti-Tédio)**
                    - Objetivo: Entendimento do conceito e motivação.
                    - Estrutura: Introdução com analogia do cotidiano -> Desenvolvimento lógico -> Exemplo prático.
                    - Conteúdo: Explique o "porquê" e o "como".
                    - Estilo: Conversacional, carismático (como um professor youtuber). Use <b>negrito</b> para ênfase.
                    `;
                } else if (tipo === 'completo') {
                    formatoInstrucao = `
                    **FORMATO: DOSSIÊ COMPLETO (Aprofundado)**
                    - Objetivo: Domínio total do assunto para questões difíceis.
                    - Estrutura: Tópicos detalhados, contexto histórico, deduções, nuances e exceções.
                    - Conteúdo: Cubra o tópico de A a Z. Inclua relações interdisciplinares e análise crítica.
                    - Estilo: Acadêmico porém acessível, rigoroso e exaustivo.
                    `;
                }

                // Lógica específica para Sociologia/Humanas (mantida e combinada)
                let diretrizesMateria = "";
                if (['Sociologia', 'Filosofia', 'História'].includes(materia)) {
                    diretrizesMateria = `
                    **DIRETRIZES ESPECÍFICAS (HUMANAS):**
                    1. Foco Conceitual: Defina conceitos (ex: Fato Social) inequivocamente.
                    2. Autores: Cite os teóricos principais e suas obras.
                    3. Contexto: Aplique à realidade social ou histórica. Sem matemática desnecessária.
                    `;
                }

                const prompt = `
                Aja como um professor especialista em ENEM.
                Tópico: "${topico}"
                Matéria: "${materia}"
                
                ${formatoInstrucao}
                
                ${diretrizesMateria}

                **DIRETRIZES GERAIS DE VISUAL:**
                - Use tags HTML para estruturar (<h3>, <ul>, <li>, <b>, <blockquote>).
                - Evite blocos de texto gigantes. Quebre em parágrafos curtos.
                - Se houver fórmulas, use LaTeX estritamente entre $$.

                Gere o conteúdo agora.
                `;

                try {
                    let content = await this.callAPI(prompt, false);
                    content = content.replace(/```html/g, '').replace(/```/g, '');
                    
                    target.innerHTML = content;
                    if(window.renderMathInElement) renderMathInElement(target);
                } catch (e) {
                    target.innerHTML = `<div class="text-red-500 p-2 bg-red-50 rounded text-xs">Falha: ${e.message}</div>`;
                }
            },

            filterSubjectContents: function(term) {
                const t = term.toLowerCase().trim();
                const container = document.getElementById('materia-conteudos-container');
                if (!container) return;

                const frentes = container.querySelectorAll('.materia-frente');

                frentes.forEach(frente => {
                    let frenteVisible = false;
                    const modulos = frente.querySelectorAll('.materia-modulo');

                    modulos.forEach(mod => {
                        let moduloVisible = false;
                        const assuntos = mod.querySelectorAll('.materia-assunto');

                        assuntos.forEach(assunto => {
                            // Verifica o texto do assunto e de seus sub-conteúdos
                            const text = assunto.textContent.toLowerCase();
                            
                            if (text.includes(t)) {
                                assunto.classList.remove('hidden');
                                moduloVisible = true;
                                
                                // Se a busca não for vazia e encontrou match, abre o acordeão para mostrar onde está
                                if (t.length > 0) {
                                    const contentDiv = assunto.querySelector('div[id^="cont-"]');
                                    if (contentDiv) contentDiv.classList.remove('hidden');
                                }
                            } else {
                                assunto.classList.add('hidden');
                            }
                        });

                        if (moduloVisible) {
                            mod.classList.remove('hidden');
                            frenteVisible = true;
                        } else {
                            mod.classList.add('hidden');
                        }
                    });

                    if (frenteVisible) {
                        frente.classList.remove('hidden');
                    } else {
                        frente.classList.add('hidden');
                    }
                });
            },

            // --- FUNCIONALIDADE DE BUSCA (AUTOCOMPLETE) ---
            buildSearchIndex: function() {
                this.searchIndex = [];
                this.db.materias.forEach(m => {
                    m.frentes.forEach(f => {
                        f.modulos.forEach(mod => {
                            mod.assuntos.forEach(a => {
                                // Adicionar Conteúdo Principal
                                this.searchIndex.push({
                                    label: a.nome,
                                    type: 'Conteúdo',
                                    context: m.nome,
                                    data: { materiaId: m.id, conteudoId: a.id, subId: '' }
                                });
                                
                                // Adicionar Sub-conteúdos
                                if (a.subconteudos) {
                                    a.subconteudos.forEach(s => {
                                        this.searchIndex.push({
                                            label: s.nome,
                                            type: 'Sub-conteúdo',
                                            context: `${m.nome} > ${a.nome}`,
                                            data: { materiaId: m.id, conteudoId: a.id, subId: s.nome } // subId usa o nome pois o value do option é o nome
                                        });
                                    });
                                }
                            });
                        });
                    });
                });
            },

            setupSearch: function() {
                const searchInput = document.getElementById('search-topic');
                const resultsContainer = document.getElementById('search-results');
                const clearBtn = document.getElementById('clear-search');

                if (!searchInput) return;

                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase().trim();
                    
                    if (term.length < 2) {
                        resultsContainer.classList.add('hidden');
                        clearBtn.classList.add('hidden');
                        return;
                    }

                    clearBtn.classList.remove('hidden');

                    // Filtrar resultados (Max 10)
                    const matches = this.searchIndex.filter(item => 
                        item.label.toLowerCase().includes(term) || 
                        item.context.toLowerCase().includes(term)
                    ).slice(0, 10);

                    if (matches.length > 0) {
                        resultsContainer.innerHTML = matches.map(item => `
                            <div class="p-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-50 transition-colors flex flex-col" 
                                 onclick='window.app.selectSearchResult(${JSON.stringify(item.data)}, "${item.label}")'>
                                <span class="font-medium text-gray-800">${item.label}</span>
                                <span class="text-xs text-gray-500">${item.type} em ${item.context}</span>
                            </div>
                        `).join('');
                        resultsContainer.classList.remove('hidden');
                    } else {
                        resultsContainer.innerHTML = `<div class="p-3 text-sm text-gray-500 text-center">Nenhum conteúdo encontrado.</div>`;
                        resultsContainer.classList.remove('hidden');
                    }
                });

                // Esconder ao clicar fora
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                        resultsContainer.classList.add('hidden');
                    }
                });

                // Botão Limpar
                clearBtn.onclick = () => {
                    searchInput.value = '';
                    resultsContainer.classList.add('hidden');
                    clearBtn.classList.add('hidden');
                };
            },

            selectSearchResult: function(data, label) {
                // Preencher a barra para feedback visual
                const searchInput = document.getElementById('search-topic');
                const resultsContainer = document.getElementById('search-results');
                searchInput.value = label;
                resultsContainer.classList.add('hidden');

                // Selecionar dropdowns programaticamente
                const discSel = document.getElementById('filtro-disciplina');
                const contSel = document.getElementById('filtro-conteudo');
                const subSel = document.getElementById('filtro-subconteudo');

                // 1. Setar Disciplina e disparar evento para carregar conteúdos
                discSel.value = data.materiaId;
                discSel.dispatchEvent(new Event('change'));

                // 2. Setar Conteúdo (precisa de um pequeno delay ou execução síncrona se populate for rápido)
                // Como populateFilters é síncrono, podemos setar imediatamente
                contSel.value = data.conteudoId;
                contSel.dispatchEvent(new Event('change'));

                // 3. Setar Sub-conteúdo se houver
                if (data.subId) {
                    subSel.value = data.subId;
                } else {
                    subSel.value = "";
                }
                
                // Scroll suave até os filtros para confirmar seleção ao usuário
                discSel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Feedback visual nos dropdowns
                [discSel, contSel, subSel].forEach(el => {
                    el.classList.add('ring-2', 'ring-green-400', 'transition-all');
                    setTimeout(() => el.classList.remove('ring-2', 'ring-green-400'), 1500);
                });
            }
        };

        // Inicialização Global
        window.app = app;
        window.onload = () => app.init();
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if(window.app && window.app.init) window.app.init();
        });
    </script>
</body>
</html>
