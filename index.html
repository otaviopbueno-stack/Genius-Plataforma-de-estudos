<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genius - Plataforma de Estudos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --primary-color: #4338ca;
            --primary-hover: #3730a3;
            --border-color: #e5e7eb;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
        }
        .nav-link {
            position: relative;
            transition: color 0.3s;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            transition: width 0.3s;
        }
        .nav-link.active, .nav-link:hover {
            color: var(--primary-color);
        }
        .nav-link.active::after, .nav-link:hover::after {
            width: 100%;
        }
        .content-section {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }
        .content-section.active {
            display: block;
            opacity: 1;
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }
        .subject-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            will-change: transform;
        }
        .subject-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .progress-bar {
            background-color: var(--border-color);
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        /* Design Temático da Home Revertido */
        .hero-container {
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at 10% 20%, rgb(239, 246, 255) 0%, rgb(255, 255, 255) 90%);
        }
        .hero-container::before {
            content: '';
            position: absolute;
            top: -50px;
            left: -50px;
            width: 200px;
            height: 200px;
            background-color: rgba(67, 56, 202, 0.05);
            border-radius: 50%;
            z-index: 1;
        }
        .hero-container::after {
            content: '';
            position: absolute;
            bottom: -80px;
            right: -80px;
            width: 300px;
            height: 300px;
            background-color: rgba(67, 56, 202, 0.05);
            border-radius: 50%;
            z-index: 1;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Cabeçalho e Navegação -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="#" class="flex items-center space-x-2 text-2xl font-bold text-gray-800" onclick="navigateTo('inicio')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    <span class="text-indigo-600">Genius</span>
                </a>
                <div class="hidden md:flex space-x-8">
                    <a href="#" class="nav-link active" data-target="inicio" onclick="navigateTo('inicio', this)">Início</a>
                    <a href="#" class="nav-link" data-target="materias" onclick="navigateTo('materias', this)">Matérias</a>
                    <a href="#" class="nav-link" data-target="questoes" onclick="navigateTo('questoes', this)">Questões</a>
                    <a href="#" class="nav-link" data-target="sobre" onclick="navigateTo('sobre', this)">Sobre</a>
                    <a href="#" class="nav-link" data-target="contato" onclick="navigateTo('contato', this)">Contato</a>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-600 hover:text-indigo-600 focus:outline-none">
                        <i data-lucide="menu" class="h-6 w-6"></i>
                    </button>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden py-4">
                <a href="#" class="block py-2 px-4 text-sm hover:bg-gray-100 rounded" onclick="navigateTo('inicio', this)">Início</a>
                <a href="#" class="block py-2 px-4 text-sm hover:bg-gray-100 rounded" onclick="navigateTo('materias', this)">Matérias</a>
                <a href="#" class="block py-2 px-4 text-sm hover:bg-gray-100 rounded" onclick="navigateTo('questoes', this)">Questões</a>
                <a href="#" class="block py-2 px-4 text-sm hover:bg-gray-100 rounded" onclick="navigateTo('sobre', this)">Sobre</a>
                <a href="#" class="block py-2 px-4 text-sm hover:bg-gray-100 rounded" onclick="navigateTo('contato', this)">Contato</a>
            </div>
        </nav>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">

        <!-- Seção Início -->
        <section id="inicio" class="content-section">
            <div class="hero-container rounded-xl p-8 md:p-12 min-h-[calc(100vh-8rem)] flex items-center justify-center">
                <div class="relative z-10 text-center max-w-3xl mx-auto">
                    <h1 class="text-4xl md:text-5xl font-bold text-indigo-600 mb-4">Bem-vindo ao Genius!</h1>
                    <p class="text-lg md:text-xl text-gray-600 mb-8">Nossa missão é transformar sua jornada de estudos. Aqui, você não apenas decora, mas compreende profundamente cada conteúdo. Oferecemos ferramentas interativas e explicações em diferentes níveis para que você possa se preparar de forma eficiente e completa para os maiores vestibulares do país.</p>
                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button class="bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300" onclick="navigateTo('materias')">Explore as Matérias</button>
                        <button class="bg-gray-200 text-gray-800 font-semibold py-3 px-8 rounded-lg shadow-lg hover:bg-gray-300 transition duration-300" onclick="navigateTo('questoes')">Pratique com Questões</button>
                    </div>
                </div>
            </div>
        </section>


        <!-- Seção Matérias -->
        <section id="materias" class="content-section">
            <div id="materias-home">
                <h2 class="text-4xl font-bold mb-8 text-center text-gray-800">Matérias</h2>
                <div id="materias-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8">
                    <!-- Cards de matérias serão inseridos aqui pelo JS -->
                </div>
            </div>
            <div id="materia-detalhe" class="hidden">
                <!-- Conteúdo detalhado da matéria será inserido aqui -->
            </div>
        </section>

        <!-- Seção Questões -->
        <section id="questoes" class="content-section">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-4xl font-bold mb-8 text-center text-gray-800">Questões de Vestibular</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Filtros</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="filtro-disciplina" class="block text-sm font-medium text-gray-700">Disciplina</label>
                            <select id="filtro-disciplina" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="filtro-assunto" class="block text-sm font-medium text-gray-700">Assunto</label>
                            <select id="filtro-assunto" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
                        </div>
                         <div>
                            <label for="generate-questions-btn" class="block text-sm font-medium text-gray-700 invisible">Ação</label>
                            <button id="generate-questions-btn" class="mt-1 w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">Gerar Questões</button>
                        </div>
                    </div>
                </div>
                <div id="questoes-list" class="space-y-6">
                     <!-- Mensagem inicial ou questões geradas -->
                </div>
            </div>
        </section>

        <!-- Seção Sobre -->
        <section id="sobre" class="content-section">
             <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-4xl font-bold mb-4 text-center text-indigo-600">Nossa Missão</h2>
                <p class="text-gray-600 text-center leading-relaxed text-lg">
                    Acreditamos que a educação de qualidade é a principal ferramenta de transformação. O Genius nasceu do desejo de criar um ambiente de estudos onde aprender é um ato de descoberta, não de memorização. Nossa missão é facilitar o acesso ao conhecimento profundo e bem estruturado, capacitando cada estudante a não apenas passar no vestibular, mas a construir uma base sólida para o futuro. Queremos ser o seu parceiro na jornada para alcançar o ponto mais alto do seu potencial.
                </p>

                <div class="mt-8 border-t pt-6 text-center">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Gerenciamento de Cache</h3>
                    <p class="text-gray-600 mb-4">Para economizar seu limite de API, as respostas são salvas no seu navegador. Se quiser novas respostas, você pode limpar o cache.</p>
                    <button onclick="clearCache()" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-lg hover:bg-red-700 transition duration-300 flex items-center justify-center gap-2 mx-auto">
                        <i data-lucide="trash-2" class="h-4 w-4"></i> Limpar Cache de Conteúdo
                    </button>
                </div>
            </div>
        </section>

        <!-- Seção Contato -->
        <section id="contato" class="content-section">
            <div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold mb-2 text-center">Fale Conosco</h2>
                <p class="text-center text-gray-500 mb-6">Tem alguma dúvida, sugestão ou feedback? Adoraríamos ouvir você!</p>
                <form onsubmit="event.preventDefault(); alert('Mensagem enviada! (simulação)');">
                    <div class="mb-4">
                        <label for="nome" class="block text-gray-700 font-medium mb-2">Nome</label>
                        <input type="text" id="nome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Seu nome completo" required>
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block text-gray-700 font-medium mb-2">Email</label>
                        <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="seu.email@exemplo.com" required>
                    </div>
                    <div class="mb-6">
                        <label for="mensagem" class="block text-gray-700 font-medium mb-2">Mensagem</label>
                        <textarea id="mensagem" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Escreva sua mensagem aqui..." required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Enviar Mensagem</button>
                </form>
            </div>
        </section>
    </main>
    
    <script>
        // --- CONFIGURAÇÃO DA API ---
        const GEMINI_API_KEY = "AIzaSyDJKF3LyK4AjAgsWWA4bWXxdYxLOguykng";
        const CACHE_PREFIX = 'genius-cache-';

        // --- BANCO DE DADOS ESTRUTURAL ---
        const db = {
            materias: [
                {
                    id: 'matematica',
                    nome: 'Matemática',
                    icone: 'pi',
                    cor: 'bg-red-100 text-red-800',
                    assuntos: [
                        {id: 'operacoes-numericas', nome: 'Operações numéricas', conteudo: {}},{id: 'razoes-proporcoes', nome: 'Razões e proporções', conteudo: {}},{id: 'regra-de-tres', nome: 'Regra de três', conteudo: {}},{id: 'escalas-grandezas', nome: 'Escalas e grandezas', conteudo: {}},{id: 'porcentagem', nome: 'Porcentagem', conteudo: {}},{id: 'juros', nome: 'Juros simples e compostos', conteudo: {}},{id: 'pa-pg', nome: 'PA e PG', conteudo: {}},{id: 'sequencias-numericas', nome: 'Sequências numéricas', conteudo: {}},{id: 'polinomios', nome: 'Polinômios', conteudo: {}},{id: 'equacoes', nome: 'Equações do 1º e 2º grau', conteudo: {}},{id: 'inequacoes', nome: 'Inequações', conteudo: {}},{id: 'sistemas-equacoes', nome: 'Sistemas de equações', conteudo: {}},{id: 'funcao-afim', nome: 'Função afim', conteudo: {}},{id: 'funcao-quadratica', nome: 'Função quadrática', conteudo: {}},{id: 'funcao-modular', nome: 'Função modular', conteudo: {}},{id: 'funcao-exponencial', nome: 'Função exponencial', conteudo: {}},{id: 'funcao-logaritmica', nome: 'Função logarítmica', conteudo: {}},{id: 'funcoes-trigonometricas', nome: 'Funções trigonométricas', conteudo: {}},{id: 'funcao-composta-inversa', nome: 'Função composta e inversa', conteudo: {}},{id: 'matrizes-determinantes', nome: 'Matrizes e determinantes', conteudo: {}},{id: 'numeros-complexos', nome: 'Números complexos', conteudo: {}},{id: 'geometria-plana', nome: 'Geometria plana', conteudo: {}},{id: 'geometria-espacial', nome: 'Geometria espacial', conteudo: {}},{id: 'geometria-analitica', nome: 'Geometria analítica', conteudo: {}},{id: 'trigonometria', nome: 'Trigonometria', conteudo: {}},{id: 'estatistica-descritiva', nome: 'Estatística descritiva', conteudo: {}},{id: 'probabilidade', nome: 'Probabilidade', conteudo: {}},{id: 'analise-combinatoria', nome: 'Análise combinatória', conteudo: {}},{id: 'matematica-financeira', nome: 'Matemática financeira', conteudo: {}},{id: 'raciocinio-logico', nome: 'Raciocínio lógico', conteudo: {}},{id: 'limites', nome: 'Limites', conteudo: {}},{id: 'derivadas', nome: 'Derivadas', conteudo: {}}
                    ]
                },
                { 
                    id: 'fisica', 
                    nome: 'Física', 
                    icone: 'atom',
                    cor: 'bg-blue-100 text-blue-800',
                    assuntos: [
                        {id: 'cinematica', nome: 'Cinemática', conteudo: {}},{id: 'dinamica', nome: 'Dinâmica (Leis de Newton)', conteudo: {}},{id: 'trabalho-energia', nome: 'Trabalho e energia', conteudo: {}},{id: 'potencia', nome: 'Potência', conteudo: {}},{id: 'quantidade-movimento-impulso', nome: 'Quantidade de movimento e impulso', conteudo: {}},{id: 'colisoes', nome: 'Colisões', conteudo: {}},{id: 'gravitacao-universal', nome: 'Gravitação universal', conteudo: {}},{id: 'hidrostatica', nome: 'Hidrostática', conteudo: {}},{id: 'hidrodinamica', nome: 'Hidrodinâmica', conteudo: {}},{id: 'termologia', nome: 'Termologia', conteudo: {}},{id: 'termodinamica', nome: 'Termodinâmica', conteudo: {}},{id: 'optica-geometrica', nome: 'Óptica geométrica', conteudo: {}},{id: 'ondulatoria', nome: 'Ondulatória', conteudo: {}},{id: 'eletrostatica', nome: 'Eletrostática', conteudo: {}},{id: 'eletrodinamica', nome: 'Eletrodinâmica', conteudo: {}},{id: 'magnetismo', nome: 'Magnetismo', conteudo: {}},{id: 'fisica-moderna', nome: 'Física moderna', conteudo: {}}
                    ]
                },
                {
                    id: 'quimica',
                    nome: 'Química',
                    icone: 'flask-conical',
                    cor: 'bg-purple-100 text-purple-800',
                    assuntos: [
                        {id: 'estrutura-atomica', nome: 'Estrutura atômica', conteudo: {}},{id: 'tabela-periodica', nome: 'Tabela periódica', conteudo: {}},{id: 'ligacoes-quimicas', nome: 'Ligações químicas', conteudo: {}},{id: 'geometria-molecular', nome: 'Geometria molecular', conteudo: {}},{id: 'interacoes-intermoleculares', nome: 'Interações intermoleculares', conteudo: {}},{id: 'estequiometria', nome: 'Estequiometria', conteudo: {}},{id: 'solucoes', nome: 'Soluções', conteudo: {}},{id: 'propriedades-coligativas', nome: 'Propriedades coligativas', conteudo: {}},{id: 'termoquimica', nome: 'Termoquímica', conteudo: {}},{id: 'cinetica-quimica', nome: 'Cinética química', conteudo: {}},{id: 'equilibrio-quimico', nome: 'Equilíbrio químico', conteudo: {}},{id: 'equilibrio-ionico', nome: 'Equilíbrio iônico (pH, pOH)', conteudo: {}},{id: 'oxirreducao', nome: 'Oxirredução', conteudo: {}},{id: 'eletroquimica', nome: 'Eletroquímica', conteudo: {}},{id: 'quimica-organica', nome: 'Química orgânica', conteudo: {}},{id: 'isomeria', nome: 'Isomeria plana e espacial', conteudo: {}},{id: 'reacoes-organicas', nome: 'Reações orgânicas', conteudo: {}},{id: 'polimeros', nome: 'Polímeros', conteudo: {}},{id: 'bioquimica-basica', nome: 'Bioquímica básica', conteudo: {}},{id: 'quimica-ambiental', nome: 'Química ambiental', conteudo: {}}
                    ]
                },
                { 
                    id: 'biologia', 
                    nome: 'Biologia', 
                    icone: 'leaf',
                    cor: 'bg-green-100 text-green-800',
                    assuntos: [
                        {id: 'origem-da-vida', nome: 'Origem da vida', conteudo: {}},{id: 'citologia', nome: 'Citologia', conteudo: {}},{id: 'bioquimica', nome: 'Bioquímica', conteudo: {}},{id: 'genetica', nome: 'Genética', conteudo: {}},{id: 'biologia-molecular', nome: 'Biologia molecular', conteudo: {}},{id: 'evolucao', nome: 'Evolução', conteudo: {}},{id: 'zoologia', nome: 'Zoologia', conteudo: {}},{id: 'botanica', nome: 'Botânica', conteudo: {}},{id: 'fisiologia-vegetal', nome: 'Fisiologia vegetal', conteudo: {}},{id: 'ecologia', nome: 'Ecologia', conteudo: {}},{id: 'fisiologia-humana', nome: 'Fisiologia humana', conteudo: {}},{id: 'microbiologia', nome: 'Microbiologia', conteudo: {}},{id: 'parasitologia', nome: 'Parasitologia', conteudo: {}}
                    ]
                },
                {
                    id: 'historia',
                    nome: 'História',
                    icone: 'landmark',
                    cor: 'bg-yellow-100 text-yellow-800',
                    assuntos: [
                        {id: 'antiguidade', nome: 'Antiguidade (Egito, Grécia, Roma)', conteudo: {}},{id: 'idade-media', nome: 'Idade Média', conteudo: {}},{id: 'idade-moderna', nome: 'Idade Moderna', conteudo: {}},{id: 'idade-contemporanea', nome: 'Idade Contemporânea', conteudo: {}},{id: 'seculo-xix', nome: 'Século XIX', conteudo: {}},{id: 'seculo-xx', nome: 'Século XX', conteudo: {}},{id: 'brasil-colonizacao', nome: 'Brasil: Colonização', conteudo: {}},{id: 'brasil-imperio', nome: 'Brasil: Império', conteudo: {}},{id: 'brasil-republica', nome: 'Brasil: República', conteudo: {}}
                    ]
                },
                {
                    id: 'geografia',
                    nome: 'Geografia',
                    icone: 'globe-2',
                    cor: 'bg-indigo-100 text-indigo-800',
                    assuntos: [
                        {id: 'geografia-fisica', nome: 'Geografia física', conteudo: {}},{id: 'cartografia', nome: 'Cartografia', conteudo: {}},{id: 'geopolitica', nome: 'Geopolítica', conteudo: {}},{id: 'populacao', nome: 'População (Demografia)', conteudo: {}},{id: 'industria-economia', nome: 'Indústria e economia global', conteudo: {}},{id: 'agricultura', nome: 'Agricultura', conteudo: {}},{id: 'meio-ambiente', nome: 'Meio ambiente', conteudo: {}},{id: 'geografia-do-brasil', nome: 'Geografia do Brasil', conteudo: {}}
                    ]
                },
                {
                    id: 'filosofia',
                    nome: 'Filosofia',
                    icone: 'brain-circuit',
                    cor: 'bg-teal-100 text-teal-800',
                    assuntos: [
                        {id: 'filosofia-antiga', nome: 'Filosofia antiga', conteudo: {}},{id: 'filosofia-medieval', nome: 'Filosofia medieval', conteudo: {}},{id: 'filosofia-moderna', nome: 'Filosofia moderna', conteudo: {}},{id: 'filosofia-contemporanea', nome: 'Filosofia contemporânea', conteudo: {}},{id: 'etica-politica', nome: 'Ética e política', conteudo: {}},{id: 'conhecimento-ciencia', nome: 'Conhecimento e ciência', conteudo: {}}
                    ]
                },
                {
                    id: 'sociologia',
                    nome: 'Sociologia',
                    icone: 'users',
                    cor: 'bg-cyan-100 text-cyan-800',
                    assuntos: [
                        {id: 'cultura-sociedade', nome: 'Cultura e sociedade', conteudo: {}},{id: 'identidade-etnia-diversidade', nome: 'Identidade, etnia e diversidade', conteudo: {}},{id: 'estratificacao-desigualdades', nome: 'Estratificação social e desigualdades', conteudo: {}},{id: 'trabalho-economia', nome: 'Trabalho e economia', conteudo: {}},{id: 'politica-estado', nome: 'Política e Estado', conteudo: {}},{id: 'movimentos-sociais', nome: 'Movimentos sociais', conteudo: {}},{id: 'globalizacao', nome: 'Globalização', conteudo: {}},{id: 'sociólogos-classicos', nome: 'Sociologia clássica (Marx, Durkheim, Weber)', conteudo: {}},{id: 'sociólogos-contemporaneos', nome: 'Sociologia contemporânea', conteudo: {}}
                    ]
                },
                {
                    id: 'portugues',
                    nome: 'Português',
                    icone: 'spell-check',
                    cor: 'bg-orange-100 text-orange-800',
                    assuntos: [
                        {id: 'interpretacao-textos', nome: 'Interpretação de textos', conteudo: {}},{id: 'figuras-linguagem', nome: 'Figuras de linguagem', conteudo: {}},{id: 'coerencia-coesao', nome: 'Coerência e coesão', conteudo: {}},{id: 'variacao-linguistica', nome: 'Variação linguística', conteudo: {}},{id: 'generos-textuais', nome: 'Gêneros textuais', conteudo: {}},{id: 'gramatica-morfologia', nome: 'Gramática: Morfologia', conteudo: {}},{id: 'gramatica-sintaxe', nome: 'Gramática: Sintaxe', conteudo: {}},{id: 'gramatica-concordancia', nome: 'Gramática: Concordância', conteudo: {}},{id: 'gramatica-regencia-crase', nome: 'Gramática: Regência e Crase', conteudo: {}},{id: 'gramatica-pontuacao', nome: 'Gramática: Pontuação', conteudo: {}}
                    ]
                },
                {
                    id: 'literatura',
                    nome: 'Literatura',
                    icone: 'book-open',
                    cor: 'bg-lime-100 text-lime-800',
                    assuntos: [
                        {id: 'literatura-trovadorismo', nome: 'Trovadorismo', conteudo: {}},{id: 'literatura-classicismo', nome: 'Classicismo', conteudo: {}},{id: 'literatura-barroco', nome: 'Barroco', conteudo: {}},{id: 'literatura-arcadismo', nome: 'Arcadismo', conteudo: {}},{id: 'literatura-romantismo', nome: 'Romantismo', conteudo: {}},{id: 'literatura-realismo-naturalismo', nome: 'Realismo e Naturalismo', conteudo: {}},{id: 'literatura-parnasianismo', nome: 'Parnasianismo', conteudo: {}},{id: 'literatura-simbolismo', nome: 'Simbolismo', conteudo: {}},{id: 'literatura-pre-modernismo', nome: 'Pré-modernismo', conteudo: {}},{id: 'literatura-modernismo', nome: 'Modernismo', conteudo: {}},{id: 'literatura-contemporanea', nome: 'Literatura Contemporânea', conteudo: {}}
                    ]
                },
                {
                    id: 'redacao',
                    nome: 'Redação',
                    icone: 'file-pen-line',
                    cor: 'bg-rose-100 text-rose-800',
                    assuntos: [] // A seção de Redação agora é interativa
                }
            ],
            questoes: [] // Começa vazio, será preenchido pela API
        };
        
        // --- LÓGICA DE CACHE ---
        function getCache(key) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : null;
            } catch (error) {
                console.error("Erro ao ler do cache:", error);
                return null;
            }
        }

        function setCache(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (error) {
                console.error("Erro ao salvar no cache:", error);
            }
        }

        function clearCache() {
            try {
                let keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    if (localStorage.key(i).startsWith(CACHE_PREFIX)) {
                        keysToRemove.push(localStorage.key(i));
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                alert('Cache limpo com sucesso! A página será recarregada.');
                location.reload();
            } catch (error) {
                 alert('Erro ao limpar o cache.');
                 console.error("Erro ao limpar cache:", error);
            }
        }
        
        // --- LÓGICA DA APLICAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const cachedQuestoes = getCache(CACHE_PREFIX + 'questoes');
            if (cachedQuestoes) {
                db.questoes = cachedQuestoes;
            }

            setupNavigation();
            setupMobileMenu();
            renderMateriasGrid();
            
            // Lógica para Questões
            populateFilters();
            addFilterListeners();
            setInitialQuestaoState();
        });

        // --- FUNÇÕES DE CHAMADA DA API GEMINI ---
        async function callGeminiAPI(prompt, isJson = false) {
            if (GEMINI_API_KEY === "SUA_CHAVE_API_AQUI") {
                throw new Error("Chave de API do Gemini não configurada.");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                 ...(isJson && { generationConfig: { responseMimeType: "application/json" } }),
                "safetySettings": [
                    {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                    {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                    {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                    {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
                ]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("Erro na API do Gemini:", errorData);
                throw new Error(`Erro ao gerar conteúdo: ${errorData.error.message}`);
            }

            const data = await response.json();
            if (data.candidates && data.candidates.length > 0) {
                return data.candidates[0].content.parts[0].text;
            } else {
                throw new Error("A resposta da API estava vazia ou foi bloqueada por segurança.");
            }
        }

        async function generateContentWithGemini(prompt) {
             try {
                let text = await callGeminiAPI(prompt, false);
                // Formatação básica
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
                text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');       
                text = text.replace(/\n/g, '<br>');
                                     
                return text;
            } catch (error) {
                console.error("Erro ao gerar conteúdo de matéria:", error);
                return `<strong>Erro ao gerar conteúdo:</strong> ${error.message}. Verifique sua chave de API e a conexão.`;
            }
        }
        
        async function fetchQuestoesFromGemini(materiaNome, assuntoNome) {
            const cacheKey = `${CACHE_PREFIX}questoes-${materiaNome}-${assuntoNome}-${Date.now()}`; // Unique key to not reuse old questions
            
            const prompt = `
                Aja como uma banca examinadora de vestibular de alto nível (ENEM, FUVEST, UNICAMP) com um rigoroso processo de revisão. Sua tarefa é criar 10 questões de múltipla escolha sobre o tópico "${assuntoNome}" da matéria de "${materiaNome}".
                A precisão factual e gramatical é CRÍTICA. Antes de gerar a resposta final, você DEVE revisar internamente cada questão para garantir que:
                1. O enunciado seja claro, preciso e livre de ambiguidades.
                2. Haja apenas UMA alternativa inquestionavelmente correta, baseada em conhecimento acadêmico consolidado.
                3. As alternativas incorretas (distratores) sejam plausíveis, mas comprovadamente erradas.
                4. A resolução explique detalhadamente o raciocínio para a resposta correta, citando os conceitos aplicados.
                5. A justificativa para cada erro seja precisa, didática e aponte o erro conceitual específico na alternativa. Preste atenção especial a nuances da gramática normativa portuguesa em questões dessa matéria.

                Para cada uma das 10 questões, forneça um objeto JSON com a seguinte estrutura:
                - "banca": Uma banca de vestibular brasileira aleatória.
                - "enunciado": O enunciado da questão.
                - "alternativas": Uma lista com exatamente 5 objetos. Cada objeto deve ter:
                    - "texto": O texto da alternativa.
                    - "correta": um booleano (true para a única correta, false para as outras).
                    - "justificativa_erro": Uma string explicando por que a alternativa está errada. Se a alternativa for a correta, esta string deve ser vazia.
                - "resolucao": Uma resolução comentada completa para a questão.

                Retorne a resposta APENAS como um array de objetos JSON, seguindo estritamente este formato, sem nenhum texto ou formatação adicional.
            `;

            try {
                const jsonString = await callGeminiAPI(prompt, true);
                const questoes = JSON.parse(jsonString);
                
                questoes.forEach((q, index) => {
                    q.id = `${materiaNome.replace(/\s/g, '_')}-${assuntoNome.replace(/\s/g, '_')}-${Date.now()}-${index}`;
                });
                return questoes;

            } catch(error) {
                console.error("Falha ao buscar ou parsear questões:", error);
                throw new Error("Não foi possível gerar as questões. A resposta da API pode não estar no formato JSON esperado.");
            }
        }


        function setupNavigation() {
            navigateTo('inicio', document.querySelector('.nav-link[data-target="inicio"]'));
        }
        
        function navigateTo(targetId, clickedLink = null) {
            const currentActive = document.querySelector('.content-section.active');
            const nextActive = document.getElementById(targetId);

            if(currentActive && currentActive.id === targetId) return;

            if (currentActive) {
                currentActive.classList.remove('active');
            }
            
            setTimeout(() => {
                if (currentActive) currentActive.style.display = 'none';
                if (nextActive) {
                    nextActive.style.display = 'block';
                    setTimeout(() => nextActive.classList.add('active'), 10); 
                }
            }, 300);


            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            if (clickedLink) {
                clickedLink.classList.add('active');
            } else {
                const linkToActivate = document.querySelector(`.nav-link[data-target="${targetId}"]`);
                if (linkToActivate) linkToActivate.classList.add('active');
            }
            
            const mobileMenu = document.getElementById('mobile-menu');
            if (!mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
            }

            window.scrollTo(0, 0);
        }

        function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

        // --- LÓGICA PARA MATÉRIAS ---
        function renderMateriasGrid() {
            const grid = document.getElementById('materias-grid');
            grid.innerHTML = db.materias.map(materia => `
                <div class="subject-card ${materia.cor} p-6 rounded-lg shadow-md cursor-pointer flex flex-col items-center text-center" onclick="showMateriaDetalhe('${materia.id}')">
                    <i data-lucide="${materia.icone}" class="h-12 w-12 mb-4"></i>
                    <h3 class="text-xl font-bold">${materia.nome}</h3>
                </div>
            `).join('');
            lucide.createIcons();
        }
        
        function showMateriaDetalhe(materiaId) {
            const materia = db.materias.find(m => m.id === materiaId);
            const detalheDiv = document.getElementById('materia-detalhe');

            if (materiaId === 'redacao') {
                detalheDiv.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <button onclick="showMateriasHome()" class="flex items-center gap-2 mb-6 text-blue-600 hover:underline font-semibold">
                            <i data-lucide="arrow-left" class="h-4 w-4"></i>
                            Voltar para todas as matérias
                        </button>
                        <h2 class="text-3xl font-bold mb-2">Super-assistente de Redação ✨</h2>
                        <p class="text-gray-600 mb-6">Insira um tema e deixe a IA te ajudar a construir uma redação nota 1000!</p>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="mb-4">
                                <label for="redacao-theme" class="block text-gray-700 font-medium mb-2">Tema da Redação</label>
                                <input type="text" id="redacao-theme" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Desafios da segurança hídrica no Brasil">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <button id="btn-repertorio" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center gap-2">
                                    <i data-lucide="brain-circuit"></i> ✨ Gerar Repertório
                                </button>
                                <button id="btn-esboco" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2">
                                <i data-lucide="list-tree"></i> ✨ Esboçar Argumentos
                                </button>
                            </div>

                            <div class="mb-4 border-t pt-6">
                                <label for="redacao-paragraph" class="block text-gray-700 font-medium mb-2">Analise um parágrafo que você escreveu</label>
                                <textarea id="redacao-paragraph" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Cole aqui o seu parágrafo para receber uma análise construtiva..."></textarea>
                                <button id="btn-analise" class="mt-2 w-full bg-purple-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-purple-700 transition duration-300 flex items-center justify-center gap-2">
                                    <i data-lucide="search-check"></i> ✨ Analisar meu Parágrafo
                                </button>
                            </div>

                            <div id="redacao-output" class="mt-6 prose max-w-none min-h-[100px] bg-slate-50 p-4 rounded-lg">
                                <p class="text-slate-500">O resultado da sua solicitação aparecerá aqui.</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('btn-repertorio').addEventListener('click', handleGerarRepertorio);
                document.getElementById('btn-esboco').addEventListener('click', handleEsbocarArgumentos);
                document.getElementById('btn-analise').addEventListener('click', handleAnalisarParagrafo);

            } else {
                 detalheDiv.innerHTML = `
                    <div class="max-w-7xl mx-auto">
                        <button onclick="showMateriasHome()" class="flex items-center gap-2 mb-6 text-blue-600 hover:underline font-semibold">
                            <i data-lucide="arrow-left" class="h-4 w-4"></i>
                            Voltar para todas as matérias
                        </button>
                        <h2 class="text-4xl font-bold mb-2">${materia.nome}</h2>
                        <div class="flex flex-wrap gap-3 mb-8 border-b border-slate-200 pb-6">
                            ${materia.assuntos.map(assunto => `<a href="#assunto-${assunto.id}" onclick="event.preventDefault(); document.getElementById('assunto-${assunto.id}').scrollIntoView({behavior: 'smooth', block: 'center'});" class="bg-slate-200 text-slate-800 px-4 py-2 rounded-full text-sm font-medium hover:bg-blue-600 hover:text-white transition duration-300">${assunto.nome}</a>`).join('')}
                        </div>

                        <div id="assuntos-container" class="space-y-8">
                            ${materia.assuntos.map(assunto => `
                                <div id="assunto-${assunto.id}" class="bg-white p-6 rounded-lg shadow-md scroll-mt-24">
                                    <h3 class="text-2xl font-semibold mb-4">${assunto.nome}</h3>
                                    <div class="flex flex-wrap gap-2 mb-4">
                                        <button class="tab-button px-4 py-2 text-sm font-medium rounded-md bg-slate-200 hover:bg-slate-300 transition" onclick="showConteudo(this, '${materia.id}', '${assunto.id}', 'resumo')">Resumo</button>
                                        <button class="tab-button px-4 py-2 text-sm font-medium rounded-md bg-slate-200 hover:bg-slate-300 transition" onclick="showConteudo(this, '${materia.id}', '${assunto.id}', 'completo')">Explicação Completa</button>
                                        <button class="tab-button px-4 py-2 text-sm font-medium rounded-md bg-slate-200 hover:bg-slate-300 transition" onclick="showConteudo(this, '${materia.id}', '${assunto.id}', 'aprofundado')">Explicação Aprofundada</button>
                                    </div>
                                    <div class="conteudo-display prose max-w-none min-h-[50px] text-slate-600 leading-relaxed transition-all duration-300">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('materias-home').classList.add('hidden');
            detalheDiv.classList.remove('hidden');
            lucide.createIcons();
        }

        function showMateriasHome() {
            document.getElementById('materia-detalhe').classList.add('hidden');
            document.getElementById('materias-home').classList.remove('hidden');
        }

        async function showConteudo(button, materiaId, assuntoId, tipo) {
            const cacheKey = `${CACHE_PREFIX}content-${materiaId}-${assuntoId}-${tipo}`;
            const cachedContent = getCache(cacheKey);

            const materia = db.materias.find(m => m.id === materiaId);
            const assunto = materia.assuntos.find(a => a.id === assuntoId);
            
            const container = button.closest('.bg-white');
            const displayDiv = container.querySelector('.conteudo-display');
            
            container.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            displayDiv.style.opacity = 0;

            setTimeout(async () => {
                if (cachedContent) {
                    displayDiv.innerHTML = cachedContent;
                } else {
                    displayDiv.innerHTML = `<div class="flex items-center justify-center space-x-2"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p>Gerando explicação com IA...</p></div>`;

                    const promptMapping = {
                        resumo: `Gere um resumo objetivo sobre "${assunto.nome}" em português do Brasil, focado em estudantes de vestibular. Use listas com marcadores (bullet points) e destaque os pontos principais.`,
                        completo: `Gere uma explicação completa sobre "${assunto.nome}" em português do Brasil, no nível de exigência dos vestibulares brasileiros (como Enem e Fuvest). Inclua a teoria principal, fórmulas importantes (se aplicável) e exemplos práticos.`,
                        aprofundado: `Gere uma explicação aprofundada e muito extensa sobre "${assunto.nome}" em português do Brasil, como se fosse um capítulo de um livro didático acadêmico. Vá muito além do que é cobrado no vestibular. Aborde a história do conceito, os principais teóricos e suas contribuições, as fórmulas e suas derivações, conexões com outras áreas do conhecimento, aplicações práticas e tecnológicas, e os limites ou paradoxos da teoria.`
                    };
                    const promptText = promptMapping[tipo];
                    
                    const generatedContent = await generateContentWithGemini(promptText);
                    setCache(cacheKey, generatedContent);
                    displayDiv.innerHTML = generatedContent;
                }
                displayDiv.style.opacity = 1;
            }, 200);
        }

        // --- LÓGICA PARA REDAÇÃO ---
        async function handleGerarRepertorio() {
            const theme = document.getElementById('redacao-theme').value;
            const outputDiv = document.getElementById('redacao-output');
            if (!theme) {
                outputDiv.innerHTML = `<p class="text-red-600">Por favor, insira um tema para a redação.</p>`;
                return;
            }
            
            outputDiv.innerHTML = `<div class="flex items-center justify-center space-x-2"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p>Buscando repertório...</p></div>`;
            const cacheKey = `${CACHE_PREFIX}repertorio-${theme.replace(/\s/g, '_')}`;
            const cachedData = getCache(cacheKey);
            if(cachedData) {
                outputDiv.innerHTML = cachedData;
                return;
            }

            const prompt = `Aja como um professor de cursinho especialista em redação para o ENEM. Para o tema "${theme}", gere um repertório sociocultural rico e variado. Organize a resposta em seções claras usando H3 para títulos (###): 'Contexto Histórico', 'Filosofia e Sociologia', 'Livros e Filmes', e 'Dados e Estatísticas'. Para cada item, forneça uma breve explicação de como ele pode ser usado na argumentação. Seja criativo e forneça referências que ajudem o aluno a se destacar.`;
            
            const result = await generateContentWithGemini(prompt);
            setCache(cacheKey, result);
            outputDiv.innerHTML = result;
        }

        async function handleEsbocarArgumentos() {
            const theme = document.getElementById('redacao-theme').value;
            const outputDiv = document.getElementById('redacao-output');
            if (!theme) {
                outputDiv.innerHTML = `<p class="text-red-600">Por favor, insira um tema para a redação.</p>`;
                return;
            }

            outputDiv.innerHTML = `<div class="flex items-center justify-center space-x-2"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div><p>Montando o esboço...</p></div>`;
             const cacheKey = `${CACHE_PREFIX}esboco-${theme.replace(/\s/g, '_')}`;
            const cachedData = getCache(cacheKey);
            if(cachedData) {
                outputDiv.innerHTML = cachedData;
                return;
            }

            const prompt = `Aja como um corretor de redação nota 1000 do ENEM. Para o tema "${theme}", crie um esboço de projeto de texto dissertativo-argumentativo. A estrutura deve ser: 1. Introdução (com tese clara). 2. Desenvolvimento 1 (tópico frasal e argumentos). 3. Desenvolvimento 2 (tópico frasal e argumentos). 4. Conclusão (com uma Proposta de Intervenção completa, detalhando Agente, Ação, Meio/Modo, Finalidade e Detalhamento). Use títulos H3 (###) para cada seção.`;
            
            const result = await generateContentWithGemini(prompt);
            setCache(cacheKey, result);
            outputDiv.innerHTML = result;
        }

        async function handleAnalisarParagrafo() {
            const theme = document.getElementById('redacao-theme').value;
            const paragraph = document.getElementById('redacao-paragraph').value;
            const outputDiv = document.getElementById('redacao-output');

            if (!theme || !paragraph) {
                outputDiv.innerHTML = `<p class="text-red-600">Por favor, insira o tema e o parágrafo que você deseja analisar.</p>`;
                return;
            }

            outputDiv.innerHTML = `<div class="flex items-center justify-center space-x-2"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div><p>Analisando seu parágrafo...</p></div>`;
            const cacheKey = `${CACHE_PREFIX}analise-${theme.replace(/\s/g, '_')}-${paragraph.substring(0, 30)}`;
            const cachedData = getCache(cacheKey);
            if(cachedData) {
                outputDiv.innerHTML = cachedData;
                return;
            }

            const prompt = `Aja como um professor de redação atencioso e construtivo. O tema da redação é "${theme}". Analise o seguinte parágrafo escrito por um aluno: "${paragraph}". Forneça um feedback em tópicos, focando em: 1. Coesão e Coerência. 2. Força da Argumentação. 3. Correção Gramatical. 4. Uso do Repertório. IMPORTANTE: Não reescreva o parágrafo para o aluno. Apenas aponte os pontos fortes e as áreas que podem ser melhoradas, sugerindo o que o aluno deve pensar para aprimorar o texto.`;
            
            const result = await generateContentWithGemini(prompt);
            setCache(cacheKey, result);
            outputDiv.innerHTML = result;
        }


        // --- LÓGICA PARA QUESTÕES ---
        function setInitialQuestaoState() {
            const questoesList = document.getElementById('questoes-list');
            questoesList.innerHTML = `<p class="text-center text-slate-500">Selecione uma disciplina e um assunto para gerar questões.</p>`;
            document.getElementById('generate-questions-btn').disabled = true;
        }

        function populateFilters() {
            const disciplinaSelect = document.getElementById('filtro-disciplina');
            disciplinaSelect.innerHTML = '<option value="todos">Selecione uma Disciplina</option>';
            db.materias.forEach(m => {
                disciplinaSelect.innerHTML += `<option value="${m.id}">${m.nome}</option>`;
            });
        }
        
        function updateAssuntoFilter(disciplinaId) {
            const assuntoSelect = document.getElementById('filtro-assunto');
            assuntoSelect.innerHTML = '<option value="todos">Selecione um Assunto</option>';
            if (disciplinaId !== 'todos') {
                const materia = db.materias.find(m => m.id === disciplinaId);
                if(materia) {
                    materia.assuntos.forEach(a => {
                        assuntoSelect.innerHTML += `<option value="${a.id}">${a.nome}</option>`;
                    });
                }
            }
            renderQuestoes();
        }

        function addFilterListeners() {
            const disciplinaSelect = document.getElementById('filtro-disciplina');
            const assuntoSelect = document.getElementById('filtro-assunto');
            const generateBtn = document.getElementById('generate-questions-btn');

            disciplinaSelect.addEventListener('change', (e) => {
                updateAssuntoFilter(e.target.value);
                checkIfCanGenerate();
            });

            assuntoSelect.addEventListener('change', () => {
                renderQuestoes();
                checkIfCanGenerate();
            });
            
            generateBtn.addEventListener('click', handleGenerateQuestionsClick);
        }

        function checkIfCanGenerate() {
            const disciplina = document.getElementById('filtro-disciplina').value;
            const assunto = document.getElementById('filtro-assunto').value;
            const btn = document.getElementById('generate-questions-btn');
            
            btn.disabled = (disciplina === 'todos' || assunto === 'todos');
            
            const filtered = db.questoes.filter(q => q.disciplina === disciplina && q.assunto === assunto);
            if(filtered.length > 0) {
                 btn.innerHTML = 'Gerar Mais 10 Questões';
            } else {
                 btn.innerHTML = 'Gerar Questões';
            }
        }

        async function handleGenerateQuestionsClick() {
            const disciplinaSelect = document.getElementById('filtro-disciplina');
            const assuntoSelect = document.getElementById('filtro-assunto');
            const btn = document.getElementById('generate-questions-btn');
            const questoesList = document.getElementById('questoes-list');
            
            const disciplinaId = disciplinaSelect.value;
            const assuntoId = assuntoSelect.value;

            const materia = db.materias.find(m => m.id === disciplinaId);
            const assunto = materia.assuntos.find(a => a.id === assuntoId);
            
            btn.disabled = true;
            btn.innerHTML = `<div class="flex items-center justify-center"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div></div>`;

            try {
                const newQuestoes = await fetchQuestoesFromGemini(materia.nome, assunto.nome);
                
                newQuestoes.forEach(q => {
                    q.disciplina = disciplinaId;
                    q.assunto = assuntoId;
                });
                
                db.questoes.push(...newQuestoes);
                setCache(CACHE_PREFIX + 'questoes', db.questoes); // Salva todas as questões no cache
                renderQuestoes();

            } catch (error) {
                if(questoesList.children.length === 0 || questoesList.children[0].tagName === 'P') {
                    questoesList.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                                                  <strong class="font-bold">Erro!</strong>
                                                  <span class="block sm:inline">${error.message}</span>
                                                </div>`;
                } else {
                    alert(`Erro ao gerar mais questões: ${error.message}`);
                }
            } finally {
                checkIfCanGenerate();
            }
        }

        function renderQuestoes() {
            const disciplina = document.getElementById('filtro-disciplina').value;
            const assunto = document.getElementById('filtro-assunto').value;
            const questoesList = document.getElementById('questoes-list');

            const filteredQuestoes = db.questoes.filter(q => {
                return (disciplina === 'todos' || q.disciplina === disciplina) &&
                       (assunto === 'todos' || q.assunto === assunto);
            });
            
            if (filteredQuestoes.length === 0) {
                setInitialQuestaoState();
                 if (disciplina !== 'todos' && assunto !== 'todos') {
                    questoesList.innerHTML = '<p class="text-center text-slate-500">Ainda não há questões para este tópico. Clique em "Gerar Questões" para criá-las.</p>';
                }
                return;
            }

            questoesList.innerHTML = filteredQuestoes.map((q) => `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <p class="text-sm font-semibold text-blue-600 mb-2">${q.banca}</p>
                    <p class="mb-4 text-slate-700">${q.enunciado}</p>
                    <div id="alternativas-${q.id}" class="space-y-3">
                        ${(q.alternativas || []).map((alt, altIndex) => `
                            <div class="alternative-item flex items-start">
                                <button class="eliminate-btn p-1 mr-2 text-slate-400 hover:text-red-500 flex-shrink-0" title="Eliminar alternativa" onclick="this.nextElementSibling.classList.toggle('line-through'); this.nextElementSibling.classList.toggle('opacity-50')">
                                    <i data-lucide="x-circle" class="w-4 h-4"></i>
                                </button>
                                <label class="flex items-start w-full cursor-pointer">
                                    <input type="radio" name="questao-${q.id}" value="${altIndex}" class="mr-3 mt-1 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 flex-shrink-0">
                                    <div class="flex-grow">
                                        <span>${String.fromCharCode(65 + altIndex)}) ${alt.texto}</span>
                                        <div id="incorrect-explanation-${q.id}-${altIndex}" class="hidden mt-2"></div>
                                    </div>
                                 </label>
                            </div>
                        `).join('')}
                    </div>
                    <button class="mt-4 bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 transition" onclick="checkAnswer('${q.id}')">Confirmar Resposta</button>
                    <div id="resultado-${q.id}" class="hidden mt-4 p-4 rounded-md"></div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        const correctMessages = ["Excelente! Você acertou.", "Correto! Ótimo raciocínio.", "Mandou bem! Resposta correta.", "Isso aí! A resposta está correta."];

        function checkAnswer(questaoId) {
            const questao = db.questoes.find(q => q.id === questaoId);
            if (!questao) return;
            
            const selectedRadio = document.querySelector(`input[name="questao-${questaoId}"]:checked`);
            const resultadoDiv = document.getElementById(`resultado-${questao.id}`);
            resultadoDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');

            if (!selectedRadio) {
                resultadoDiv.classList.remove('hidden');
                resultadoDiv.classList.add('bg-yellow-100', 'text-yellow-800');
                resultadoDiv.innerHTML = `<strong>Atenção:</strong> Por favor, selecione uma alternativa.`;
                return;
            }
            
            const selectedIndex = parseInt(selectedRadio.value);
            const isCorrect = questao.alternativas[selectedIndex].correta;
            
            resultadoDiv.classList.remove('hidden');

            if (isCorrect) {
                const randomMessage = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                resultadoDiv.classList.add('bg-green-100', 'text-green-800');
                resultadoDiv.innerHTML = `<strong>${randomMessage}</strong><br><br>${questao.resolucao}`;
            } else {
                resultadoDiv.classList.add('bg-red-100', 'text-red-800');
                const correctAlternativeIndex = questao.alternativas.findIndex(a => a.correta);
                const correctLetter = String.fromCharCode(65 + correctAlternativeIndex);
                resultadoDiv.innerHTML = `<strong>Quase lá!</strong> A resposta correta é a alternativa ${correctLetter}.<br><br><strong>Resolução:</strong><br>${questao.resolucao}`;
            }
            
            // Adiciona botões para explicar alternativas incorretas
            questao.alternativas.forEach((alt, index) => {
                if (!alt.correta) {
                    const altContainer = document.getElementById(`incorrect-explanation-${questao.id}-${index}`);
                    altContainer.innerHTML = `<button class="text-xs text-blue-600 hover:underline font-semibold" onclick="explainIncorrectAlternative(this, '${questao.id}', ${index})">Por que está errada?</button>`;
                    altContainer.classList.remove('hidden');
                }
            });
        }

        function explainIncorrectAlternative(button, questaoId, alternativeIndex) {
            button.disabled = true;
            const explanationDiv = document.getElementById(`incorrect-explanation-${questaoId}-${alternativeIndex}`);
            
            const questao = db.questoes.find(q => q.id === questaoId);
            const alternativa = questao.alternativas[alternativeIndex];

            // Usa a justificativa pré-gerada
            const explanation = alternativa.justificativa_erro || "Não foi possível carregar a justificativa para este erro.";
            
            explanationDiv.innerHTML = `<p class="text-xs text-red-700 mt-1 p-2 bg-red-50 rounded-md border-l-2 border-red-500">${explanation}</p>`;
        }
    </script>

</body>
</html>

