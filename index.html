<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsFlow - Plataforma de Estudos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#4338ca' } } }
        }
    </script>

    <!-- Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Firebase Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Setting up global variables for Firebase and App
        window.firebase = {};
        window.appState = {
            userId: null,
            isAuthReady: false,
            userQuestionsCollection: null,
            allSubjects: [],
            allTopics: {}, // Structure: { discipline: { content: [subcontents] } }
            currentQuestions: [],
            maxRetries: 3 // For API calls
        };

        // Global variables from environment (Must be accessed this way)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-insflow-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Function to initialize Firebase
        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. Cannot initialize.");
                document.getElementById('cloud-status').textContent = 'Erro: Configuração Firebase ausente';
                document.getElementById('cloud-status').classList.replace('bg-gray-200', 'bg-red-500');
                document.getElementById('cloud-status').classList.replace('text-gray-600', 'text-white');
                return;
            }

            setLogLevel('debug'); // Enable debug logging for firestore
            
            const app = initializeApp(firebaseConfig);
            window.firebase.db = getFirestore(app);
            window.firebase.auth = getAuth(app);
            
            const statusEl = document.getElementById('cloud-status');
            statusEl.textContent = 'Autenticando...';

            onAuthStateChanged(window.firebase.auth, async (user) => {
                if (user) {
                    window.appState.userId = user.uid;
                    statusEl.textContent = 'Conectado. UID: ' + user.uid.substring(0, 8) + '...';
                    statusEl.classList.replace('bg-gray-200', 'bg-green-100');
                    statusEl.classList.replace('text-gray-600', 'text-green-800');
                    window.appState.userQuestionsCollection = collection(window.firebase.db, `/artifacts/${appId}/users/${window.appState.userId}/questions`);
                    
                    // Start listeners and data load after successful auth
                    window.appState.isAuthReady = true;
                    window.app.loadData();
                    
                } else {
                    // Sign in
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(window.firebase.auth, initialAuthToken);
                        } else {
                            await signInAnonymously(window.firebase.auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        statusEl.textContent = 'Erro de Autenticação';
                        statusEl.classList.replace('bg-gray-200', 'bg-red-500');
                        statusEl.classList.replace('text-gray-600', 'text-white');
                        window.appState.isAuthReady = true; // Still ready to proceed, just maybe limited access
                    }
                }
            });
        }

        // Expose Firebase functions globally for use in the main script block
        window.firebase.initFirebase = initFirebase;
        window.firebase.firestore = {
            doc, addDoc, setDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, updateDoc
        };
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; }
        .nav-link.active { color: #4338ca; position: relative; }
        .nav-link.active::after { content: ''; position: absolute; width: 100%; height: 2px; bottom: -4px; left: 0; background-color: #4338ca; }
        html.dark .nav-link.active { color: #818cf8; }
        html.dark .nav-link.active::after { background-color: #818cf8; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .option-item.selected { border-color: #4f46e5; background-color: #eef2ff; }
        .option-item.correct { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .option-item.wrong { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .option-item.strikethrough { opacity: 0.6; background-color: #f3f4f6; }
        .option-item.strikethrough .option-text { text-decoration: line-through; color: #9ca3af; }
        html.dark .option-item.strikethrough { opacity: 0.6; background-color: #1f2937; }
        html.dark .option-item.selected { border-color: #818cf8; background-color: rgba(79, 70, 229, 0.2); }
        html.dark .option-item.correct { background-color: rgba(34, 197, 94, 0.2) !important; border-color: #22c55e !important; }
        html.dark .option-item.wrong { background-color: rgba(239, 68, 68, 0.2) !important; border-color: #ef4444 !important; }

        #search-results { max-height: 300px; overflow-y: auto; }

        /* KaTeX fix for dark mode */
        .katex { font-size: 1.1em; }
        html.dark .katex { color: inherit !important; }
        html.dark .katex .base { color: inherit !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- HEADER -->
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50 border-b dark:border-gray-700">
        <nav class="container mx-auto px-4 h-16 flex items-center justify-between">
            <a href="#" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400" onclick="window.app.navigateTo('inicio')">InsFlow</a>
            
            <div class="hidden md:flex items-center space-x-8">
                <a href="#" class="nav-link hover:text-indigo-600 dark:hover:text-indigo-400 transition" data-target="inicio">Início</a>
                <a href="#" class="nav-link hover:text-indigo-600 dark:hover:text-indigo-400 transition" data-target="materias">Matérias</a>
                <a href="#" class="nav-link hover:text-indigo-600 dark:hover:text-indigo-400 transition" data-target="questoes">Questões</a>
                <a href="#" class="nav-link hover:text-indigo-600 dark:hover:text-indigo-400 transition" data-target="redacao">Redação</a>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-600 dark:text-gray-300" onclick="window.app.toggleTheme()" title="Alternar Tema">
                    <i data-lucide="moon" class="block dark:hidden w-5 h-5"></i>
                    <i data-lucide="sun" class="hidden dark:block w-5 h-5"></i>
                </button>
            </div>

            <div class="flex items-center md:hidden gap-4">
                <button id="theme-toggle-mobile" class="text-gray-600 dark:text-gray-300" onclick="window.app.toggleTheme()">
                    <i data-lucide="moon" class="block dark:hidden w-5 h-5"></i>
                    <i data-lucide="sun" class="hidden dark:block w-5 h-5"></i>
                </button>
                <button id="mobile-menu-btn" class="text-gray-600 dark:text-gray-300"><i data-lucide="menu"></i></button>
            </div>
        </nav>
        
        <div id="mobile-menu" class="hidden md:hidden bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-4 space-y-2 shadow-lg">
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-800 dark:text-gray-200" onclick="window.app.navigateTo('inicio')">Início</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="window.app.navigateTo('materias')">Matérias</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-gray-800 dark:text-gray-200" onclick="window.app.navigateTo('questoes')">Questões</a>
            <a href="#" class="block py-2 px-4 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="window.app.navigateTo('redacao')">Redação</a>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto px-4 py-8 md:py-12">
        <section id="inicio" class="content-section active">
            <div class="text-center py-16 md:py-24 bg-gradient-to-b from-indigo-50 to-white dark:from-gray-800 dark:to-gray-900 rounded-2xl shadow-sm border border-indigo-100 dark:border-gray-700 transition-colors duration-300">
                <h1 class="text-4xl md:text-6xl font-bold text-indigo-600 dark:text-indigo-400 mb-6">Bem-vindo ao InsFlow</h1>
                <p class="text-lg md:text-xl text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">Sua plataforma inteligente de estudos.</p>
                <div class="flex justify-center gap-4">
                    <button class="bg-indigo-600 text-white py-3 px-8 rounded-lg shadow hover:bg-indigo-700 font-semibold transition" onclick="window.app.navigateTo('materias')">Explorar Matérias</button>
                    <button class="bg-white dark:bg-gray-700 text-gray-800 dark:text-white border border-gray-200 dark:border-gray-600 py-3 px-8 rounded-lg shadow hover:bg-gray-50 dark:hover:bg-gray-600 font-semibold transition" onclick="window.app.navigateTo('questoes')">Praticar Questões</button>
                </div>
            </div>
        </section>

        <!-- 2. MATÉRIAS (COM BARRA DE PESQUISA) -->
        <section id="materias" class="content-section">
            <div id="materias-home">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">Matérias</h2>
                    
                    <!-- Barra de Pesquisa na Aba Matérias -->
                    <div class="relative w-full md:w-72">
                        <input type="text" id="search-materias" oninput="window.app.filterSubjects(this.value)" class="w-full p-3 pl-10 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none transition bg-white dark:bg-gray-800 dark:text-white dark:placeholder-gray-400 text-sm" placeholder="Filtrar matéria...">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 w-4 h-4"></i>
                    </div>
                </div>

                <div id="materias-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
            </div>
            <div id="materia-detalhe" class="hidden"></div>
        </section>

        <!-- 3. QUESTÕES -->
        <section id="questoes" class="content-section">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-4 text-center text-gray-800 dark:text-white">Gerador de Questões</h2>
                
                <div class="mb-4 flex justify-end">
                    <span id="cloud-status" class="text-xs font-mono bg-gray-200 px-2 py-1 rounded text-gray-600" title="Status da conexão com Firebase Storage">Inicializando...</span>
                </div>

                <!-- BARRA DE PESQUISA INTELIGENTE (Tópicos do Banco de Dados) -->
                <div class="mb-6 relative z-20">
                    <div class="relative">
                        <input type="text" id="search-topic" autocomplete="off" oninput="window.app.searchTopics(this.value)" class="w-full p-4 pl-12 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm focus:ring-2 focus:ring-indigo-500 outline-none transition bg-white dark:bg-gray-800 dark:text-white dark:placeholder-gray-400" placeholder="Pesquise um tópico do banco de dados (ex: Logaritmos)...">
                        <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 w-5 h-5"></i>
                        <button id="clear-search" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hidden" onclick="window.app.clearSearch()">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div id="search-results" class="absolute w-full bg-white dark:bg-gray-800 mt-2 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 hidden overflow-hidden"></div>
                </div>

                <!-- FILTROS -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 mb-8 relative z-10 transition-colors duration-300">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Disciplina</label>
                            <select id="filtro-disciplina" onchange="window.app.handleDisciplineChange(this.value)" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-gray-700 dark:text-white">
                                <option value="">Selecione a Disciplina</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Conteúdo</label>
                            <select id="filtro-conteudo" onchange="window.app.handleContentChange(this.value)" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-gray-700 dark:text-white disabled:opacity-50" disabled>
                                <option value="">Selecione a Disciplina</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sub-conteúdo</label>
                            <select id="filtro-subconteudo" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-gray-700 dark:text-white disabled:opacity-50" disabled>
                                <option value="">Selecione o Conteúdo</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Dificuldade</label>
                            <select id="filtro-dificuldade" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-gray-700 dark:text-white font-medium">
                                <option value="medio" selected>Médio (Padrão ENEM)</option>
                                <option value="facil">Fácil (Conceitual)</option>
                                <option value="dificil">Difícil (Desafiador)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="btn-gerar-questoes" onclick="window.app.generateQuestions()" class="flex-1 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed shadow-md flex items-center justify-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> Gerar 5 Novas Questões
                        </button>
                        <button onclick="window.app.clearQuestions()" class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 font-bold py-3 px-4 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition border border-gray-200 dark:border-gray-600" title="Limpar lista">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div id="questoes-list" class="space-y-6 pb-12">
                    <div id="questoes-placeholder" class="text-center text-gray-500 dark:text-gray-400 py-12 bg-white dark:bg-gray-800 rounded-xl border border-dashed border-gray-300 dark:border-gray-600 transition-colors duration-300">
                        <i data-lucide="book-open" class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500 mb-3"></i>
                        <p>Selecione uma disciplina ou pesquise um tópico para começar.</p>
                    </div>
                </div>
                
                <div id="loading-indicator" class="hidden text-center py-8">
                    <div class="inline-block animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-4"></div>
                    <p class="text-gray-500 dark:text-gray-400 animate-pulse" id="loading-text">Criando questões inéditas...</p>
                </div>
            </div>
        </section>

        <!-- 4. REDAÇÃO -->
        <section id="redacao" class="content-section">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-6 text-center text-gray-800 dark:text-white">Assistente de Redação</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 transition-colors duration-300">
                    <div class="mb-6">
                        <label for="redacao-theme" class="block text-gray-700 dark:text-gray-300 font-bold mb-2">Tema da Redação</label>
                        <div class="flex gap-2">
                            <input type="text" id="redacao-theme" class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-gray-700 dark:text-white" placeholder="Ex: Desafios da Educação à Distância no Brasil">
                            <button id="btn-suggest-theme" onclick="window.app.suggestTheme()" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 p-3 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition font-medium">
                                <i data-lucide="shuffle" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label for="redacao-text" class="block text-gray-700 dark:text-gray-300 font-bold mb-2">Sua Redação</label>
                        <textarea id="redacao-text" rows="10" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white dark:bg-gray-700 dark:text-white" placeholder="Cole ou escreva aqui a sua redação para análise."></textarea>
                    </div>

                    <button id="btn-analisar-redacao" onclick="window.app.analyzeEssay()" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed shadow-md flex items-center justify-center gap-2">
                        <i data-lucide="file-text" class="w-5 h-5"></i> Analisar Redação
                    </button>
                </div>
                
                <div id="redacao-analysis-container" class="mt-8 hidden">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Resultado da Análise</h3>
                    <div id="redacao-analysis-content" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 prose dark:prose-invert max-w-none">
                        <!-- Conteúdo da análise gerado aqui -->
                    </div>
                </div>
                
                <div id="redacao-loading-indicator" class="hidden text-center py-8">
                    <div class="inline-block animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-4"></div>
                    <p class="text-gray-500 dark:text-gray-400 animate-pulse">Analisando e atribuindo notas...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER -->
    <footer class="border-t dark:border-gray-700 mt-12 py-6 text-center text-gray-500 dark:text-gray-400">
        <p>&copy; 2025 InsFlow. Plataforma de Estudos Inteligente.</p>
    </footer>


    <script>
        // =======================================================
        // DADOS SIMULADOS (PARA CARREGAMENTO INICIAL)
        // =======================================================
        const SUBJECT_DATA = {
            'Matemática': {
                icon: 'calculator', color: 'indigo',
                contents: {
                    'Álgebra': ['Equações de 2º Grau', 'Funções Afins', 'Logaritmos', 'Progressão Aritmética'],
                    'Geometria': ['Áreas de Figuras Planas', 'Geometria Espacial', 'Geometria Analítica'],
                    'Estatística': ['Média, Mediana e Moda', 'Probabilidade']
                }
            },
            'Física': {
                icon: 'zap', color: 'red',
                contents: {
                    'Mecânica': ['Cinemática', 'Dinâmica', 'Trabalho e Energia'],
                    'Eletricidade': ['Circuitos Elétricos', 'Eletrostática']
                }
            },
            'Química': {
                icon: 'flask-conical', color: 'green',
                contents: {
                    'Química Geral': ['Ligações Químicas', 'Estequiometria'],
                    'Química Orgânica': ['Hidrocarbonetos', 'Funções Orgânicas']
                }
            },
            'Biologia': {
                icon: 'leaf', color: 'emerald',
                contents: {
                    'Citologia': ['Membrana Plasmática', 'Organelas'],
                    'Genética': ['Leis de Mendel', 'Cruzamentos']
                }
            },
            'História': {
                icon: 'landmark', color: 'amber',
                contents: {
                    'História do Brasil': ['Era Vargas', 'Ditadura Militar'],
                    'História Geral': ['Revolução Francesa', 'Guerra Fria']
                }
            },
            // NOVO CONTEÚDO ADICIONADO AQUI
            'Inglês': {
                icon: 'message-square', color: 'blue',
                contents: {
                    'Compreensão': ['Reading Comprehension'],
                    'Gramática I': ['Past Simple x Present Perfect', 'Indefinite Pronouns', 'Articles'],
                    'Gramática II': ['Zero, First, Second e Third Conditionals', 'Relative Clauses', 'Reported Speech', 'Passive Voice']
                }
            }
        };


        // =======================================================
        // LÓGICA DO APLICATIVO (window.app)
        // =======================================================
        window.app = {
            
            // --- 1. FUNÇÕES DE UTILIDADE E UI ---

            // Alterna entre tema claro/escuro
            toggleTheme: function() {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                // Redraw icons
                lucide.createIcons();
            },

            // Navegação entre seções
            navigateTo: function(targetId) {
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                document.getElementById(targetId).style.display = 'block';
                document.getElementById(targetId).classList.add('active');

                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('data-target') === targetId) {
                        link.classList.add('active');
                    }
                });
                
                // Close mobile menu if open
                document.getElementById('mobile-menu').classList.add('hidden');

                // Run KaTeX rendering after navigation, especially for the active section
                this.renderMath();
            },

            // Render KaTeX math equations
            renderMath: function(element = document.body) {
                if (typeof renderMathInElement !== 'undefined') {
                    renderMathInElement(element, {
                        delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "$", right: "$", display: false},
                            {left: "\\(", right: "\\)", display: false},
                            {left: "\\[", right: "\\]", display: true}
                        ],
                        throwOnError: false
                    });
                }
            },

            // Display custom modal/message box (instead of alert)
            showMessage: function(title, message, type = 'info') {
                console.log(`[${type.toUpperCase()}] ${title}: ${message}`);
                // In a real app, this would show a custom, styled modal
                // For this environment, we rely on console or a simple UI notification
                alert(`${title}\n\n${message}`);
            },

            // --- 2. GESTÃO DE DADOS (CARREGAMENTO, FILTROS) ---
            
            // Carrega dados iniciais e listeners
            loadData: function() {
                this.processSubjectData();
                this.renderSubjectsGrid();
                this.populateQuestionFilters();
                this.startQuestionsListener();
            },

            // Processa SUBJECT_DATA para popular o estado global de tópicos
            processSubjectData: function() {
                window.appState.allSubjects = Object.keys(SUBJECT_DATA);
                window.appState.allTopics = SUBJECT_DATA;
            },

            // Preenche os <select> de filtros de questões
            populateQuestionFilters: function() {
                const disciplinaSelect = document.getElementById('filtro-disciplina');
                disciplinaSelect.innerHTML = '<option value="">Selecione a Disciplina</option>';
                window.appState.allSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    disciplinaSelect.appendChild(option);
                });
            },

            // Atualiza filtros de Conteúdo e Sub-conteúdo
            handleDisciplineChange: function(discipline) {
                const contentSelect = document.getElementById('filtro-conteudo');
                const subcontentSelect = document.getElementById('filtro-subconteudo');
                
                // Reset sub-content
                subcontentSelect.innerHTML = '<option value="">Selecione o Conteúdo</option>';
                subcontentSelect.disabled = true;

                if (!discipline) {
                    contentSelect.innerHTML = '<option value="">Selecione a Disciplina</option>';
                    contentSelect.disabled = true;
                    return;
                }

                contentSelect.innerHTML = '<option value="">Todos os Conteúdos</option>';
                const contents = window.appState.allTopics[discipline].contents;
                Object.keys(contents).forEach(content => {
                    const option = document.createElement('option');
                    option.value = content;
                    option.textContent = content;
                    contentSelect.appendChild(option);
                });
                contentSelect.disabled = false;
                // Force content change if needed
                this.handleContentChange(contentSelect.value);
            },

            handleContentChange: function(content) {
                const discipline = document.getElementById('filtro-disciplina').value;
                const subcontentSelect = document.getElementById('filtro-subconteudo');
                
                subcontentSelect.innerHTML = '<option value="">Todos os Sub-conteúdos</option>';
                subcontentSelect.disabled = true;

                if (!discipline || !content || !window.appState.allTopics[discipline].contents[content]) {
                    return;
                }

                const subcontents = window.appState.allTopics[discipline].contents[content];
                subcontents.forEach(subcontent => {
                    const option = document.createElement('option');
                    option.value = subcontent;
                    option.textContent = subcontent;
                    subcontentSelect.appendChild(option);
                });
                subcontentSelect.disabled = false;
            },

            // --- 3. FUNCIONALIDADES DA SEÇÃO MATÉRIAS ---

            // Renderiza o grid de matérias
            renderSubjectsGrid: function(filter = '') {
                const grid = document.getElementById('materias-grid');
                grid.innerHTML = '';
                const normalizedFilter = filter.toLowerCase().trim();

                Object.entries(SUBJECT_DATA).forEach(([subject, data]) => {
                    if (normalizedFilter && !subject.toLowerCase().includes(normalizedFilter)) {
                        return; // Skip if filter doesn't match
                    }

                    const totalTopics = Object.values(data.contents).flat().length;
                    const cardHtml = `
                        <div onclick="window.app.viewSubject('${subject}')" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 hover:shadow-xl transform hover:scale-[1.02] transition duration-300 cursor-pointer text-center">
                            <div class="w-12 h-12 flex items-center justify-center rounded-full bg-${data.color}-100 dark:bg-${data.color}-900/50 text-${data.color}-600 dark:text-${data.color}-400 mx-auto mb-3">
                                <i data-lucide="${data.icon}" class="w-6 h-6"></i>
                            </div>
                            <h3 class="text-lg font-semibold dark:text-white">${subject}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${totalTopics} tópicos</p>
                        </div>
                    `;
                    grid.insertAdjacentHTML('beforeend', cardHtml);
                });

                if (grid.innerHTML === '') {
                    grid.innerHTML = '<p class="col-span-full text-center text-gray-500 dark:text-gray-400 py-8">Nenhuma matéria encontrada com este filtro.</p>';
                }

                lucide.createIcons(); // Re-render icons after adding new HTML
            },

            // Filtra as matérias ao digitar
            filterSubjects: function(value) {
                this.renderSubjectsGrid(value);
            },
            
            // Visualiza os detalhes de uma matéria (simulado)
            viewSubject: function(subjectName) {
                const detailDiv = document.getElementById('materia-detalhe');
                const homeDiv = document.getElementById('materias-home');
                const data = SUBJECT_DATA[subjectName];

                if (!data) return;

                let contentHtml = '';
                Object.entries(data.contents).forEach(([content, subcontents]) => {
                    contentHtml += `
                        <div class="mb-6 p-4 rounded-lg bg-gray-50 dark:bg-gray-700 border dark:border-gray-600">
                            <h4 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-3 border-b pb-2 border-gray-200 dark:border-gray-600">${content}</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                ${subcontents.map(sub => `
                                    <div onclick="window.app.selectTopic('${subjectName}', '${content}', '${sub}')" class="flex items-center p-3 rounded-lg bg-white dark:bg-gray-800 shadow-sm hover:bg-${data.color}-50 dark:hover:bg-${data.color}-900/20 transition cursor-pointer border border-gray-100 dark:border-gray-700">
                                        <i data-lucide="check-circle" class="w-5 h-5 mr-3 text-${data.color}-500 dark:text-${data.color}-400"></i>
                                        <span class="text-sm font-medium">${sub}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                detailDiv.innerHTML = `
                    <button onclick="window.app.closeSubjectView()" class="flex items-center text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 mb-6 font-medium transition">
                        <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i> Voltar para Matérias
                    </button>
                    <h2 class="text-4xl font-bold mb-4 text-gray-800 dark:text-white">${subjectName}</h2>
                    <p class="text-lg text-gray-600 dark:text-gray-300 mb-8">Selecione um tópico para praticar questões diretamente.</p>
                    ${contentHtml}
                `;

                homeDiv.classList.add('hidden');
                detailDiv.classList.remove('hidden');
                lucide.createIcons();
            },

            // Fecha a visualização de detalhes
            closeSubjectView: function() {
                document.getElementById('materia-detalhe').classList.add('hidden');
                document.getElementById('materias-home').classList.remove('hidden');
            },

            // Seleciona tópico na tela de Matérias e navega para Questões
            selectTopic: function(discipline, content, subcontent) {
                this.navigateTo('questoes');
                
                // Atualiza os filtros
                const discSelect = document.getElementById('filtro-disciplina');
                discSelect.value = discipline;
                this.handleDisciplineChange(discipline);

                const contSelect = document.getElementById('filtro-conteudo');
                contSelect.value = content;
                this.handleContentChange(content);

                const subcontSelect = document.getElementById('filtro-subconteudo');
                subcontSelect.value = subcontent;
                
                // Força a geração de questões para o novo tópico
                this.generateQuestions();
            },

            // --- 4. FUNCIONALIDADES DA SEÇÃO QUESTÕES ---

            // Search Bar (Tópicos do Banco de Dados)
            searchTopics: function(query) {
                const resultsDiv = document.getElementById('search-results');
                const clearBtn = document.getElementById('clear-search');
                const normalizedQuery = query.toLowerCase().trim();

                resultsDiv.innerHTML = '';

                if (normalizedQuery.length < 2) {
                    resultsDiv.classList.add('hidden');
                    clearBtn.classList.add('hidden');
                    return;
                }

                clearBtn.classList.remove('hidden');
                resultsDiv.classList.remove('hidden');

                let foundTopics = [];
                
                // Iterate over all topics to find matches
                Object.entries(window.appState.allTopics).forEach(([discipline, data]) => {
                    Object.entries(data.contents).forEach(([content, subcontents]) => {
                        // Check content title
                        if (content.toLowerCase().includes(normalizedQuery)) {
                            foundTopics.push({ discipline, content, subcontent: null, label: `${content} (${discipline})` });
                        }

                        // Check subcontents
                        subcontents.forEach(subcontent => {
                            if (subcontent.toLowerCase().includes(normalizedQuery)) {
                                foundTopics.push({ discipline, content, subcontent, label: `${subcontent} (${discipline} - ${content})` });
                            }
                        });
                    });
                });

                // Remove duplicates based on full topic path
                const uniqueTopics = Array.from(new Map(foundTopics.map(item => [item.label, item])).values());
                
                if (uniqueTopics.length === 0) {
                    resultsDiv.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-gray-400">Nenhum tópico encontrado.</div>';
                    return;
                }

                uniqueTopics.slice(0, 10).forEach(topic => {
                    const itemHtml = `
                        <div onclick="window.app.selectSearchedTopic('${topic.discipline}', '${topic.content}', '${topic.subcontent || ''}')" class="p-3 hover:bg-indigo-50 dark:hover:bg-gray-700 cursor-pointer border-b dark:border-gray-700 last:border-b-0">
                            <p class="text-sm font-medium dark:text-white">${topic.label}</p>
                        </div>
                    `;
                    resultsDiv.insertAdjacentHTML('beforeend', itemHtml);
                });
            },

            // Seleciona tópico da busca e atualiza filtros
            selectSearchedTopic: function(discipline, content, subcontent) {
                const searchInput = document.getElementById('search-topic');
                const resultsDiv = document.getElementById('search-results');

                // Update filters
                const discSelect = document.getElementById('filtro-disciplina');
                discSelect.value = discipline;
                this.handleDisciplineChange(discipline);

                const contSelect = document.getElementById('filtro-conteudo');
                contSelect.value = content;
                this.handleContentChange(content);

                const subcontSelect = document.getElementById('filtro-subconteudo');
                subcontSelect.value = subcontent;

                // Update search input text to reflect selection
                searchInput.value = subcontent || content;
                resultsDiv.classList.add('hidden');
                document.getElementById('clear-search').classList.remove('hidden');

                // Generate questions for the selected topic
                this.generateQuestions();
            },

            // Limpa a busca de tópicos
            clearSearch: function() {
                document.getElementById('search-topic').value = '';
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('clear-search').classList.add('hidden');
            },

            // Envia a requisição para gerar questões (Gemini API)
            generateQuestions: async function() {
                const discipline = document.getElementById('filtro-disciplina').value;
                const content = document.getElementById('filtro-conteudo').value;
                const subcontent = document.getElementById('filtro-subconteudo').value;
                const difficulty = document.getElementById('filtro-dificuldade').value;

                if (!discipline) {
                    this.showMessage("Atenção", "Por favor, selecione uma Disciplina para gerar questões.", "warning");
                    return;
                }

                this.setLoadingState(true, "Criando questões inéditas...");

                const topicString = subcontent || content || discipline;
                const userPrompt = `Gere exatamente 5 questões de múltipla escolha no formato ENEM (enunciado, comando, e 5 opções A, B, C, D, E). O nível de dificuldade deve ser "${difficulty}". O tópico principal é: ${topicString} da disciplina ${discipline}. A resposta deve ser EXATAMENTE um JSON, onde a raiz é um ARRAY contendo 5 OBJETOS Question.`;

                const systemPrompt = "Você é um gerador de questões para vestibulares, focado em alta qualidade e rigor acadêmico. As questões devem ser inéditas. As equações matemáticas devem ser formatadas em KaTeX (usando $ para inline e $$ para display). Seu output DEVE ser APENAS o JSON no formato solicitado.";

                const schema = {
                    type: "ARRAY",
                    description: "Lista de 5 questões.",
                    items: {
                        type: "OBJECT",
                        properties: {
                            id: { type: "STRING", description: "ID único gerado aleatoriamente para a questão." },
                            enunciado: { type: "STRING", description: "O texto base da questão, incluindo o comando." },
                            options: {
                                type: "ARRAY",
                                description: "Array com 5 opções de resposta (A, B, C, D, E).",
                                items: { type: "STRING" }
                            },
                            answerIndex: { type: "INTEGER", description: "O índice da resposta correta (0 para A, 1 para B, etc.)." },
                            resolution: { type: "STRING", description: "Explicação detalhada da resolução e por que as outras opções estão erradas. Deve usar KaTeX para fórmulas." },
                            topic: { type: "STRING", description: "Tópico/assunto da questão." },
                        },
                        required: ["id", "enunciado", "options", "answerIndex", "resolution", "topic"],
                        propertyOrdering: ["id", "enunciado", "options", "answerIndex", "resolution", "topic"]
                    }
                };

                try {
                    const rawJson = await this.callGeminiAPI(questionPayload, "Generating questions", window.appState.maxRetries);
                    const newQuestions = JSON.parse(rawJson).map(q => ({
                        ...q,
                        // Add metadata for Firestore/UI
                        selectedOption: null,
                        isResolved: false,
                        discipline,
                        createdAt: new Date().toISOString()
                    }));

                    await this.saveQuestionsToFirestore(newQuestions);
                    this.showMessage("Sucesso", `${newQuestions.length} questões sobre ${topicString} geradas com sucesso!`, "success");

                } catch (error) {
                    console.error("Erro na geração de questões:", error);
                    this.showMessage("Erro de Geração", `Não foi possível gerar as questões. Detalhes: ${error.message}`, "error");
                } finally {
                    // GARANTE QUE O SPINNER SEMPRE PARE
                    this.setLoadingState(false);
                }
            },

            // Função genérica para chamar a API Gemini (com retries)
            callGeminiAPI: async function(payload, loadingText = "Processando...", maxRetries = 3) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    this.setLoadingState(true, `${loadingText} (Tentativa ${attempt + 1}/${maxRetries})`);
                    
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errorBody = await response.text();
                            throw new Error(`API returned status ${response.status}: ${errorBody}`);
                        }

                        const result = await response.json();
                        const contentPart = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (contentPart) {
                            return contentPart;
                        } else {
                            throw new Error("Resposta da API vazia ou inesperada.");
                        }

                    } catch (error) {
                        console.error(`Tentativa ${attempt + 1} falhou.`, error);
                        if (attempt === maxRetries - 1) {
                            throw new Error("Falha ao gerar conteúdo após todas as tentativas.");
                        }
                        // Exponential backoff delay
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                    }
                }
                return null; // Should be unreachable
            },

            // Salva novas questões no Firestore
            saveQuestionsToFirestore: async function(questions) {
                if (!window.appState.isAuthReady || !window.appState.userQuestionsCollection) {
                    console.warn("Firestore not ready. Cannot save questions.");
                    return;
                }
                
                for (const q of questions) {
                    try {
                        // Use the `id` provided by the model as the document ID
                        const qDocRef = window.firebase.firestore.doc(window.appState.userQuestionsCollection, q.id);
                        await window.firebase.firestore.setDoc(qDocRef, q);
                    } catch (e) {
                        console.error("Error adding document: ", e);
                    }
                }
            },

            // Inicia o listener de questões do Firestore
            startQuestionsListener: function() {
                if (!window.appState.isAuthReady || !window.appState.userQuestionsCollection) {
                    // Listener will be started when auth is ready in initFirebase
                    return;
                }

                const q = window.firebase.firestore.query(window.appState.userQuestionsCollection);
                
                window.firebase.firestore.onSnapshot(q, (snapshot) => {
                    const questions = [];
                    snapshot.forEach(doc => {
                        questions.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort by creation date descending
                    questions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    window.appState.currentQuestions = questions;
                    this.renderQuestionsList();
                }, (error) => {
                    console.error("Erro no listener do Firestore: ", error);
                });
            },

            // Renderiza a lista de questões
            renderQuestionsList: function() {
                const listContainer = document.getElementById('questoes-list');
                const placeholder = document.getElementById('questoes-placeholder');

                if (window.appState.currentQuestions.length === 0) {
                    placeholder.classList.remove('hidden');
                    listContainer.innerHTML = '';
                    return;
                }

                placeholder.classList.add('hidden');
                listContainer.innerHTML = '';
                
                window.appState.currentQuestions.forEach((q, index) => {
                    const optionsHtml = q.options.map((optionText, optionIndex) => {
                        const optionLetter = String.fromCharCode(65 + optionIndex); // A, B, C...
                        let classes = 'option-item p-4 rounded-lg border-2 border-gray-200 dark:border-gray-700 transition duration-200 cursor-pointer flex items-start gap-3';
                        let icon = 'circle';

                        if (q.isResolved) {
                            if (optionIndex === q.answerIndex) {
                                classes += ' correct';
                                icon = 'check-circle';
                            } else if (optionIndex === q.selectedOption) {
                                classes += ' wrong strikethrough';
                                icon = 'x-circle';
                            } else {
                                classes += ' strikethrough';
                                icon = 'circle';
                            }
                        } else if (optionIndex === q.selectedOption) {
                            classes += ' selected';
                            icon = 'check-circle';
                        }

                        return `
                            <div class="${classes}" onclick="window.app.selectOption('${q.id}', ${optionIndex})">
                                <span class="text-lg font-bold w-6 h-6 flex-shrink-0 flex items-center justify-center rounded-full border dark:border-gray-600">${optionLetter}</span>
                                <span class="option-text flex-1">${optionText}</span>
                            </div>
                        `;
                    }).join('');

                    const resolutionHtml = q.isResolved ? `
                        <div class="mt-6 p-4 rounded-xl bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 transition duration-300">
                            <h4 class="text-xl font-bold text-indigo-700 dark:text-indigo-300 mb-2 flex items-center gap-2">
                                <i data-lucide="lightbulb" class="w-5 h-5"></i> Resolução Comentada
                            </h4>
                            <div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300">
                                ${q.resolution}
                            </div>
                        </div>
                    ` : '';

                    const questionCard = `
                        <div id="question-${q.id}" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 transition-colors duration-300">
                            <div class="flex justify-between items-start mb-4 border-b pb-3 dark:border-gray-700">
                                <h3 class="text-xl font-bold text-indigo-600 dark:text-indigo-400">Questão ${window.appState.currentQuestions.length - index}</h3>
                                <span class="text-sm font-medium text-gray-500 dark:text-gray-400 px-3 py-1 rounded-full bg-gray-100 dark:bg-gray-700">${q.discipline} / ${q.topic}</span>
                            </div>
                            
                            <div class="prose dark:prose-invert max-w-none mb-6">
                                ${q.enunciado}
                            </div>
                            
                            <div class="options-container space-y-3">
                                ${optionsHtml}
                            </div>
                            
                            <div class="mt-6 flex gap-3">
                                <button onclick="window.app.resolveQuestion('${q.id}')" ${q.isResolved ? 'disabled' : ''} class="flex-1 py-2 px-4 rounded-lg font-semibold transition shadow-md ${q.isResolved ? 'bg-green-600 text-white disabled:opacity-70' : 'bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-gray-400'}" ${q.isResolved ? 'title="Questão Resolvida"' : ''}>
                                    ${q.isResolved ? '<i data-lucide="check" class="w-5 h-5 mr-1 inline"></i> Respondida' : 'Verificar Resposta'}
                                </button>
                                <button onclick="window.app.deleteQuestion('${q.id}')" class="py-2 px-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-red-100 dark:hover:bg-red-900/30 transition border border-gray-200 dark:border-gray-600">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                            
                            ${resolutionHtml}
                        </div>
                    `;
                    listContainer.insertAdjacentHTML('beforeend', questionCard);
                });

                lucide.createIcons();
                this.renderMath(listContainer);
            },

            // Seleciona uma opção de resposta (atualiza Firestore)
            selectOption: async function(questionId, selectedOption) {
                const question = window.appState.currentQuestions.find(q => q.id === questionId);
                if (!question || question.isResolved) return;

                const newSelectedOption = question.selectedOption === selectedOption ? null : selectedOption;
                
                if (!window.appState.userQuestionsCollection) return;
                const docRef = window.firebase.firestore.doc(window.appState.userQuestionsCollection, questionId);
                try {
                    await window.firebase.firestore.updateDoc(docRef, { selectedOption: newSelectedOption });
                } catch (e) {
                    console.error("Error updating selected option: ", e);
                }
            },

            // Resolve a questão (mostra a resposta e a resolução)
            resolveQuestion: async function(questionId) {
                const question = window.appState.currentQuestions.find(q => q.id === questionId);
                if (!question || question.isResolved) return;

                if (question.selectedOption === null) {
                    this.showMessage("Atenção", "Por favor, selecione uma opção antes de verificar a resposta.", "info");
                    return;
                }

                const isCorrect = question.selectedOption === question.answerIndex;
                const message = isCorrect ? "Parabéns! Resposta correta." : "Ops! Resposta incorreta. Verifique a resolução abaixo.";
                this.showMessage(isCorrect ? "Correto" : "Incorreto", message, isCorrect ? "success" : "warning");

                // Update Firestore to mark as resolved
                if (!window.appState.userQuestionsCollection) return;
                const docRef = window.firebase.firestore.doc(window.appState.userQuestionsCollection, questionId);
                try {
                    await window.firebase.firestore.updateDoc(docRef, { isResolved: true });
                } catch (e) {
                    console.error("Error resolving question: ", e);
                }
            },

            // Exclui uma questão do Firestore
            deleteQuestion: async function(questionId) {
                if (!window.appState.userQuestionsCollection) return;
                const docRef = window.firebase.firestore.doc(window.appState.userQuestionsCollection, questionId);
                try {
                    await window.firebase.firestore.deleteDoc(docRef);
                    this.showMessage("Removida", "Questão excluída com sucesso.", "info");
                } catch (e) {
                    console.error("Error deleting question: ", e);
                    this.showMessage("Erro", "Falha ao excluir a questão.", "error");
                }
            },

            // Limpa todas as questões do Firestore
            clearQuestions: async function() {
                if (window.appState.currentQuestions.length === 0) {
                    this.showMessage("Atenção", "A lista de questões já está vazia.", "info");
                    return;
                }

                this.setLoadingState(true, "Limpando questões...");
               
                try {
                    if (!window.appState.userQuestionsCollection) throw new Error("Coleção do Firestore não inicializada. Tente novamente após o status 'Conectado'.");
                    
                    const deletePromises = window.appState.currentQuestions.map(q => {
                        const docRef = window.firebase.firestore.doc(window.appState.userQuestionsCollection, q.id);
                        return window.firebase.firestore.deleteDoc(docRef);
                    });

                    await Promise.all(deletePromises);
                    this.showMessage("Sucesso", "Todas as questões foram removidas.", "success");
                } catch (e) {
                    console.error("Erro ao limpar questões:", e);
                    this.showMessage("Erro de Limpeza", `Não foi possível remover todas as questões. Motivo: ${e.message}. Verifique o status da conexão.`, "error");
                } finally {
                    // GARANTE QUE O SPINNER SEMPRE PARE
                    this.setLoadingState(false);
                }
            },

            // --- 5. FUNCIONALIDADES DA SEÇÃO REDAÇÃO ---

            // Sugere um tema de redação (Gemini API)
            suggestTheme: async function() {
                const themeInput = document.getElementById('redacao-theme');
                const systemPrompt = "Você é um especialista em temas de redação para o ENEM. Gere APENAS um tema de alta relevância social e cultural, sem explicação ou frases adicionais.";
                const userQuery = "Sugira um tema de redação moderno e complexo no formato ENEM (A persistência do/da...).";
                
                document.getElementById('btn-suggest-theme').disabled = true;
                themeInput.placeholder = "Gerando tema...";

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    tools: [{ "google_search": {} }] // Use grounding for up-to-date topics
                };
                
                try {
                    const resultText = await this.callGeminiAPI(payload, "Buscando temas relevantes", 2);
                    themeInput.value = resultText.trim().replace(/^['"]|['"]$/g, ''); // Clean quotes
                } catch (error) {
                    themeInput.value = "Os desafios da cidadania digital no contexto brasileiro.";
                    console.error("Erro ao sugerir tema:", error);
                    this.showMessage("Erro", "Não foi possível gerar um tema. Usando um tema padrão.", "error");
                } finally {
                    document.getElementById('btn-suggest-theme').disabled = false;
                    themeInput.placeholder = "Ex: Desafios da Educação à Distância no Brasil";
                }
            },

            // Analisa a redação do usuário (Gemini API)
            analyzeEssay: async function() {
                const theme = document.getElementById('redacao-theme').value.trim();
                const essayText = document.getElementById('redacao-text').value.trim();
                const analysisContainer = document.getElementById('redacao-analysis-container');
                const analysisContent = document.getElementById('redacao-analysis-content');

                if (!essayText) {
                    this.showMessage("Atenção", "O campo da redação está vazio. Por favor, cole seu texto para análise.", "warning");
                    return;
                }

                analysisContainer.classList.add('hidden');
                document.getElementById('redacao-loading-indicator').classList.remove('hidden');
                document.getElementById('btn-analisar-redacao').disabled = true;

                const systemPrompt = `Você é um corretor de redações no padrão ENEM, focado em fornecer feedback construtivo e notas objetivas. Sua resposta deve ser formatada estritamente em Markdown. Não use KaTeX nesta análise. A estrutura da análise deve ser: 
1. **Nota Final (0 a 1000)**: Atribua uma nota final.
2. **Análise por Competência (C1 a C5)**: Atribua uma nota para cada uma das 5 competências do ENEM (C1: Norma Culta, C2: Compreensão do Tema e Tese, C3: Argumentação e Informações, C4: Mecanismos Linguísticos, C5: Proposta de Intervenção).
3. **Feedback Detalhado**: Forneça um parágrafo por competência (C1 a C5) explicando os pontos fortes e o que precisa ser melhorado.
4. **Sugestão de Aprimoramento**: Um parágrafo final sugerindo a ação mais importante que o aluno deve tomar para melhorar a nota.`;

                const userQuery = `Analise a seguinte redação no padrão ENEM. O tema é: "${theme}". Redação: "${essayText}"`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                try {
                    const resultMarkdown = await this.callGeminiAPI(payload, "Corrigindo sua redação", window.appState.maxRetries);
                    analysisContent.innerHTML = resultMarkdown; // Markdown will be rendered by the browser's prose style
                    analysisContainer.classList.remove('hidden');
                } catch (error) {
                    analysisContent.innerHTML = `<p class="text-red-500">Ocorreu um erro ao processar a análise: ${error.message}</p>`;
                    analysisContainer.classList.remove('hidden');
                    console.error("Erro na análise de redação:", error);
                } finally {
                    document.getElementById('redacao-loading-indicator').classList.add('hidden');
                    document.getElementById('btn-analisar-redacao').disabled = false;
                    window.app.renderMath(analysisContent); // Render math if any escaped LaTeX exists
                }
            },

            // --- 6. FUNÇÕES DE ESTADO GERAL ---

            // Controla o estado de loading e botões
            setLoadingState: function(isLoading, message = "Carregando...") {
                const loadingEl = document.getElementById('loading-indicator');
                const loadingTextEl = document.getElementById('loading-text');
                const generateBtn = document.getElementById('btn-gerar-questoes');

                if (isLoading) {
                    loadingEl.classList.remove('hidden');
                    loadingTextEl.textContent = message;
                    generateBtn.disabled = true;
                } else {
                    loadingEl.classList.add('hidden');
                    generateBtn.disabled = false;
                }
            }
        };


        // =======================================================
        // INICIALIZAÇÃO E EVENT LISTENERS
        // =======================================================
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Apply saved theme
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            // 2. Create Lucide Icons
            lucide.createIcons();

            // 3. Initial navigation setup (ensure 'Início' is active)
            window.app.navigateTo('inicio');

            // 4. Mobile Menu Toggle
            document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });

            // 5. Init Firebase and load data
            if (window.firebase && window.firebase.initFirebase) {
                window.firebase.initFirebase();
            } else {
                console.error("Firebase init function not loaded.");
                window.app.loadData(); // Load dummy data even without Firebase
            }

            // 6. Initial render for Matérias tab
            window.app.renderSubjectsGrid();
        });

    </script>
</body>
</html>
